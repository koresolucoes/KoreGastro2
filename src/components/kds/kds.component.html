

<div class="h-full flex flex-col no-print">
  @if (stations().length === 0) {
    <div class="m-auto text-center bg-gray-800 p-8 rounded-lg">
      <h1 class="text-2xl font-bold text-white mb-4">Nenhuma Estação de Produção Encontrada</h1>
      <p class="text-gray-400">Para usar o KDS, primeiro você precisa cadastrar as estações (ex: Cozinha, Bar).</p>
      <p class="text-gray-500 text-sm mt-2">Vá para Configurações para adicionar uma estação.</p>
    </div>
  } @else {
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-4 gap-4">
      <div class="flex-1">
        <h1 class="text-2xl font-bold text-white">Kitchen Display System (KDS)</h1>
        @if(viewMode() === 'station') {
          <div class="flex items-center gap-2 mt-2 text-sm">
            <span class="text-gray-400">Responsável:</span>
            @if (selectedStation()?.employees; as employee) {
              <span class="font-semibold text-white bg-gray-700 px-2 py-1 rounded-md">{{ employee.name }}</span>
            } @else {
              <span class="text-gray-500 italic">Ninguém</span>
            }
            <button (click)="isAssignEmployeeModalOpen.set(true)" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white" title="Atribuir responsável">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
            </button>
          </div>
        }
      </div>
      <div class="flex items-center flex-wrap gap-4">
        <!-- Sound Toggle -->
        <button (click)="soundNotificationService.toggleMute()" class="p-2 rounded-lg text-white transition-colors" [class.bg-red-600]="soundNotificationService.isMuted()" [class.hover:bg-red-500]="soundNotificationService.isMuted()" [class.bg-gray-700]="!soundNotificationService.isMuted()" [class.hover:bg-gray-600]="!soundNotificationService.isMuted()" [title]="soundNotificationService.isMuted() ? 'Ativar Som' : 'Silenciar'">
          @if (soundNotificationService.isMuted()) {
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75L19.5 12m0 0l2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-6l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg>
          } @else {
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg>
          }
        </button>

        <!-- View Mode Toggle -->
        <div class="flex gap-1 bg-gray-900/50 p-1 rounded-lg">
          <button (click)="setViewMode('station')" class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors" [class.bg-blue-600]="viewMode() === 'station'" [class.text-white]="viewMode() === 'station'">Estação</button>
          <button (click)="setViewMode('expo')" class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors" [class.bg-blue-600]="viewMode() === 'expo'" [class.text-white]="viewMode() === 'expo'">Expo</button>
        </div>

        <!-- Station Selector for Station View -->
        @if(viewMode() === 'station') {
          <div class="flex flex-wrap gap-1 bg-gray-700 p-1 rounded-lg">
            @for (station of stations(); track station.id) {
              <button (click)="selectStation(station)" class="px-4 py-2 text-sm font-medium rounded-md transition-colors" [class.bg-blue-600]="selectedStation()?.id === station.id" [class.text-white]="selectedStation()?.id === station.id" [class.text-gray-300]="selectedStation()?.id !== station.id">
                {{ station.name }}
              </button>
            }
          </div>
        }
      </div>
    </div>

    <div class="flex-1 overflow-y-auto pr-2">
      @if (viewMode() === 'station') {
        <!-- Station View Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
          @for (ticket of groupedKdsTickets(); track ticket.tableNumber) {
            <div (click)="openDetailModal(ticket)" class="bg-gray-800 rounded-lg overflow-hidden border-2 border-gray-700 flex flex-col cursor-pointer hover:border-blue-500 transition-colors">
              <div class="p-3 text-white font-bold flex justify-between items-center" [class]="ticket.ticketTimerColor">
                <span>{{ ticket.tableNumber === 0 ? 'Caixa' : ('Mesa ' + ticket.tableNumber) }}</span>
                <span class="font-mono text-lg" [class.animate-pulse]="ticket.isTicketLate">{{ formatTime(ticket.ticketElapsedTime) }}</span>
              </div>
              <ul class="p-3 space-y-2 flex-1">
                @for (item of ticket.items; track item.id) {
                  <li (click)="updateStatus(item)" 
                      class="p-3 rounded-r-md transition-all relative"
                      [class.opacity-50]="updatingItems().has(item.id) || item.isHeld" 
                      [class.pointer-events-none]="updatingItems().has(item.id)"
                      [class.border-l-4]="!item.isCritical"
                      [class.border-l-8]="item.isCritical"
                      [class.bg-gray-700/50]="item.isHeld"
                      [class.border-gray-500]="item.isHeld"
                      [class.bg-red-900/40]="!item.isHeld && item.isCritical"
                      [class.border-red-500]="!item.isHeld && item.isCritical"
                      [class.bg-blue-500/10]="!item.isHeld && !item.isCritical && item.status === 'EM_PREPARO'"
                      [class.bg-yellow-500/10]="!item.isHeld && !item.isCritical && item.status === 'PENDENTE'"
                      [class]="!item.isHeld && !item.isCritical ? getItemStatusClass(item.status) : ''">
                    
                    @if(item.isHeld) {
                      <div class="absolute inset-0 flex flex-col items-center justify-center bg-gray-800/80 rounded-r-md p-2 text-center">
                        <p class="text-white font-bold text-sm">Inicia em:</p>
                        <p class="font-mono text-2xl text-yellow-300">{{ formatTime(item.timeToStart) }}</p>
                        <button (click)="startHeldItemNow(item, $event)" class="mt-2 px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-semibold text-xs transition-colors">
                          Preparar Agora
                        </button>
                      </div>
                    }

                    @if(item.isCritical) {
                      <div class="flex items-center justify-between gap-2 mb-2 text-red-300">
                        <div class="flex items-center gap-2">
                          <svg class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                          <span class="font-bold uppercase text-sm">Atenção</span>
                        </div>
                        @if(item.attention_acknowledged) {
                          <span class="flex items-center gap-1 text-xs px-2 py-1 bg-green-500/20 text-green-300 rounded-full">Ciente</span>
                        }
                      </div>
                    }
                    <div class="flex justify-between items-center"><span class="font-bold text-lg text-white">{{ item.quantity }}x {{ item.name }}</span><span class="text-xs font-mono px-2 py-1 rounded" [class.bg-blue-500/20]="item.status === 'EM_PREPARO'" [class.text-blue-300]="item.status === 'EM_PREPARO'" [class.bg-yellow-500/20]="item.status === 'PENDENTE'" [class.text-yellow-300]="item.status === 'PENDENTE'">{{ item.status.replace('_', ' ') }}</span></div>
                    @if (item.notes) { <p class="text-sm mt-1 italic" [class.text-red-300]="item.isCritical" [class.font-semibold]="item.isCritical" [class.text-yellow-200]="!item.isCritical">"{{ item.notes }}"</p> }
                    
                    @if((item.isCritical && !item.attention_acknowledged) || (!item.isHeld && item.status !== 'PRONTO')) {
                      <div class="mt-3 pt-3 space-y-2" [class]="item.isCritical && !item.attention_acknowledged ? 'border-t border-red-500/20' : 'border-t border-gray-600/50'">
                        @if(item.isCritical && !item.attention_acknowledged) {
                          <button (click)="acknowledgeAttention(item, $event)" [disabled]="updatingItems().has(item.id)" class="w-full text-center py-1.5 px-3 bg-red-600 hover:bg-red-500 text-white rounded-lg font-semibold text-sm">Ciente da Atenção</button>
                        }
                        @if(!item.isHeld && item.status !== 'PRONTO') {
                          <button (click)="markAsReady(item, $event)" [disabled]="updatingItems().has(item.id)" class="w-full text-center py-1.5 px-3 bg-green-600 hover:bg-green-500 text-white rounded-lg font-semibold text-sm disabled:bg-gray-500">
                            Marcar como Pronto
                          </button>
                        }
                      </div>
                    }

                    @if(updatingItems().has(item.id)) { <div class="absolute inset-0 bg-gray-900/50 flex items-center justify-center rounded-md"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div></div> }
                  </li>
                }
              </ul>
              <div class="text-xs text-center text-gray-500 p-2 border-t border-gray-700">Recebido às {{ ticket.oldestTimestamp | date:'HH:mm' }}</div>
            </div>
          }
          @if (groupedKdsTickets().length === 0) {
            <div class="col-span-full flex items-center justify-center h-64 bg-gray-800 rounded-lg">
              <div class="text-center">
                <svg class="mx-auto h-12 w-12 text-gray-600" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <h3 class="mt-2 text-sm font-medium text-gray-400">Nenhum pedido ativo</h3>
                <p class="mt-1 text-sm text-gray-500">Aguardando novos pedidos para esta estação.</p>
              </div>
            </div>
          }
        </div>
      } @else {
        <!-- Expo View Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
          @for (ticket of expoViewTickets(); track ticket.tableNumber) {
            <div class="bg-gray-800 rounded-lg overflow-hidden border-2 flex flex-col" [class.border-green-500]="ticket.isReadyForPickup" [class.border-gray-700]="!ticket.isReadyForPickup">
              <div class="p-3 text-white font-bold flex justify-between items-center" [class]="ticket.isReadyForPickup ? 'bg-green-600' : ticket.ticketTimerColor">
                <span>{{ ticket.tableNumber === 0 ? 'Caixa' : ('Mesa ' + ticket.tableNumber) }}</span>
                <span class="font-mono text-lg">{{ formatTime(ticket.ticketElapsedTime) }}</span>
              </div>
              <ul class="p-3 space-y-2 flex-1">
                @for (item of ticket.items; track item.id) {
                  <li class="p-2 rounded-md flex justify-between items-center gap-2" 
                      [class.bg-blue-900/50]="item.status === 'EM_PREPARO'" 
                      [class.bg-yellow-900/50]="item.status === 'PENDENTE'" 
                      [class.bg-green-900/50]="item.status === 'PRONTO'"
                      [class.bg-gray-700/50]="item.status !== 'EM_PREPARO' && item.status !== 'PENDENTE' && item.status !== 'PRONTO'">
                    <div class="flex-1">
                      <p class="font-semibold text-white">{{ item.quantity }}x {{ item.name }}</p>
                      <p class="text-xs text-gray-400 font-medium">{{ item.stationName }}</p>
                    </div>
                    <span class="text-xs font-mono px-2 py-1 rounded" 
                          [class.bg-blue-500/20]="item.status === 'EM_PREPARO'" [class.text-blue-300]="item.status === 'EM_PREPARO'" 
                          [class.bg-yellow-500/20]="item.status === 'PENDENTE'" [class.text-yellow-300]="item.status === 'PENDENTE'" 
                          [class.bg-green-500/20]="item.status === 'PRONTO'" [class.text-green-300]="item.status === 'PRONTO'">
                      {{ item.status.replace('_', ' ') }}
                    </span>
                  </li>
                }
              </ul>
              @if(ticket.isReadyForPickup) {
                <div class="p-2 border-t border-gray-700">
                  <button (click)="markOrderAsServed(ticket)" [disabled]="updatingTickets().has(ticket.tableNumber)" class="w-full text-center py-2 px-3 bg-green-600 hover:bg-green-500 text-white rounded-lg font-semibold text-sm disabled:bg-gray-500 disabled:cursor-wait flex items-center justify-center gap-2">
                    @if(updatingTickets().has(ticket.tableNumber)) {
                      <svg class="animate-spin h-4 w-4 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                      <span>Enviando...</span>
                    } @else {
                      <span>Marcar como Entregue</span>
                    }
                  </button>
                </div>
              }
              <div class="text-xs text-center text-gray-500 p-2 border-t border-gray-700">Recebido às {{ ticket.oldestTimestamp | date:'HH:mm' }}</div>
            </div>
          }
          @if (expoViewTickets().length === 0) {
            <div class="col-span-full flex items-center justify-center h-64 bg-gray-800 rounded-lg">
              <p class="text-gray-500">Nenhum pedido ativo em todas as estações.</p>
            </div>
          }
        </div>
      }
    </div>
  }
</div>

<!-- Assign Employee Modal -->
@if(isAssignEmployeeModalOpen()) {
  <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 no-print" (click)="isAssignEmployeeModalOpen.set(false)">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md border border-gray-700" (click)="$event.stopPropagation()">
      <div class="p-4 border-b border-gray-700"><h3 class="text-xl font-bold text-white">Atribuir Responsável - {{ selectedStation()?.name }}</h3></div>
      <div class="p-6 max-h-[70vh] overflow-y-auto"><div class="grid grid-cols-2 md:grid-cols-3 gap-4">@for(employee of employees(); track employee.id) {<button (click)="assignEmployeeToStation(employee.id)" class="flex flex-col items-center gap-2 p-4 rounded-lg transition-colors" [class.bg-blue-600]="selectedStation()?.employee_id === employee.id" [class.text-white]="selectedStation()?.employee_id === employee.id" [class.bg-gray-700]="selectedStation()?.employee_id !== employee.id" [class.hover:bg-gray-600]="selectedStation()?.employee_id !== employee.id"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span class="font-semibold text-center text-sm">{{ employee.name }}</span></button>}</div></div>
      <div class="p-4 bg-gray-700/50 flex justify-between gap-3"><button (click)="assignEmployeeToStation(null)" class="w-full px-4 py-2 font-medium rounded-lg bg-red-600 hover:bg-red-500 text-white transition-colors" [disabled]="!selectedStation()?.employee_id">Remover</button><button (click)="isAssignEmployeeModalOpen.set(false)" class="w-full px-4 py-2 font-medium rounded-lg bg-gray-600 hover:bg-gray-500 text-white transition-colors">Cancelar</button></div>
    </div>
  </div>
}

<!-- Details Modal -->
@if(isDetailModalOpen() && selectedTicketForDetail(); as ticket) {
  <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 no-print" (click)="closeDetailModal()">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col border border-gray-700" (click)="$event.stopPropagation()">
      <div class="flex justify-between items-center p-4 border-b border-gray-700"><h3 class="text-xl font-bold text-white">Detalhes do Pedido</h3><button (click)="closeDetailModal()" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"></path></svg></button></div>
      <div class="p-6 flex-1 overflow-y-auto">
        <div class="grid grid-cols-3 gap-4 text-center mb-6 pb-4 border-b border-gray-600">
            <div><p class="text-sm text-gray-400">Origem</p><p class="text-lg font-semibold text-white">{{ ticket.tableNumber === 0 ? 'Caixa' : ('Mesa ' + ticket.tableNumber) }}</p></div>
            <div><p class="text-sm text-gray-400">Recebido</p><p class="text-lg font-semibold text-white">{{ ticket.oldestTimestamp | date:'HH:mm:ss' }}</p></div>
            <div><p class="text-sm text-gray-400">Tempo Total</p><p class="text-lg font-semibold font-mono" [class.text-red-400]="ticket.isTicketLate">{{ formatTime(ticket.ticketElapsedTime) }}</p></div>
        </div>
        <div>
            <h4 class="font-semibold text-white mb-3">Itens do Pedido</h4>
            <ul class="space-y-3">
                @for (item of ticket.items; track item.id) {
                <li class="p-3 rounded-lg flex gap-4" [class.bg-red-900/40]="item.isCritical" [class.bg-blue-900/50]="item.status === 'EM_PREPARO' && !item.isCritical" [class.bg-yellow-900/50]="item.status === 'PENDENTE' && !item.isCritical">
                  <div class="flex-1">
                      @if(item.isCritical) {<div class="flex items-center gap-2 mb-2 text-red-300"><svg class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg><span class="font-bold uppercase text-sm">Atenção</span></div>}
                      <p class="font-bold text-white">{{ item.quantity }}x {{ item.name }}</p>
                      @if(item.notes) { <p class="text-sm italic" [class.text-red-300]="item.isCritical" [class.text-yellow-200]="!item.isCritical">"{{ item.notes }}"</p> }
                      <p class="text-xs font-mono mt-1" [ngClass]="item.timerColor">{{ item.status.replace('_', ' ') }} - {{ formatTime(item.elapsedTimeSeconds) }}</p>
                  </div>
                  <div class="w-1/3 text-xs border-l border-gray-500 pl-4">
                    <p class="font-semibold text-gray-300 mb-1">Histórico do Item</p>
                    <ul class="space-y-1">
                      @for(history of getStatusHistory(item.status_timestamps); track history.status) {
                        <li class="flex items-center gap-2"><span class="font-mono text-gray-400">{{ history.time | date:'HH:mm:ss' }}</span><span class="font-semibold text-gray-200 uppercase">{{ history.status.replace('_', ' ') }}</span></li>
                      }
                    </ul>
                  </div>
                </li>
                }
            </ul>
        </div>
      </div>
      <div class="p-4 bg-gray-900/50 flex justify-end gap-3"><button (click)="closeDetailModal()" class="px-4 py-2 font-medium rounded-lg bg-gray-600 hover:bg-gray-500 text-white">Fechar</button><button (click)="printTicket(ticket)" class="px-4 py-2 font-medium rounded-lg bg-blue-600 hover:bg-blue-500 text-white">Imprimir</button></div>
    </div>
  </div>
}