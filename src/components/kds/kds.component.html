







<div class="h-full flex flex-col no-print">
  @if (stations().length === 0) {
    <div class="m-auto text-center bg-gray-800 p-8 rounded-lg">
      <h1 class="text-2xl font-bold text-white mb-4">Nenhuma Estação de Produção Encontrada</h1>
      <p class="text-gray-400">Para usar o KDS, primeiro você precisa cadastrar as estações (ex: Cozinha, Bar).</p>
      <p class="text-gray-500 text-sm mt-2">Vá para Configurações para adicionar uma estação.</p>
    </div>
  } @else {
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-4 gap-4">
      <div class="flex-1">
        <div class="flex items-center gap-3">
             <h1 class="text-2xl font-bold text-white">KDS</h1>
             <!-- Recall Button -->
             @if(viewMode() === 'station') {
                 <button (click)="isRecallModalOpen.set(true)" class="flex items-center gap-2 px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm text-gray-300 transition-colors border border-gray-600">
                    <span class="material-symbols-outlined text-base">history</span>
                    <span>Desfazer</span>
                 </button>
             }
        </div>
        
        @if(viewMode() === 'station' || viewMode() === 'production') {
          <div class="flex items-center gap-2 mt-2 text-sm">
            <span class="text-gray-400">Responsável:</span>
            @if (selectedStation()?.employees; as employee) {
              <span class="font-semibold text-white bg-gray-700 px-2 py-1 rounded-md">{{ employee.name }}</span>
            } @else {
              <span class="text-gray-500 italic">Ninguém</span>
            }
            <button (click)="isAssignEmployeeModalOpen.set(true)" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white" title="Atribuir responsável">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
            </button>
          </div>
        }
      </div>
      <div class="flex items-center flex-wrap gap-4">
        <!-- Sound Toggle -->
        <button (click)="soundNotificationService.toggleMute()" class="p-2 rounded-lg text-white transition-colors" [class.bg-red-600]="soundNotificationService.isMuted()" [class.hover:bg-red-500]="soundNotificationService.isMuted()" [class.bg-gray-700]="!soundNotificationService.isMuted()" [class.hover:bg-gray-600]="!soundNotificationService.isMuted()" [title]="soundNotificationService.isMuted() ? 'Ativar Som' : 'Silenciar'">
          @if (soundNotificationService.isMuted()) {
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75L19.5 12m0 0l2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-6l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg>
          } @else {
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" /></svg>
          }
        </button>

        <!-- View Mode Toggle -->
        <div class="flex gap-1 bg-gray-900/50 p-1 rounded-lg">
          <button (click)="setViewMode('station')" class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors" [class.bg-blue-600]="viewMode() === 'station'" [class.text-white]="viewMode() === 'station'">Ticket</button>
          <button (click)="setViewMode('production')" class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors" [class.bg-blue-600]="viewMode() === 'production'" [class.text-white]="viewMode() === 'production'">Produção</button>
          <button (click)="setViewMode('expo')" class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors" [class.bg-blue-600]="viewMode() === 'expo'" [class.text-white]="viewMode() === 'expo'">Expo</button>
        </div>

        <!-- Station Selector for Station View -->
        @if(viewMode() === 'station' || viewMode() === 'production') {
          <div class="flex flex-wrap gap-1 bg-gray-700 p-1 rounded-lg">
            @for (station of stations(); track station.id) {
              <button (click)="selectStation(station)" class="px-4 py-2 text-sm font-medium rounded-md transition-colors" [class.bg-blue-600]="selectedStation()?.id === station.id" [class.text-white]="selectedStation()?.id === station.id" [class.text-gray-300]="selectedStation()?.id !== station.id">
                {{ station.name }}
              </button>
            }
          </div>
        }
      </div>
    </div>

    <div class="flex-1 overflow-y-auto pr-2">
      @if (viewMode() === 'station') {
        <!-- Station View Grid (Ticket based) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
          @for (ticket of groupedKdsTickets(); track ticket.orderId) {
            <div class="bg-gray-800 rounded-lg overflow-hidden border-2 flex flex-col shadow-lg transition-transform" 
                [class.border-red-600]="ticket.isOrderCancelled" 
                [class.border-gray-700]="!ticket.isOrderCancelled"
                [class.border-blue-500]="ticket.orderType.includes('iFood') && !ticket.isOrderCancelled"
                [class.border-l-8]="ticket.orderType.includes('iFood')">
              
              <!-- Ticket Header -->
              <div class="p-3 text-white font-bold flex justify-between items-center" [class]="ticket.ticketTimerColor">
                <div class="flex items-center gap-2 overflow-hidden">
                    <!-- Context Icon -->
                    @if (ticket.orderType.includes('Delivery')) {
                         <span class="material-symbols-outlined text-white">two_wheeler</span>
                    } @else if (ticket.orderType.includes('Takeout')) {
                         <span class="material-symbols-outlined text-white">shopping_bag</span>
                    } @else if (ticket.orderType === 'QuickSale') {
                         <span class="material-symbols-outlined text-white">point_of_sale</span>
                    } @else if (ticket.orderType === 'Tab') {
                        <span class="material-symbols-outlined text-white">id_card</span>
                    } @else {
                         <span class="material-symbols-outlined text-white">restaurant</span>
                    }

                    <div class="flex flex-col leading-tight min-w-0">
                        @if (ticket.orderType.startsWith('iFood')) {
                            <span class="truncate" title="iFood #{{ ticket.ifoodDisplayId }}">#{{ ticket.ifoodDisplayId }}</span>
                        } @else if (ticket.orderType === 'QuickSale') {
                            <span>Caixa</span>
                        } @else if (ticket.orderType === 'Tab') {
                            <span>{{ ticket.tabName || ('Comanda ' + ticket.commandNumber) }}</span>
                        } @else {
                            <span>Mesa {{ ticket.tableNumber }}</span>
                        }
                        @if(ticket.customerName) {
                            <span class="text-[10px] font-normal opacity-90 truncate max-w-[120px]">{{ ticket.customerName }}</span>
                        }
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    @if(ticket.isOrderCancelled) {
                        <span class="text-xs uppercase bg-black/40 px-2 py-0.5 rounded animate-pulse">Cancelado</span>
                    }
                    <span class="font-mono text-xl tracking-tight" [class.animate-pulse]="ticket.isTicketLate">{{ formatTime(ticket.ticketElapsedTime) }}</span>
                    <button (click)="openDetailModal(ticket); $event.stopPropagation()" class="p-1 rounded-full text-white/70 hover:bg-white/20 hover:text-white transition-colors" title="Ver Detalhes">
                        <span class="material-symbols-outlined text-base">info</span>
                    </button>
                </div>
              </div>

              <!-- Items List -->
              <ul class="p-2 space-y-2 flex-1 bg-gray-900/30">
                @for (item of ticket.items; track item.id) {
                  <li (click)="updateStatus(item, false, $event)" 
                      class="p-2 rounded border-l-4 transition-all relative cursor-pointer group"
                      [class.opacity-50]="updatingItems().has(item.id) || item.isHeld" 
                      [class.pointer-events-none]="updatingItems().has(item.id)"
                      [class.bg-gray-700]="!item.isCritical && !item.isCancelled && !item.isHeld"
                      [class.bg-red-900/40]="!item.isHeld && (item.isCritical || item.isCancelled)"
                      [class.border-gray-500]="item.isHeld"
                      [class.border-red-500]="!item.isHeld && (item.isCritical || item.isCancelled)"
                      [class]="!item.isHeld && !item.isCritical ? getItemStatusClass(item.status) : ''">
                    
                    <!-- Held Overlay -->
                    @if(item.isHeld) {
                      <div class="absolute inset-0 flex flex-col items-center justify-center bg-gray-800/90 rounded p-1 text-center z-10">
                        <p class="text-white font-bold text-xs">Inicia em:</p>
                        <p class="font-mono text-xl text-yellow-300">{{ formatTime(item.timeToStart) }}</p>
                        <button (click)="startHeldItemNow(item, $event)" class="mt-1 px-2 py-0.5 bg-blue-600 hover:bg-blue-500 text-white rounded text-[10px] uppercase font-bold">
                          Agora
                        </button>
                      </div>
                    }

                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-baseline gap-2">
                                <span class="font-bold text-lg text-white font-mono" [class.line-through]="item.isCancelled" [class.text-gray-400]="item.isCancelled">
                                        {{ item.quantity }}
                                </span>
                                <span class="font-bold text-base text-white leading-tight" [class.line-through]="item.isCancelled" [class.text-gray-400]="item.isCancelled">
                                        {{ item.name }}
                                </span>
                            </div>
                             @if (item.notes) { 
                                <div class="mt-1 inline-block px-2 py-0.5 rounded text-sm font-bold border" 
                                    [class.bg-yellow-900]="!item.isCancelled" [class.text-yellow-100]="!item.isCancelled" [class.border-yellow-600]="!item.isCancelled"
                                    [class.bg-gray-800]="item.isCancelled" [class.text-gray-500]="item.isCancelled" [class.border-gray-600]="item.isCancelled">
                                    <span class="mr-1">⚠️</span> {{ item.notes }}
                                </div> 
                             }
                        </div>
                        
                        <!-- Status Badge -->
                        <span class="text-[10px] font-mono uppercase px-1.5 py-0.5 rounded ml-2 whitespace-nowrap border" 
                              [class.bg-blue-500/20]="item.status === 'EM_PREPARO'" [class.text-blue-300]="item.status === 'EM_PREPARO'" [class.border-blue-500/50]="item.status === 'EM_PREPARO'"
                              [class.bg-yellow-500/20]="item.status === 'PENDENTE'" [class.text-yellow-300]="item.status === 'PENDENTE'" [class.border-yellow-500/50]="item.status === 'PENDENTE'"
                              [class.bg-red-500/20]="item.isCancelled" [class.text-red-300]="item.isCancelled" [class.border-red-500/50]="item.isCancelled">
                            {{ item.isCancelled ? 'CANCELADO' : (item.status === 'EM_PREPARO' ? 'PREPARANDO' : 'PENDENTE') }}
                        </span>
                    </div>

                    <!-- Action Buttons -->
                    @if(item.isCancelled) {
                        <div class="mt-2 pt-2 border-t border-red-500/20">
                             <button (click)="acknowledgeCancellation(item, $event)" [disabled]="updatingItems().has(item.id)" class="w-full text-center py-1 bg-red-800 hover:bg-red-700 text-white rounded text-xs font-bold uppercase tracking-wider">Ciente</button>
                        </div>
                    } @else if((item.isCritical && !item.attention_acknowledged) || (!item.isHeld && item.status !== 'PRONTO')) {
                      <div class="mt-2 pt-2 space-y-1" [class]="item.isCritical && !item.attention_acknowledged ? 'border-t border-red-500/20' : 'border-t border-gray-600/30'">
                        @if(item.isCritical && !item.attention_acknowledged) {
                          <button (click)="acknowledgeAttention(item, $event)" [disabled]="updatingItems().has(item.id)" class="w-full text-center py-1 bg-red-600 hover:bg-red-500 text-white rounded text-xs font-bold uppercase tracking-wider mb-1">! Atenção !</button>
                        }
                        @if(!item.isHeld && item.status !== 'PRONTO') {
                          <button (click)="markAsReady(item, ticket, $event)" [disabled]="updatingItems().has(item.id)" class="w-full text-center py-2 bg-green-700 hover:bg-green-600 text-white rounded text-xs font-bold uppercase tracking-wider shadow-sm active:translate-y-0.5 transition-all">
                            PRONTO
                          </button>
                        }
                      </div>
                    }

                    @if(updatingItems().has(item.id)) { <div class="absolute inset-0 bg-gray-900/60 flex items-center justify-center rounded z-20"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div></div> }
                  </li>
                }
              </ul>
              
              <!-- Batch Actions Footer -->
              @if(!ticket.isOrderCancelled) {
                  <div class="p-2 bg-gray-800 border-t border-gray-700 grid grid-cols-2 gap-2">
                      <button (click)="batchUpdateTicketStatus(ticket, 'START_ALL')" class="py-2 bg-blue-900/50 hover:bg-blue-800 text-blue-200 text-xs font-bold uppercase rounded border border-blue-800 transition-colors">
                          Iniciar Tudo
                      </button>
                       <button (click)="batchUpdateTicketStatus(ticket, 'FINISH_ALL')" class="py-2 bg-green-900/50 hover:bg-green-800 text-green-200 text-xs font-bold uppercase rounded border border-green-800 transition-colors">
                          Pronto Tudo
                      </button>
                  </div>
              }
              
              <div class="text-[10px] text-center text-gray-500 p-1 bg-gray-900">
                  Recebido às {{ ticket.oldestTimestamp | date:'HH:mm' }}
              </div>
            </div>
          }
          @if (groupedKdsTickets().length === 0) {
            <div class="col-span-full flex items-center justify-center h-64 bg-gray-800 rounded-lg">
              <div class="text-center">
                <svg class="mx-auto h-12 w-12 text-gray-600" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <h3 class="mt-2 text-sm font-medium text-gray-400">Nenhum pedido ativo</h3>
                <p class="mt-1 text-sm text-gray-500">Aguardando novos pedidos para esta estação.</p>
              </div>
            </div>
          }
        </div>
      } @else if (viewMode() === 'production') {
        <!-- PRODUCTION VIEW (ALL DAY) -->
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
            @for (agg of productionAggregates(); track agg.name + agg.notes) {
                <div 
                    (click)="advanceProductionItems(agg)"
                    class="bg-gray-800 rounded-lg border-2 p-4 cursor-pointer relative hover:scale-105 transition-transform flex flex-col justify-between aspect-square"
                    [class]="getItemStatusClass(agg.status)"
                    [class.border-red-500]="agg.isCritical"
                    [class.animate-pulse]="agg.isCritical">
                    
                    @if(updatingItems().has(agg.ids[0])) {
                         <div class="absolute inset-0 bg-gray-900/50 flex items-center justify-center rounded-md z-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div></div>
                    }

                    <div class="text-center">
                        <span class="text-4xl font-extrabold text-white">{{ agg.quantity }}</span>
                        <span class="text-sm font-bold text-gray-400 block uppercase mt-1">A Produzir</span>
                    </div>

                    <div class="text-center border-t border-gray-600/50 pt-2 mt-2">
                         <h3 class="text-lg font-bold text-white leading-tight line-clamp-2">{{ agg.name }}</h3>
                         @if(agg.notes) {
                             <p class="text-xs text-yellow-300 italic mt-1 line-clamp-2 bg-yellow-900/30 px-1 rounded">{{ agg.notes }}</p>
                         }
                    </div>

                    <div class="text-center mt-2">
                        <span class="px-2 py-1 text-xs font-bold rounded-full bg-black/40 text-white font-mono">
                            Wait: {{ formatTime(agg.maxElapsedTime) }}
                        </span>
                    </div>
                </div>
            } @empty {
                <div class="col-span-full flex items-center justify-center h-64 bg-gray-800 rounded-lg">
                    <p class="text-gray-500">Nada para produzir no momento.</p>
                </div>
            }
        </div>
      } @else {
        <!-- Expo View Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
          @for (ticket of expoViewTickets(); track ticket.orderId) {
            <div class="bg-gray-800 rounded-lg overflow-hidden border-2 flex flex-col" [class.border-green-500]="ticket.isReadyForPickup && !ticket.isOrderCancelled" [class.border-gray-700]="!ticket.isReadyForPickup && !ticket.isOrderCancelled" [class.border-red-600]="ticket.isOrderCancelled">
              <div class="p-3 text-white font-bold flex justify-between items-center" [class]="ticket.isOrderCancelled ? 'bg-red-800' : (ticket.isReadyForPickup ? 'bg-green-600' : ticket.ticketTimerColor)">
                <div class="flex items-center gap-2">
                    @if (ticket.orderType.startsWith('iFood')) {
                        <span title="{{ ticket.orderType === 'iFood-Delivery' ? 'iFood Entrega' : 'iFood Retirada' }}">#{{ ticket.ifoodDisplayId }}</span>
                    } @else if (ticket.orderType === 'QuickSale') {
                        <span>Caixa</span>
                    } @else if (ticket.orderType === 'Tab') {
                        <span>{{ ticket.tabName || ('Comanda ' + ticket.commandNumber) }}</span>
                    } @else {
                        <span>Mesa {{ ticket.tableNumber }}</span>
                    }
                    @if(ticket.isOrderCancelled) {
                        <span class="text-xs uppercase bg-black/40 px-2 py-0.5 rounded">Cancelado</span>
                    }
                </div>
                <span class="font-mono text-lg">{{ formatTime(ticket.ticketElapsedTime) }}</span>
              </div>
              
              <!-- Progress Bar -->
              <div class="h-1 w-full bg-gray-700">
                  <div class="h-1 bg-green-500 transition-all duration-500" [style.width.%]="ticket.progress"></div>
              </div>
              
              <ul class="p-3 space-y-2 flex-1">
                @for (item of ticket.items; track item.id) {
                  <li class="p-2 rounded-md flex justify-between items-center gap-2" 
                      [class.bg-blue-900/50]="item.status === 'EM_PREPARO' && !item.isCancelled" 
                      [class.bg-yellow-900/50]="item.status === 'PENDENTE' && !item.isCancelled" 
                      [class.bg-green-900/50]="item.status === 'PRONTO' && !item.isCancelled"
                      [class.bg-red-900/40]="item.isCancelled"
                      [class.bg-gray-700/50]="item.status !== 'EM_PREPARO' && item.status !== 'PENDENTE' && item.status !== 'PRONTO' && !item.isCancelled">
                    <div class="flex-1">
                      <p class="font-semibold text-white" [class.line-through]="item.isCancelled" [class.text-gray-400]="item.isCancelled">{{ item.quantity }}x {{ item.name }}</p>
                      <p class="text-xs text-gray-400 font-medium">{{ item.stationName }}</p>
                    </div>
                    <span class="text-xs font-mono px-2 py-1 rounded" 
                          [class.bg-blue-500/20]="item.status === 'EM_PREPARO'" [class.text-blue-300]="item.status === 'EM_PREPARO'" 
                          [class.bg-yellow-500/20]="item.status === 'PENDENTE'" [class.text-yellow-300]="item.status === 'PENDENTE'" 
                          [class.bg-green-500/20]="item.status === 'PRONTO'" [class.text-green-300]="item.status === 'PRONTO'"
                          [class.bg-red-500/20]="item.isCancelled" [class.text-red-300]="item.isCancelled">
                      {{ item.isCancelled ? 'CANCELADO' : item.status.replace('_', ' ') }}
                    </span>
                  </li>
                }
              </ul>
              @if(ticket.isReadyForPickup && !ticket.isOrderCancelled) {
                <div class="p-2 border-t border-gray-700 bg-green-900/20">
                  <button (click)="markOrderAsServed(ticket)" [disabled]="updatingTickets().has(ticket.orderId)" class="w-full text-center py-3 px-3 bg-green-600 hover:bg-green-500 text-white rounded-lg font-bold text-sm disabled:bg-gray-500 disabled:cursor-wait flex items-center justify-center gap-2 shadow-lg">
                    @if(updatingTickets().has(ticket.orderId)) {
                      <svg class="animate-spin h-4 w-4 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                      <span>Enviando...</span>
                    } @else {
                      <span class="material-symbols-outlined">check_circle</span>
                      <span>PEDIDO COMPLETO - EXPEDIR</span>
                    }
                  </button>
                </div>
              }
              <div class="text-xs text-center text-gray-500 p-2 border-t border-gray-700">Recebido às {{ ticket.oldestTimestamp | date:'HH:mm' }}</div>
            </div>
          }
          @if (expoViewTickets().length === 0) {
            <div class="col-span-full flex items-center justify-center h-64 bg-gray-800 rounded-lg">
              <p class="text-gray-500">Nenhum pedido ativo em todas as estações.</p>
            </div>
          }
        </div>
      }
    </div>
  }
</div>

<!-- Assign Employee Modal -->
@if(isAssignEmployeeModalOpen()) {
  <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 no-print" (click)="isAssignEmployeeModalOpen.set(false)">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md border border-gray-700" (click)="$event.stopPropagation()">
      <div class="p-4 border-b border-gray-700"><h3 class="text-xl font-bold text-white">Atribuir Responsável - {{ selectedStation()?.name }}</h3></div>
      <div class="p-6 max-h-[70vh] overflow-y-auto"><div class="grid grid-cols-2 md:grid-cols-3 gap-4">@for(employee of employees(); track employee.id) {<button (click)="assignEmployeeToStation(employee.id)" class="flex flex-col items-center gap-2 p-4 rounded-lg transition-colors" [class.bg-blue-600]="selectedStation()?.employee_id === employee.id" [class.text-white]="selectedStation()?.employee_id === employee.id" [class.bg-gray-700]="selectedStation()?.employee_id !== employee.id" [class.hover:bg-gray-600]="selectedStation()?.employee_id !== employee.id"><svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span class="font-semibold text-center text-sm">{{ employee.name }}</span></button>}</div></div>
      <div class="p-4 bg-gray-700/50 flex justify-between gap-3"><button (click)="assignEmployeeToStation(null)" class="w-full px-4 py-2 font-medium rounded-lg bg-red-600 hover:bg-red-500 text-white transition-colors" [disabled]="!selectedStation()?.employee_id">Remover</button><button (click)="isAssignEmployeeModalOpen.set(false)" class="w-full px-4 py-2 font-medium rounded-lg bg-gray-600 hover:bg-gray-500 text-white transition-colors">Cancelar</button></div>
    </div>
  </div>
}

<!-- Recall / Undo Modal -->
@if(isRecallModalOpen()) {
  <div class="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 no-print" (click)="isRecallModalOpen.set(false)">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg max-h-[80vh] flex flex-col border border-gray-700" (click)="$event.stopPropagation()">
        <div class="p-4 border-b border-gray-700 flex justify-between items-center">
            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                <span class="material-symbols-outlined text-yellow-400">history</span>
                Histórico Recente / Desfazer
            </h3>
            <button (click)="isRecallModalOpen.set(false)" class="p-1 rounded-full text-gray-400 hover:text-white"><span class="material-symbols-outlined">close</span></button>
        </div>
        <div class="p-4 flex-1 overflow-y-auto">
            @if(recentlyCompletedItems().length === 0) {
                <div class="text-center text-gray-500 py-8">
                    <p>Nenhum item finalizado recentemente nesta sessão.</p>
                </div>
            } @else {
                <p class="text-xs text-gray-400 mb-3">Clique em "Restaurar" para trazer o item de volta para a fila.</p>
                <div class="space-y-2">
                    @for(recall of recentlyCompletedItems(); track recall.finishedAt) {
                        <div class="bg-gray-700/50 p-3 rounded-lg flex justify-between items-center border border-gray-600">
                            <div>
                                <p class="font-bold text-white">{{ recall.displayItem.quantity }}x {{ recall.displayItem.name }}</p>
                                <p class="text-xs text-gray-400">{{ recall.ticketInfo }} • {{ recall.finishedAt | date:'HH:mm:ss' }}</p>
                            </div>
                            <button (click)="restoreItem(recall)" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded flex items-center gap-1 transition-colors">
                                <span class="material-symbols-outlined text-sm">undo</span> Restaurar
                            </button>
                        </div>
                    }
                </div>
            }
        </div>
        <div class="p-3 bg-gray-900/50 text-center border-t border-gray-700">
            <button (click)="isRecallModalOpen.set(false)" class="text-gray-400 hover:text-white text-sm">Fechar</button>
        </div>
    </div>
  </div>
}

<!-- Details Modal -->
@if(isDetailModalOpen() && selectedTicketForDetail(); as ticket) {
  <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 no-print" (click)="closeDetailModal()">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col border border-gray-700" (click)="$event.stopPropagation()">
      <div class="flex justify-between items-center p-4 border-b border-gray-700"><h3 class="text-xl font-bold text-white">Detalhes do Pedido</h3><button (click)="closeDetailModal()" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"></path></svg></button></div>
      <div class="p-6 flex-1 overflow-y-auto">
        <div class="grid grid-cols-3 gap-4 text-center mb-6 pb-4 border-b border-gray-600">
            <div><p class="text-sm text-gray-400">Origem</p><p class="text-lg font-semibold text-white">
                @if (ticket.orderType.startsWith('iFood')) {
                    <span>#{{ ticket.ifoodDisplayId }}</span>
                  } @else if (ticket.orderType === 'QuickSale') {
                    <span>Caixa</span>
                  } @else if (ticket.orderType === 'Tab') {
                    <span>{{ ticket.tabName || ('Comanda ' + ticket.commandNumber) }}</span>
                  } @else {
                    <span>Mesa {{ ticket.tableNumber }}</span>
                  }
            </p></div>
            <div><p class="text-sm text-gray-400">Recebido</p><p class="text-lg font-semibold text-white">{{ ticket.oldestTimestamp | date:'HH:mm:ss' }}</p></div>
            <div><p class="text-sm text-gray-400">Tempo Total</p><p class="text-lg font-semibold font-mono" [class.text-red-400]="ticket.isTicketLate">{{ formatTime(ticket.ticketElapsedTime) }}</p></div>
        </div>
        <div>
            <h4 class="font-semibold text-white mb-3">Itens do Pedido</h4>
            <ul class="space-y-3">
                @for (item of ticket.items; track item.id) {
                <li class="p-3 rounded-lg flex gap-4" [class.bg-red-900/40]="item.isCritical || item.isCancelled" [class.bg-blue-900/50]="item.status === 'EM_PREPARO' && !item.isCritical && !item.isCancelled" [class.bg-yellow-900/50]="item.status === 'PENDENTE' && !item.isCritical && !item.isCancelled">
                  <div class="flex-1">
                      @if(item.isCancelled) {
                        <div class="flex items-center gap-2 mb-2 text-red-400">
                             <svg class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
                            <span class="font-bold uppercase text-sm">CANCELADO</span>
                        </div>
                      } @else if(item.isCritical) {
                        <div class="flex items-center gap-2 mb-2 text-red-300"><svg class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg><span class="font-bold uppercase text-sm">Atenção</span></div>
                      }
                      <p class="font-bold text-white" [class.line-through]="item.isCancelled" [class.text-gray-400]="item.isCancelled">{{ item.quantity }}x {{ item.name }}</p>
                      @if(item.notes) { <p class="text-sm italic" [class.text-red-300]="item.isCritical" [class.text-yellow-200]="!item.isCritical">"{{ item.notes }}"</p> }
                      <p class="text-xs font-mono mt-1" [ngClass]="item.timerColor">{{ item.isCancelled ? 'CANCELADO' : item.status.replace('_', ' ') }} - {{ formatTime(item.elapsedTimeSeconds) }}</p>
                  </div>
                  <div class="w-1/3 text-xs border-l border-gray-500 pl-4">
                    <p class="font-semibold text-gray-300 mb-1">Histórico do Item</p>
                    <ul class="space-y-1">
                      @for(history of getStatusHistory(item.status_timestamps); track history.status) {
                        <li class="flex items-center gap-2"><span class="font-mono text-gray-400">{{ history.time | date:'HH:mm:ss' }}</span><span class="font-semibold text-gray-200 uppercase">{{ history.status.replace('_', ' ') }}</span></li>
                      }
                    </ul>
                  </div>
                </li>
                }
            </ul>
        </div>
      </div>
      <div class="p-4 bg-gray-900/50 flex justify-end gap-3"><button (click)="closeDetailModal()" class="px-4 py-2 font-medium rounded-lg bg-gray-600 hover:bg-gray-500 text-white">Fechar</button><button (click)="printTicket(ticket)" class="px-4 py-2 font-medium rounded-lg bg-blue-600 hover:bg-blue-500 text-white">Imprimir</button></div>
    </div>
  </div>
}
