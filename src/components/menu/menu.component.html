<!-- Main container: Handles public vs. internal view styling -->
<div [class.bg-white]="isPublicView()" [class.min-h-screen]="isPublicView()" [class.text-gray-800]="isPublicView()" [class.font-sans]="isPublicView()">

  <!-- =================================================================== -->
  <!-- ========================= PUBLIC VIEW ========================= -->
  <!-- =================================================================== -->
  @if (isPublicView()) {
    @if (isLoading()) {
      <div class="flex items-center justify-center h-screen">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600"></div>
      </div>
    } @else {
      @switch (view()) {
        
        <!-- Case 1: Cover Page -->
        @case ('cover') {
          <div class="flex flex-col items-center justify-center min-h-screen p-6 text-center">
            @if(companyProfile()?.logo_url; as logo) {
              <img [src]="logo" alt="Logo" class="h-32 w-32 rounded-full object-cover mb-4 shadow-lg">
            } @else {
               <div class="h-32 w-32 rounded-full bg-gray-200 flex items-center justify-center mb-4 shadow-lg">
                  <span class="text-5xl font-extrabold text-gray-800">
                    <span>C</span><span class="text-blue-600">OS</span>
                  </span>
               </div>
            }
            <h1 class="text-4xl font-bold text-gray-900">{{ companyProfile()?.company_name || 'Bem-vindo!' }}</h1>
            <div class="mt-8 space-y-4 w-full max-w-xs">
                <button (click)="setView('menu')" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors text-lg shadow-md">Ver Cardápio</button>
                <button (click)="setView('info')" class="w-full bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 transition-colors text-lg">Informações & Reservas</button>
            </div>
          </div>
        }

        <!-- Case 2: Menu Page -->
        @case ('menu') {
          <div class="max-w-4xl mx-auto">
              <header class="relative rounded-b-2xl overflow-hidden mb-6 shadow-lg">
                <img src="https://picsum.photos/1200/400?food" alt="Imagem de fundo do restaurante" class="w-full h-40 object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-black/20"></div>
                <div class="absolute inset-0 p-4 flex flex-col justify-between">
                    <!-- Top navigation buttons -->
                    <div class="flex justify-between items-center">
                        <button (click)="setView('cover')" class="p-2 rounded-full bg-black/30 text-white hover:bg-black/50 transition-colors">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
                        </button>
                        <button (click)="setView('info')" class="p-2 rounded-full bg-black/30 text-white hover:bg-black/50 transition-colors">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg>
                        </button>
                    </div>
                    <!-- Restaurant Info -->
                    <div class="flex items-center gap-4">
                        @if(companyProfile()?.logo_url; as logo) {
                            <img [src]="logo" [alt]="'Logo de ' + (companyProfile()?.company_name || 'Restaurante')" class="h-16 w-16 rounded-full object-cover border-2 border-white shadow-md">
                        }
                        <h1 class="text-3xl font-bold text-white drop-shadow-md">{{ companyProfile()?.company_name }}</h1>
                    </div>
                </div>
              </header>
              <!-- Content -->
              <div class="p-4">
                <!-- Search & Filters -->
                <input type="text" [value]="searchTerm()" (input)="searchTerm.set($any($event.target).value)" placeholder="Buscar no cardápio..." class="w-full bg-gray-100 border-2 border-gray-300 rounded-lg pl-4 pr-4 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                
                <div class="flex flex-wrap items-start gap-2 mb-6">
                    <button (click)="setSelectedCategory(null)" class="h-12 px-4 text-sm font-semibold rounded-lg transition-colors flex-shrink-0" [class.bg-blue-600]="activeCategorySlug() === null" [class.text-white]="activeCategorySlug() === null" [class.bg-gray-200]="activeCategorySlug() !== null" [class.hover:bg-gray-300]="activeCategorySlug() !== null">
                      Todas
                    </button>
                    @for(category of menuCategories(); track category.id) {
                        @if (category.image_url) {
                            <div class="w-1/3 flex-grow sm:w-1/4">
                              <button [style.background-image]="'url(' + category.image_url + ')'" (click)="setSelectedCategory(createSlug(category.name))" class="relative w-full h-20 rounded-lg bg-cover bg-center text-white font-bold shadow-md overflow-hidden flex items-center justify-center p-2 text-sm" [class.ring-2]="activeCategorySlug() === createSlug(category.name)" [class.ring-blue-500]="activeCategorySlug() === createSlug(category.name)" [class.ring-offset-2]="activeCategorySlug() === createSlug(category.name)" [class.ring-offset-white]="activeCategorySlug() === createSlug(category.name)">
                                  <div class="absolute inset-0 bg-black/50 hover:bg-black/30 transition-colors"></div>
                                  <span class="relative z-10 truncate">{{ category.name }}</span>
                              </button>
                            </div>
                        } @else {
                             <button (click)="setSelectedCategory(createSlug(category.name))" class="h-12 px-4 text-sm font-semibold rounded-lg transition-colors flex-shrink-0" [class.bg-blue-600]="activeCategorySlug() === createSlug(category.name)" [class.text-white]="activeCategorySlug() === createSlug(category.name)" [class.bg-gray-200]="activeCategorySlug() !== createSlug(category.name)" [class.hover:bg-gray-300]="activeCategorySlug() !== createSlug(category.name)">
                                  {{ category.name }}
                             </button>
                        }
                    }
                </div>

                <!-- Menu Items -->
                <div class="space-y-8">
                  @for (group of filteredMenu(); track group.category.id) {
                    <section>
                      <h2 class="text-2xl font-bold mb-4 border-b-2 border-gray-200 pb-2">{{ group.category.name }}</h2>
                      <div class="space-y-6">
                        @for (recipe of group.recipes; track recipe.id) {
                          <div class="flex gap-4">
                              @if(recipe.image_url) {
                                  <img [src]="recipe.image_url" alt="" class="w-24 h-24 sm:w-32 sm:h-32 rounded-lg object-cover flex-shrink-0">
                              }
                              <div class="flex-1">
                                  <div class="flex justify-between items-start">
                                      <h3 class="text-lg font-semibold">{{ recipe.name }}</h3>
                                      <div class="text-right flex-shrink-0 pl-2">
                                          @if (recipe.effectivePrice < recipe.price) { <p class="text-sm line-through text-gray-500">{{ recipe.price | currency:'BRL' }}</p> }
                                          <p class="font-bold text-lg text-blue-600">{{ recipe.effectivePrice | currency:'BRL' }}</p>
                                      </div>
                                  </div>
                                  @if (recipe.description) { <p class="text-sm text-gray-600 mt-1">{{ recipe.description }}</p> }
                              </div>
                          </div>
                        }
                      </div>
                    </section>
                  }
                </div>
              </div>
          </div>
        }

        <!-- Case 3: Info Page -->
        @case ('info') {
          <div class="max-w-4xl mx-auto p-4">
              <header class="flex items-center mb-6">
                  <button (click)="setView('menu')" class="p-2 rounded-full hover:bg-gray-100"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path d="M15.75 19.5L8.25 12l7.5-7.5" /></svg></button>
                  <h1 class="text-2xl font-bold mx-auto">Informações</h1>
                  <div class="w-10"></div>
              </header>
              <div class="space-y-6">
                <!-- Contact & Address -->
                <div class="bg-gray-100 p-4 rounded-lg">
                  <h2 class="text-lg font-semibold mb-2">Contato e Endereço</h2>
                  <div class="space-y-2 text-sm">
                    @if(companyProfile()?.address; as address) { <p><span class="font-semibold">Endereço:</span> {{ address }}</p> }
                    @if(companyProfile()?.phone; as phone) { <p><span class="font-semibold">Telefone:</span> {{ phone }}</p> }
                  </div>
                </div>
                <!-- Opening Hours -->
                @if(sortedWeeklyHours().length > 0) {
                  <div class="bg-gray-100 p-4 rounded-lg">
                    <h2 class="text-lg font-semibold mb-2">Horário de Funcionamento</h2>
                    <ul class="space-y-1 text-sm">
                      @for (day of sortedWeeklyHours(); track day.day_of_week) {
                        <li class="flex justify-between items-center">
                          <span class="font-semibold">{{ daysOfWeek[day.day_of_week] }}:</span>
                          @if(day.is_closed) { <span class="text-red-600 font-bold">Fechado</span> }
                          @else { <span>{{ day.opening_time }} - {{ day.closing_time }}</span> }
                        </li>
                      }
                    </ul>
                  </div>
                }
                <!-- Loyalty Program -->
                @if(publicLoyaltySettings()?.is_enabled && loyaltyRewardsDisplay().length > 0) {
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <h2 class="text-lg font-semibold mb-2">Programa de Fidelidade</h2>
                        <p class="text-sm mb-3">Ganhe <span class="font-bold">{{publicLoyaltySettings()?.points_per_real}}</span> ponto(s) a cada R$ 1,00 gasto e troque por prêmios!</p>
                        <ul class="space-y-2">
                            @for(reward of loyaltyRewardsDisplay(); track reward.id) {
                                <li class="p-3 bg-white rounded-md border border-gray-200">
                                    <p class="font-semibold text-gray-800">{{ reward.name }} - <span class="text-blue-600 font-bold">{{reward.points_cost}} pts</span></p>
                                    <p class="text-xs text-gray-600">{{ reward.valueLabel }}</p>
                                </li>
                            }
                        </ul>
                    </div>
                }
                <!-- Reservations -->
                @if (reservationSettings()?.is_enabled) {
                  <div class="text-center pt-4">
                      <p class="mb-2 font-semibold" [class.text-green-600]="isRestaurantOpen()" [class.text-red-600]="!isRestaurantOpen()">
                          {{ isRestaurantOpen() ? 'Estamos abertos!' : 'Estamos fechados no momento.' }}
                      </p>
                      <a [href]="publicBookingUrl()" class="w-full max-w-xs inline-block bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors text-lg shadow-md">Fazer uma Reserva</a>
                  </div>
                }
              </div>
          </div>
        }
      }
    }
  } @else {
  <!-- =================================================================== -->
  <!-- ========================= INTERNAL VIEW ========================= -->
  <!-- =================================================================== -->
    <div class="container mx-auto">
        <h1 class="text-3xl font-bold text-white mb-6">Cardápio & Disponibilidade</h1>
        <input type="text" [value]="searchTerm()" (input)="searchTerm.set($any($event.target).value)" placeholder="Buscar no cardápio..." class="w-full bg-gray-800 border border-gray-700 rounded-lg pl-4 pr-4 py-2 mb-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">

        <!-- Category Filters -->
        <div class="flex flex-wrap items-start gap-2 mb-6">
            <button (click)="setSelectedCategory(null)" class="h-12 px-4 text-sm font-semibold rounded-lg transition-colors flex-shrink-0" [class.bg-blue-600]="activeCategorySlug() === null" [class.text-white]="activeCategorySlug() === null" [class.bg-gray-700]="activeCategorySlug() !== null" [class.hover:bg-gray-600]="activeCategorySlug() !== null">
                Todas
            </button>
            @for(category of menuCategories(); track category.id) {
                @if (category.image_url) {
                    <div class="w-1/3 flex-grow sm:w-1/4">
                        <button [style.background-image]="'url(' + category.image_url + ')'" (click)="setSelectedCategory(createSlug(category.name))" class="relative w-full h-20 rounded-lg bg-cover bg-center text-white font-bold shadow-md overflow-hidden flex items-center justify-center p-2 text-sm" [class.ring-2]="activeCategorySlug() === createSlug(category.name)" [class.ring-blue-500]="activeCategorySlug() === createSlug(category.name)" [class.ring-offset-2]="activeCategorySlug() === createSlug(category.name)" [class.ring-offset-gray-800]="activeCategorySlug() === createSlug(category.name)">
                            <div class="absolute inset-0 bg-black/50 hover:bg-black/30 transition-colors"></div>
                            <span class="relative z-10 truncate">{{ category.name }}</span>
                        </button>
                    </div>
                } @else {
                     <button (click)="setSelectedCategory(createSlug(category.name))" class="h-12 px-4 text-sm font-semibold rounded-lg transition-colors flex-shrink-0" [class.bg-blue-600]="activeCategorySlug() === createSlug(category.name)" [class.text-white]="activeCategorySlug() === createSlug(category.name)" [class.bg-gray-700]="activeCategorySlug() !== createSlug(category.name)" [class.hover:bg-gray-600]="activeCategorySlug() !== createSlug(category.name)">
                          {{ category.name }}
                     </button>
                }
            }
        </div>

        <!-- Recipe List -->
        <div class="space-y-8">
            @for (group of filteredMenu(); track group.category.id) {
                <section>
                    <h2 class="text-2xl font-bold text-white mb-4 border-b-2 border-gray-700 pb-2">{{ group.category.name }}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        @for (recipe of group.recipes; track recipe.id) {
                            <div class="bg-gray-800 p-4 rounded-lg border-l-4" [class.border-green-500]="recipe.is_available && recipe.hasStock" [class.border-red-500]="!recipe.is_available || !recipe.hasStock">
                                <div class="flex justify-between items-start">
                                    <h3 class="text-lg font-semibold text-white">{{ recipe.name }}</h3>
                                    <p class="font-bold text-lg text-blue-400">{{ recipe.effectivePrice | currency:'BRL' }}</p>
                                </div>
                                @if (recipe.description) { <p class="text-sm text-gray-400 mt-1">{{ recipe.description }}</p> }
                                <div class="mt-3 pt-3 border-t border-gray-700 text-xs flex justify-end gap-4">
                                    <span [class.text-green-400]="recipe.is_available" [class.text-gray-500]="!recipe.is_available">{{ recipe.is_available ? 'Disponível' : 'Indisponível' }}</span>
                                    <span [class.text-green-400]="recipe.hasStock" [class.text-red-400]="!recipe.hasStock">{{ recipe.hasStock ? 'Com Estoque' : 'Sem Estoque' }}</span>
                                </div>
                            </div>
                        }
                    </div>
                </section>
            }
        </div>
    </div>
  }
</div>
