
<div class="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm" (click)="paymentSuccess() ? null : closeModal.emit(true)">
  <div class="bg-gray-900 rounded-2xl shadow-2xl w-full max-w-5xl h-[85vh] flex overflow-hidden border border-gray-700" (click)="$event.stopPropagation()">
    
    <!-- LEFT SIDE: Order Summary & Split -->
    <div class="w-1/2 flex flex-col border-r border-gray-700 bg-gray-800/50">
        <!-- Header -->
        <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800">
            <div>
                <h3 class="text-lg font-bold text-white">
                    {{ table() ? 'Mesa ' + table()?.number : 'Pagamento' }}
                </h3>
                <p class="text-xs text-gray-400">Total de Itens: {{ lastKnownOrder()?.order_items?.length }}</p>
            </div>
            <div class="flex bg-gray-700 p-1 rounded-lg">
                <button (click)="splitMode.set('total')" class="px-3 py-1 text-xs font-bold rounded-md transition-colors" [class.bg-blue-600]="splitMode() === 'total'" [class.text-white]="splitMode() === 'total'" [class.text-gray-400]="splitMode() !== 'total'">Total</button>
                <button (click)="splitMode.set('item')" class="px-3 py-1 text-xs font-bold rounded-md transition-colors" [class.bg-blue-600]="splitMode() === 'item'" [class.text-white]="splitMode() === 'item'" [class.text-gray-400]="splitMode() !== 'item'">Por Item</button>
            </div>
        </div>

        <!-- Items List (Scrollable) -->
        <div class="flex-1 overflow-y-auto p-4 space-y-2">
            @if(splitMode() === 'total') {
                @for(item of lastKnownOrder()?.order_items; track item.id) {
                    <div class="flex justify-between items-center p-3 bg-gray-700/30 rounded-lg hover:bg-gray-700/50 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="bg-gray-700 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded">{{ item.quantity }}</span>
                            <span class="text-sm font-medium text-gray-200">{{ item.name }}</span>
                        </div>
                        <span class="text-sm font-bold text-white">{{ (item.price * item.quantity) | currency:'BRL' }}</span>
                    </div>
                }
            } @else {
                <!-- Item Split Mode -->
                <div class="space-y-4">
                    <div class="bg-gray-900/50 p-3 rounded-xl border border-gray-700">
                        <p class="text-xs text-gray-500 uppercase font-bold mb-2">Itens Restantes</p>
                        @for(item of unassignedItems(); track item.id) {
                            <div (click)="assignItemToGroup(item)" class="flex justify-between items-center p-2 mb-1 bg-gray-800 rounded cursor-pointer hover:bg-gray-700">
                                <span class="text-xs text-white">{{item.quantity}}x {{item.name}}</span>
                                <span class="text-xs font-bold text-gray-300">{{ (item.price * item.quantity) | currency:'BRL' }}</span>
                            </div>
                        }
                    </div>

                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold mb-2">Pessoas / Grupos</p>
                        <div class="space-y-2">
                            @for(group of itemGroups(); track group.id) {
                                <div (click)="selectGroup(group.id)" class="border rounded-xl p-3 cursor-pointer transition-all"
                                     [class.border-blue-500]="selectedGroupId() === group.id"
                                     [class.bg-blue-900/10]="selectedGroupId() === group.id"
                                     [class.border-gray-700]="selectedGroupId() !== group.id"
                                     [class.opacity-50]="group.isPaid">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="font-bold text-sm text-white">{{ group.name }}</span>
                                        @if(group.isPaid) {
                                            <span class="text-[10px] bg-green-500/20 text-green-400 px-2 py-0.5 rounded">PAGO</span>
                                        } @else {
                                            <span class="font-bold text-sm text-blue-400">{{ group.total | currency:'BRL' }}</span>
                                        }
                                    </div>
                                    @for(item of group.items; track item.id) {
                                        <p class="text-[10px] text-gray-400 pl-2 border-l-2 border-gray-600 mb-1" (click)="$event.stopPropagation(); moveItemToUnassigned(item, group.id)">
                                            {{item.quantity}}x {{item.name}}
                                        </p>
                                    }
                                </div>
                            }
                        </div>
                        <button (click)="addGroup()" class="w-full mt-2 py-2 border border-dashed border-gray-600 text-gray-400 text-xs rounded-lg hover:border-blue-500 hover:text-blue-500 transition-colors">+ Adicionar Pessoa</button>
                    </div>
                </div>
            }
        </div>

        <!-- Totals Summary -->
        <div class="p-4 bg-gray-800 border-t border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <span class="text-gray-400 text-sm">Subtotal</span>
                <span class="text-white font-medium">{{ displaySubtotal() | currency:'BRL' }}</span>
            </div>
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <span class="text-gray-400 text-sm">Serviço (10%)</span>
                    <button (click)="toggleServiceFee()" [class.bg-green-600]="isServiceFeeToggleOn()" [class.bg-gray-600]="!isServiceFeeToggleOn()" class="w-8 h-4 rounded-full relative transition-colors">
                        <div class="absolute top-0.5 w-3 h-3 bg-white rounded-full transition-transform" [class.left-4.5]="isServiceFeeToggleOn()" [class.left-0.5]="!isServiceFeeToggleOn()"></div>
                    </button>
                </div>
                <span class="text-white font-medium">{{ displayTipAmount() | currency:'BRL' }}</span>
            </div>
            <div class="flex justify-between items-center pt-3 border-t border-gray-700">
                <span class="text-white font-bold text-lg">Total a Pagar</span>
                <span class="text-blue-400 font-black text-2xl">{{ displayTotal() | currency:'BRL' }}</span>
            </div>
            
            @if(splitMode() === 'total') {
                <div class="mt-3 flex items-center justify-between bg-gray-900 rounded-lg p-2">
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-gray-500">group</span>
                        <span class="text-xs text-gray-400">Dividir por:</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button (click)="splitCount.set(Math.max(1, splitCount() - 1))" class="w-6 h-6 bg-gray-700 rounded text-white">-</button>
                        <span class="text-white font-bold">{{ splitCount() }}</span>
                        <button (click)="splitCount.set(splitCount() + 1)" class="w-6 h-6 bg-gray-700 rounded text-white">+</button>
                    </div>
                    <span class="text-green-400 font-bold text-sm">{{ splitTotalPerPerson() | currency:'BRL' }}</span>
                </div>
            }
        </div>
    </div>

    <!-- RIGHT SIDE: Calculator & Payment Methods -->
    <div class="w-1/2 bg-gray-900 p-6 flex flex-col">
        <!-- Amount Input -->
        <div class="bg-gray-800 rounded-2xl p-4 mb-4 border border-gray-700 flex flex-col items-end">
            <span class="text-gray-400 text-xs uppercase font-bold mb-1">Valor Recebido</span>
            <div class="text-4xl font-mono font-bold text-white flex items-center gap-1">
                <span class="text-2xl text-gray-500">R$</span>
                <input 
                    type="text" 
                    [value]="paymentAmountInput()" 
                    readonly 
                    class="bg-transparent text-right w-full outline-none placeholder-gray-600" 
                    placeholder="0.00"
                >
            </div>
            @if(balanceDue() > 0) {
                <div class="text-xs text-red-400 mt-1 font-semibold">Faltam: {{ balanceDue() | currency:'BRL' }}</div>
            }
        </div>

        <!-- Suggestion Chips -->
        <div class="flex gap-2 mb-4 overflow-x-auto pb-1 hide-scrollbar">
            @for(amount of suggestedAmounts(); track amount) {
                <button (click)="paymentAmountInput.set(amount.toFixed(2))" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded-full text-white font-bold text-sm whitespace-nowrap transition-colors">
                    {{ amount | currency:'BRL' }}
                </button>
            }
        </div>

        <!-- Keypad & Methods Grid -->
        <div class="flex-1 grid grid-cols-4 gap-3">
            <!-- Numeric Keypad (Cols 1-3) -->
            <div class="col-span-3 grid grid-cols-3 gap-3">
                <button (click)="appendDigit('7')" class="bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold rounded-xl shadow-sm transition-all active:scale-95">7</button>
                <button (click)="appendDigit('8')" class="bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold rounded-xl shadow-sm transition-all active:scale-95">8</button>
                <button (click)="appendDigit('9')" class="bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold rounded-xl shadow-sm transition-all active:scale-95">9</button>
                
                <button (click)="appendDigit('4')" class="bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold rounded-xl shadow-sm transition-all active:scale-95">4</button>
                <button (click)="appendDigit('5')" class="bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold rounded-xl shadow-sm transition-all active:scale-95">5</button>
                <button (click)="appendDigit('6')" class="bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold rounded-xl shadow-sm transition-all active:scale-95">6</button>
                
                <button (click)="appendDigit('1')" class="bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold rounded-xl shadow-sm transition-all active:scale-95">1</button>
                <button (click)="appendDigit('2')" class="bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold rounded-xl shadow-sm transition-all active:scale-95">2</button>
                <button (click)="appendDigit('3')" class="bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold rounded-xl shadow-sm transition-all active:scale-95">3</button>
                
                <button (click)="clearInput()" class="bg-red-900/30 hover:bg-red-900/50 text-red-400 font-bold rounded-xl transition-all">C</button>
                <button (click)="appendDigit('0')" class="bg-gray-800 hover:bg-gray-700 text-white text-2xl font-bold rounded-xl shadow-sm transition-all active:scale-95">0</button>
                <button (click)="backspace()" class="bg-gray-800 hover:bg-gray-700 text-white rounded-xl transition-all"><span class="material-symbols-outlined">backspace</span></button>
            </div>

            <!-- Methods (Col 4) -->
            <div class="flex flex-col gap-2">
                <button (click)="selectedPaymentMethod.set('Dinheiro')" [class.ring-2]="selectedPaymentMethod() === 'Dinheiro'" class="flex-1 bg-green-900/30 hover:bg-green-900/50 text-green-400 border border-green-800 rounded-xl flex flex-col items-center justify-center gap-1 transition-all ring-green-500">
                    <span class="material-symbols-outlined">payments</span>
                    <span class="text-[10px] font-bold uppercase">Dinheiro</span>
                </button>
                <button (click)="selectedPaymentMethod.set('Cartão de Crédito')" [class.ring-2]="selectedPaymentMethod() === 'Cartão de Crédito'" class="flex-1 bg-blue-900/30 hover:bg-blue-900/50 text-blue-400 border border-blue-800 rounded-xl flex flex-col items-center justify-center gap-1 transition-all ring-blue-500">
                    <span class="material-symbols-outlined">credit_card</span>
                    <span class="text-[10px] font-bold uppercase">Crédito</span>
                </button>
                <button (click)="selectedPaymentMethod.set('Cartão de Débito')" [class.ring-2]="selectedPaymentMethod() === 'Cartão de Débito'" class="flex-1 bg-cyan-900/30 hover:bg-cyan-900/50 text-cyan-400 border border-cyan-800 rounded-xl flex flex-col items-center justify-center gap-1 transition-all ring-cyan-500">
                    <span class="material-symbols-outlined">credit_score</span>
                    <span class="text-[10px] font-bold uppercase">Débito</span>
                </button>
                <button (click)="selectedPaymentMethod.set('PIX')" [class.ring-2]="selectedPaymentMethod() === 'PIX'" class="flex-1 bg-purple-900/30 hover:bg-purple-900/50 text-purple-400 border border-purple-800 rounded-xl flex flex-col items-center justify-center gap-1 transition-all ring-purple-500">
                    <span class="material-symbols-outlined">qr_code_2</span>
                    <span class="text-[10px] font-bold uppercase">PIX</span>
                </button>
            </div>
        </div>

        <!-- Add Payment Button -->
        <button (click)="addPayment()" class="w-full mt-4 py-4 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-xl text-lg shadow-lg flex items-center justify-center gap-2 transition-all active:scale-[0.98]"
                [disabled]="!paymentAmountInput()">
            <span>Adicionar Pagamento</span>
            <span class="material-symbols-outlined">add_circle</span>
        </button>

        <!-- Payments List -->
        @if(payments().length > 0) {
            <div class="mt-4 bg-gray-800 rounded-xl p-3 max-h-32 overflow-y-auto">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs text-gray-400 font-bold uppercase">Pagamentos Realizados</span>
                    <span class="text-xs text-green-400 font-bold">Total: {{ totalPaid() | currency:'BRL' }}</span>
                </div>
                @for(p of payments(); track $index) {
                    <div class="flex justify-between items-center text-sm py-1 border-b border-gray-700/50 last:border-0">
                        <span class="text-gray-300">{{ p.method }}</span>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-white">{{ p.amount | currency:'BRL' }}</span>
                            <button (click)="removePayment($index)" class="text-red-500 hover:text-white"><span class="material-symbols-outlined text-sm">close</span></button>
                        </div>
                    </div>
                }
                @if(change() > 0) {
                    <div class="flex justify-between items-center text-sm py-1 mt-1 text-yellow-300 font-bold">
                        <span>Troco</span>
                        <span>{{ change() | currency:'BRL' }}</span>
                    </div>
                }
            </div>
        }

        <!-- Finalize Button -->
        <button (click)="finalizePayment()" 
                [disabled]="!isPaymentComplete()" 
                class="w-full mt-4 py-4 bg-green-600 hover:bg-green-500 text-white font-black text-xl rounded-xl shadow-lg shadow-green-900/40 transition-all active:scale-[0.98] disabled:bg-gray-700 disabled:text-gray-500 disabled:shadow-none disabled:cursor-not-allowed">
            FINALIZAR VENDA
        </button>

    </div>
  </div>
</div>
