
<div class="h-full flex flex-col" (click)="closeContextMenu()">
  <!-- Header -->
  <header class="flex-shrink-0 bg-gray-800 shadow-md z-10 no-print">
    <div class="flex flex-col">
        <!-- Top Bar: Logo & Main Toggle & Actions -->
        <div class="flex justify-between items-center p-3 border-b border-gray-700">
            <div class="flex items-center gap-3">
                 <div class="bg-gray-900/50 p-1 rounded-lg flex gap-1">
                    <button (click)="toggleViewMode('tables')" class="px-3 py-1.5 rounded-md text-xs font-bold flex items-center gap-1 transition-colors" [class.bg-blue-600]="viewMode() === 'tables'" [class.text-white]="viewMode() === 'tables'" [class.text-gray-400]="viewMode() !== 'tables'">
                        <span class="material-symbols-outlined text-base">table_restaurant</span>
                        <span class="hidden sm:inline">Mesas</span>
                    </button>
                    <button (click)="toggleViewMode('tabs')" class="px-3 py-1.5 rounded-md text-xs font-bold flex items-center gap-1 transition-colors" [class.bg-blue-600]="viewMode() === 'tabs'" [class.text-white]="viewMode() === 'tabs'" [class.text-gray-400]="viewMode() !== 'tabs'">
                        <span class="material-symbols-outlined text-base">id_card</span>
                        <span class="hidden sm:inline">Comandas</span>
                    </button>
                </div>
            </div>

            <!-- Right Actions -->
             <div class="flex items-center gap-2">
                @if(viewMode() === 'tables') {
                    <!-- Edit Layout (Icon Only on Mobile) -->
                    <button (click)="isEditMode.set(!isEditMode())"
                        class="p-2 rounded-md transition-colors"
                        [class.bg-yellow-600]="isEditMode()"
                        [class.text-white]="isEditMode()"
                        [class.bg-gray-700]="!isEditMode()"
                        [class.hover:bg-gray-600]="!isEditMode()"
                        title="Editar Layout">
                        <span class="material-symbols-outlined text-lg">dashboard_customize</span>
                    </button>
                    <!-- Manage Halls (Icon Only) -->
                     <button (click)="isHallManagerOpen.set(true)" class="p-2 rounded-md bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white transition-colors" title="Gerenciar Salões">
                        <span class="material-symbols-outlined text-lg">meeting_room</span>
                    </button>
                }
            </div>
        </div>
        
        <!-- Bottom Bar: Hall Selector (Scrollable) -->
        @if(viewMode() === 'tables') {
            <div class="flex items-center gap-2 overflow-x-auto hide-scrollbar px-3 py-2 bg-gray-900/30">
                @for(hall of halls(); track hall.id) {
                    <button 
                    (click)="selectHall(hall)"
                    class="px-4 py-1.5 text-xs font-bold rounded-full transition-colors whitespace-nowrap border"
                    [class.bg-gray-700]="selectedHall()?.id === hall.id"
                    [class.text-white]="selectedHall()?.id === hall.id"
                    [class.border-gray-500]="selectedHall()?.id === hall.id"
                    [class.text-gray-400]="selectedHall()?.id !== hall.id"
                    [class.border-gray-700]="selectedHall()?.id !== hall.id"
                    [class.hover:bg-gray-700/50]="selectedHall()?.id !== hall.id">
                    {{ hall.name }}
                    </button>
                }
                 @if(halls().length === 0) {
                     <span class="text-xs text-gray-500 italic px-2">Sem salões.</span>
                 }
            </div>
        }
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 flex overflow-hidden relative">
    <div class="flex-1 overflow-auto bg-gray-900/50">
        @if (viewMode() === 'tables') {
            @if (selectedHall(); as hall) {
                <div class="p-4 h-full">
                    <app-table-layout 
                    [hall]="hall"
                    [hallIndex]="selectedHallIndex()"
                    [tables]="tables()"
                    [isEditMode]="isEditMode()"
                    [employeeNameMap]="employeeNameMap()"
                    [selectedTable]="selectedTable()"
                    (tableClicked)="handleTableClicked($event)"
                    (tableRightClicked)="handleTableRightClick($event)">
                    </app-table-layout>
                </div>
            } @else {
                <div class="flex items-center justify-center h-full">
                    <div class="text-center text-gray-500">
                        <p>Nenhum salão selecionado.</p>
                        <button (click)="isHallManagerOpen.set(true)" class="mt-2 text-blue-400 hover:underline">
                            Criar Salão
                        </button>
                    </div>
                </div>
            }
        } @else {
            <app-command-grid (openTabClicked)="handleTabSelected($event)"></app-command-grid>
        }
    </div>

    <!-- Order Panel: Overlay on mobile, sidebar on desktop -->
    @if (isOrderPanelOpen()) {
      <!-- Mobile: Full screen overlay -->
      <div class="md:hidden fixed inset-0 bg-gray-900 z-30">
        <app-order-panel
          [selectedTable]="selectedTable()"
          [currentOrder]="activeOrder()"
          [orderError]="orderError()"
          [activeEmployee]="activeEmployee()"
          (closePanel)="closeOrderPanel()"
          (checkoutStarted)="handleCheckoutStarted()"
          (moveOrderClicked)="openMoveModal()"
          (releaseTable)="handleReleaseTable()"
          (customerCountChanged)="handleCustomerCountChanged($event)"
          (associateCustomerClicked)="isCustomerSelectModalOpen.set(true)"
          (removeCustomerAssociationClicked)="handleRemoveCustomerAssociation()"
          (redeemRewardClicked)="isRedeemModalOpen.set(true)">
        </app-order-panel>
      </div>

      <!-- Desktop: Side panel -->
      <div class="hidden md:block w-full md:w-3/5 lg:w-1/2 xl:w-[600px] border-l-2 border-gray-700 shadow-2xl relative z-20">
        <app-order-panel
          [selectedTable]="selectedTable()"
          [currentOrder]="activeOrder()"
          [orderError]="orderError()"
          [activeEmployee]="activeEmployee()"
          (closePanel)="closeOrderPanel()"
          (checkoutStarted)="handleCheckoutStarted()"
          (moveOrderClicked)="openMoveModal()"
          (releaseTable)="handleReleaseTable()"
          (customerCountChanged)="handleCustomerCountChanged($event)"
          (associateCustomerClicked)="isCustomerSelectModalOpen.set(true)"
          (removeCustomerAssociationClicked)="handleRemoveCustomerAssociation()"
          (redeemRewardClicked)="isRedeemModalOpen.set(true)">
        </app-order-panel>
      </div>
    }
  </main>
</div>

<!-- Modals -->
@if (isHallManagerOpen()) {
  <app-hall-manager-modal (closeModal)="isHallManagerOpen.set(false)"></app-hall-manager-modal>
}

@if (isPreBillModalOpen()) {
  <app-pre-bill-modal
    [order]="activeOrder()"
    [table]="contextMenuTable()"
    (closeModal)="isPreBillModalOpen.set(false)">
  </app-pre-bill-modal>
}

@if (isMoveModalOpen()) {
  <app-move-order-modal
    [sourceTable]="sourceTableForModals()"
    [availableTables]="availableTablesForMove()"
    (closeModal)="closeMoveModal()"
    (moveOrder)="moveOrder($event)">
  </app-move-order-modal>
}

@if (isCustomerSelectModalOpen()) {
  <app-customer-select-modal
    (closeModal)="isCustomerSelectModalOpen.set(false)"
    (customerSelected)="handleCustomerSelected($event)">
  </app-customer-select-modal>
}

@if (isRedeemModalOpen()) {
  <app-redeem-reward-modal
    [customer]="customerForModals()"
    [orderId]="orderIdForModals()"
    (closeModal)="isRedeemModalOpen.set(false)">
  </app-redeem-reward-modal>
}


<!-- Context Menu for Tables -->
@if(isContextMenuOpen()) {
  <div 
    class="fixed z-50 bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-56 text-sm py-2"
    [style.left.px]="contextMenuPosition().x"
    [style.top.px]="contextMenuPosition().y"
    (click)="$event.stopPropagation()">
      <div class="px-3 py-2 border-b border-gray-700">
          <p class="font-bold text-white">Mesa {{ contextMenuTable()?.number }}</p>
          @if(activeOrder()?.customers?.name; as customerName) {
            <p class="text-xs text-blue-300">{{ customerName }}</p>
          }
      </div>
      <ul class="text-gray-300">
          <li>
              <button (click)="handlePrintPreBill()" class="w-full text-left flex items-center gap-3 px-3 py-2 hover:bg-gray-700 hover:text-white">
                  <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6 3.129M6.72 13.829L6 3.129m0 10.7a48.45 48.45 0 0112 0m-12 0v.042m12 0v-.042m0 10.704l.72-10.7M17.28 13.829c.24.03.48.062.72.096m-.72-.096L18 3.129m-1.2 10.7l.72-10.7m0 10.7a48.45 48.45 0 00-12 0m12 0v.042m-12 0v-.042" /></svg>
                  <span>Imprimir Pré-conta</span>
              </button>
          </li>
          <li>
              <button (click)="openMoveModal()" class="w-full text-left flex items-center gap-3 px-3 py-2 hover:bg-gray-700 hover:text-white">
                 <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" /></svg>
                  <span>Mover Pedido</span>
              </button>
          </li>
      </ul>
  </div>
}
