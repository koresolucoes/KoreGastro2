<div class="flex flex-col h-full bg-gray-800 relative">
    @if (selectedTable(); as table) {
      <!-- Header -->
      <div class="p-4 border-b border-gray-700 flex-shrink-0 space-y-3">
        <div class="flex justify-between items-start">
          <div>
            <h2 class="text-xl font-bold text-white">Mesa {{ table.number }}</h2>
            <div class="flex items-center gap-2 mt-2">
                <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
                <input 
                    type="number"
                    [value]="table.customer_count || 1"
                    (change)="onCustomerCountChange($event)"
                    min="1"
                    class="bg-gray-700 text-white font-semibold rounded-md px-2 py-0.5 w-16 text-center focus:outline-none focus:ring-2 focus:ring-blue-500"
                    title="Número de clientes na mesa"
                >
            </div>
          </div>
          <button (click)="closePanel.emit()" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white">
             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
          </button>
        </div>
        <!-- Customer Section -->
        <div>
          @if(currentOrder()?.customers; as customer) {
            <div class="bg-gray-700/50 p-2 rounded-lg flex flex-col gap-2">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
                        <span class="font-semibold text-white">{{ customer.name }}</span>
                    </div>
                    <div class="flex items-center gap-1">
                      <button (click)="associateCustomerClicked.emit()" class="text-xs text-gray-400 hover:text-white p-1 rounded-md">Trocar</button>
                      <button (click)="removeCustomerAssociationClicked.emit()" class="text-xs text-red-400 hover:text-white p-1 rounded-md">X</button>
                    </div>
                </div>
                <button (click)="redeemRewardClicked.emit()" [disabled]="!hasCustomer()" class="w-full text-center py-2 px-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-semibold text-sm transition-colors flex items-center justify-center gap-2 disabled:bg-gray-600 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-5.25h5.25M7.5 15h3M3.375 5.25c-.621 0-1.125.504-1.125 1.125v3.026a2.999 2.999 0 010 5.198v3.026c0 .621.504 1.125 1.125 1.125h17.25c.621 0 1.125-.504 1.125-1.125v-3.026a2.999 2.999 0 010-5.198V6.375c0-.621-.504-1.125-1.125-1.125H3.375z" /></svg>
                    Resgatar Prêmio
                </button>
            </div>
          } @else {
            <button (click)="associateCustomerClicked.emit()" class="w-full text-center py-2 px-3 bg-gray-700/50 hover:bg-gray-700 text-blue-400 rounded-lg font-semibold text-sm transition-colors flex items-center justify-center gap-2">
              <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z" /></svg>
              Associar Cliente
            </button>
          }
        </div>
      </div>

      <!-- Main Content Area: Menu and Cart -->
      <div class="flex-1 flex flex-col md:flex-row gap-4 p-4 pb-24 md:pb-4 overflow-hidden">
        @if (currentOrder()) {
            <!-- Left Side: Menu (Full width on mobile) -->
            <div class="w-full md:w-1/2 lg:w-3/5 flex flex-col gap-4 min-h-0">
                <!-- Search -->
                <div class="relative flex-shrink-0">
                    <input type="text" [value]="recipeSearchTerm()" (input)="recipeSearchTerm.set($any($event.target).value)" placeholder="Buscar item..." class="w-full bg-gray-700 border border-gray-600 rounded-lg pl-10 pr-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>
                </div>
                <!-- Categories -->
                <div class="flex-shrink-0 sticky top-0 bg-gray-800 py-2 z-10">
                    <div class="flex space-x-3 overflow-x-auto pb-2 hide-scrollbar">
                      <button (click)="selectCategory(null)" class="flex flex-col items-center gap-2 flex-shrink-0 w-20">
                          <div class="w-16 h-16 rounded-lg flex items-center justify-center transition-all" [class.bg-blue-600]="selectedCategory() === null" [class.bg-gray-700]="selectedCategory() !== null" [class.ring-2]="selectedCategory() === null" [class.ring-blue-400]="selectedCategory() === null">
                              <span class="material-symbols-outlined text-2xl">restaurant</span>
                          </div>
                          <span class="text-xs font-semibold" [class.text-white]="selectedCategory() === null" [class.text-gray-400]="selectedCategory() !== null">Todas</span>
                      </button>
                      @for (category of categories(); track category.id) {
                        <button (click)="selectCategory(category)" class="flex flex-col items-center gap-2 flex-shrink-0 w-20">
                            <img [src]="category.image_url || 'https://picsum.photos/200?food,'+category.name" [alt]="category.name" class="w-16 h-16 rounded-lg object-cover transition-all" [class.ring-2]="selectedCategory()?.id === category.id" [class.ring-blue-400]="selectedCategory()?.id === category.id">
                            <span class="text-xs font-semibold w-full truncate" [class.text-white]="selectedCategory()?.id === category.id" [class.text-gray-400]="selectedCategory()?.id !== category.id">{{ category.name }}</span>
                        </button>
                      }
                    </div>
                </div>
                <!-- Menu Items -->
                <div class="flex-1 overflow-y-auto pr-2 -mr-2">
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        @for (recipe of filteredRecipes(); track recipe.id) {
                            <div 
                                (click)="addToCart(recipe)" 
                                class="bg-gray-700 rounded-lg text-center flex flex-col justify-between h-32 transition-opacity relative group"
                                [class.cursor-pointer]="recipe.hasStock"
                                [class.hover:bg-gray-600]="recipe.hasStock"
                                [class.opacity-50]="!recipe.hasStock"
                                [class.pointer-events-none]="!recipe.hasStock"
                                [title]="!recipe.hasStock ? 'Sem estoque' : ''">
                                
                                <img [src]="recipe.image_url || 'https://picsum.photos/200?food,'+recipe.name" [alt]="recipe.name" class="w-full h-20 object-cover rounded-t-lg">
                                
                                <div class="p-2 flex flex-col flex-1 justify-center">
                                    <p class="font-semibold text-xs leading-tight flex-1 flex items-center justify-center">{{ recipe.name }}</p>
                                    <div class="flex justify-end items-baseline">
                                      <p class="text-sm font-bold text-green-400">{{ (recipePrices().get(recipe.id) || recipe.price) | currency:'BRL' }}</p>
                                    </div>
                                </div>
                                
                                @if (cartItemQuantities().get(recipe.id); as qty) {
                                  <div class="absolute inset-0 bg-black/70 rounded-lg flex items-center justify-center gap-2">
                                      <button (click)="$event.stopPropagation(); decrementFromCart(recipe)" class="w-8 h-8 flex items-center justify-center rounded-full bg-red-600 text-white font-bold text-lg">-</button>
                                      <span class="text-2xl font-bold text-white">{{ qty }}</span>
                                      <button (click)="$event.stopPropagation(); addToCart(recipe)" class="w-8 h-8 flex items-center justify-center rounded-full bg-green-600 text-white font-bold text-lg">+</button>
                                  </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
            <!-- Right Side: Order Summary (Desktop Only) -->
            <div class="hidden md:flex w-full md:w-1/2 lg:w-2/5 flex-col gap-4 min-h-0">
              <h3 class="text-lg font-bold text-white flex-shrink-0">Resumo do Pedido</h3>
              <!-- Cart Items -->
              <div class="flex-1 overflow-y-auto pr-2 -mr-2 space-y-3">
                <!-- Items already in order -->
                @for (item of groupedOrderItems(); track (item.isGroup ? item.groupId : item.item.id)) {
                  <div class="bg-gray-700/50 p-3 rounded-lg text-sm">
                    <div class="flex justify-between items-start">
                      <div>
                        <p class="font-semibold text-white">{{ item.isGroup ? item.quantity + 'x ' + item.recipeName : item.item.quantity + 'x ' + item.item.name }}</p>
                        @if (item.hasDiscount) {
                          <p class="text-xs text-gray-400 line-through">{{ item.originalTotalPrice | currency:'BRL' }}</p>
                        }
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="font-bold text-white">{{ (item.isGroup ? item.totalPrice : item.item.price * item.item.quantity) | currency:'BRL' }}</span>
                        <button (click)="openDiscountModal(item)" class="text-gray-400 hover:text-white p-1" title="Aplicar desconto">
                          <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3.5A1.5 1.5 0 014.5 2h6.879a1.5 1.5 0 011.06.44l5.854 5.853a1.5 1.5 0 010 2.122l-5.853 5.853a1.5 1.5 0 01-1.06.44H4.5A1.5 1.5 0 013 16.5v-13z" /><path d="M6.5 6.5a1 1 0 100-2 1 1 0 000 2z" /></svg>
                        </button>
                      </div>
                    </div>
                    <div class="text-xs mt-1" [class.text-yellow-400]="item.isGroup ? getOrderItemStatusClass(item.items[0].status) === 'text-yellow-400' : getOrderItemStatusClass(item.item.status) === 'text-yellow-400'">
                      {{ item.isGroup ? item.items[0].status : item.item.status }}
                    </div>
                    @if (item.isGroup ? item.items[0].notes : item.item.notes) {
                      <p class="text-xs italic text-yellow-200 mt-1">"{{ item.isGroup ? item.items[0].notes : item.item.notes }}"</p>
                    }
                  </div>
                }
                <!-- Items in shopping cart -->
                @for (item of shoppingCart(); track item.id) {
                  <div class="bg-blue-900/40 p-3 rounded-lg text-sm border border-blue-800">
                    <div class="flex justify-between items-start">
                      <p class="font-semibold text-white">{{ item.quantity }}x {{ item.recipe.name }}</p>
                      <span class="font-bold text-white">{{ (recipePrices().get(item.recipe.id)! * item.quantity) | currency:'BRL' }}</span>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <div class="flex items-center gap-2">
                           <button (click)="updateCartItemQuantity(item.id, -1)" class="w-6 h-6 bg-gray-600 rounded-full">-</button>
                           <button (click)="updateCartItemQuantity(item.id, 1)" class="w-6 h-6 bg-gray-600 rounded-full">+</button>
                           <button (click)="openNotesModal(item)" class="text-xs text-gray-400 hover:text-white p-1 rounded-md">Adicionar Nota</button>
                        </div>
                        <button (click)="removeFromCart(item.id)" class="text-red-400 hover:text-red-300 p-1">Remover</button>
                    </div>
                    @if (item.notes) {
                      <p class="text-xs italic text-yellow-200 mt-2 pt-2 border-t border-blue-800/50">"{{ item.notes }}"</p>
                    }
                  </div>
                }
              </div>
              <!-- Totals and Actions -->
              <div class="mt-auto pt-4 border-t border-gray-700 flex-shrink-0">
                <div class="flex justify-between items-center mb-4">
                  <span class="text-2xl font-bold text-white">Total</span>
                  <span class="text-2xl font-bold text-white">{{ orderTotal() | currency:'BRL' }}</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <button (click)="sendOrder()" [disabled]="shoppingCart().length === 0" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-500 transition-colors disabled:bg-gray-600 disabled:cursor-not-allowed">Enviar Pedido</button>
                  <button (click)="startCheckout()" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-500 transition-colors">Fechar Conta</button>
                </div>
                 <div class="grid grid-cols-2 gap-2 mt-2">
                   <button (click)="moveOrderClicked.emit()" class="w-full bg-gray-600 text-white font-medium py-2 rounded-lg hover:bg-gray-500 transition-colors text-sm">Mover Mesa</button>
                   <button (click)="releaseTable.emit()" class="w-full bg-gray-600 text-white font-medium py-2 rounded-lg hover:bg-gray-500 transition-colors text-sm">Liberar Mesa</button>
                 </div>
              </div>
            </div>
        } @else if (orderError()) {
            <div class="m-auto text-center text-red-400">
                <p>Ocorreu um erro ao carregar o pedido.</p>
                <p class="text-sm text-gray-500">{{ orderError() }}</p>
            </div>
        } @else {
            <div class="m-auto text-center text-gray-500">
                <p>Carregando pedido...</p>
            </div>
        }
      </div>

      <!-- Mobile Floating Cart Bar -->
      @if (currentOrder()) {
        <div class="md:hidden fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-700 p-3 shadow-lg z-20">
          <button (click)="isCartVisible.set(true)" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg flex justify-between items-center">
            <span>
              {{ totalCartItems() }} {{ totalCartItems() === 1 ? 'item' : 'itens' }} no carrinho
            </span>
            <span>
              Ver Pedido ({{ orderTotal() | currency:'BRL' }})
            </span>
          </button>
        </div>
      }

      <!-- Mobile Sliding Cart Panel -->
      @if (isCartVisible()) {
        <div class="md:hidden fixed inset-0 bg-black/70 z-40" (click)="isCartVisible.set(false)">
          <div class="absolute bottom-0 left-0 right-0 bg-gray-800 rounded-t-2xl max-h-[80vh] flex flex-col" (click)="$event.stopPropagation()">
            <!-- Panel Header -->
            <div class="p-4 border-b border-gray-700 flex justify-between items-center flex-shrink-0">
              <h3 class="text-xl font-bold text-white">Resumo do Pedido</h3>
              <button (click)="isCartVisible.set(false)" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"></path></svg>
              </button>
            </div>
            
            <!-- Panel Content -->
            <div class="flex-1 flex flex-col gap-4 min-h-0 p-4">
              <!-- Cart Items -->
              <div class="flex-1 overflow-y-auto pr-2 -mr-2 space-y-3">
                @for (item of groupedOrderItems(); track (item.isGroup ? item.groupId : item.item.id)) {
                  <div class="bg-gray-700/50 p-3 rounded-lg text-sm">
                    <div class="flex justify-between items-start">
                      <div>
                        <p class="font-semibold text-white">{{ item.isGroup ? item.quantity + 'x ' + item.recipeName : item.item.quantity + 'x ' + item.item.name }}</p>
                        @if (item.hasDiscount) {
                          <p class="text-xs text-gray-400 line-through">{{ item.originalTotalPrice | currency:'BRL' }}</p>
                        }
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="font-bold text-white">{{ (item.isGroup ? item.totalPrice : item.item.price * item.item.quantity) | currency:'BRL' }}</span>
                        <button (click)="openDiscountModal(item)" class="text-gray-400 hover:text-white p-1" title="Aplicar desconto">
                          <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3.5A1.5 1.5 0 014.5 2h6.879a1.5 1.5 0 011.06.44l5.854 5.853a1.5 1.5 0 010 2.122l-5.853 5.853a1.5 1.5 0 01-1.06.44H4.5A1.5 1.5 0 013 16.5v-13z" /><path d="M6.5 6.5a1 1 0 100-2 1 1 0 000 2z" /></svg>
                        </button>
                      </div>
                    </div>
                    <div class="text-xs mt-1" [class.text-yellow-400]="item.isGroup ? getOrderItemStatusClass(item.items[0].status) === 'text-yellow-400' : getOrderItemStatusClass(item.item.status) === 'text-yellow-400'">
                      {{ item.isGroup ? item.items[0].status : item.item.status }}
                    </div>
                    @if (item.isGroup ? item.items[0].notes : item.item.notes) {
                      <p class="text-xs italic text-yellow-200 mt-1">"{{ item.isGroup ? item.items[0].notes : item.item.notes }}"</p>
                    }
                  </div>
                }
                @for (item of shoppingCart(); track item.id) {
                  <div class="bg-blue-900/40 p-3 rounded-lg text-sm border border-blue-800">
                    <div class="flex justify-between items-start">
                      <p class="font-semibold text-white">{{ item.quantity }}x {{ item.recipe.name }}</p>
                      <span class="font-bold text-white">{{ (recipePrices().get(item.recipe.id)! * item.quantity) | currency:'BRL' }}</span>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <div class="flex items-center gap-2">
                           <button (click)="updateCartItemQuantity(item.id, -1)" class="w-6 h-6 bg-gray-600 rounded-full">-</button>
                           <button (click)="updateCartItemQuantity(item.id, 1)" class="w-6 h-6 bg-gray-600 rounded-full">+</button>
                           <button (click)="openNotesModal(item)" class="text-xs text-gray-400 hover:text-white p-1 rounded-md">Adicionar Nota</button>
                        </div>
                        <button (click)="removeFromCart(item.id)" class="text-red-400 hover:text-red-300 p-1">Remover</button>
                    </div>
                    @if (item.notes) {
                      <p class="text-xs italic text-yellow-200 mt-2 pt-2 border-t border-blue-800/50">"{{ item.notes }}"</p>
                    }
                  </div>
                }
              </div>
              <!-- Totals and Actions -->
              <div class="mt-auto pt-4 border-t border-gray-700 flex-shrink-0">
                <div class="flex justify-between items-center mb-4">
                  <span class="text-2xl font-bold text-white">Total</span>
                  <span class="text-2xl font-bold text-white">{{ orderTotal() | currency:'BRL' }}</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <button (click)="sendOrder()" [disabled]="shoppingCart().length === 0" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-500 transition-colors disabled:bg-gray-600 disabled:cursor-not-allowed">Enviar Pedido</button>
                  <button (click)="startCheckout()" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-500 transition-colors">Fechar Conta</button>
                </div>
                 <div class="grid grid-cols-2 gap-2 mt-2">
                   <button (click)="moveOrderClicked.emit()" class="w-full bg-gray-600 text-white font-medium py-2 rounded-lg hover:bg-gray-500 transition-colors text-sm">Mover Mesa</button>
                   <button (click)="releaseTable.emit()" class="w-full bg-gray-600 text-white font-medium py-2 rounded-lg hover:bg-gray-500 transition-colors text-sm">Liberar Mesa</button>
                 </div>
              </div>
            </div>
          </div>
        </div>
      }
    } @else {
      <!-- Fallback when no table is selected -->
       <div class="m-auto text-center text-gray-500">
         <p>Selecione uma mesa para começar.</p>
       </div>
    }
</div>
