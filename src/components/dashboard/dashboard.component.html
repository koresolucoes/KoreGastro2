<div class="p-4">
  <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-white">Painel de Controle</h1>
      <p class="text-gray-400">Bem-vindo de volta! Aqui está o resumo do seu negócio.</p>
    </div>
    <div class="flex items-center gap-4">
      <div class="flex space-x-1 bg-gray-700 p-1 rounded-lg">
        <button (click)="setPeriod('day')" class="px-3 py-1 text-sm rounded-md" [class.bg-blue-600]="period() === 'day'">Hoje</button>
        <button (click)="setPeriod('week')" class="px-3 py-1 text-sm rounded-md" [class.bg-blue-600]="period() === 'week'">Esta Semana</button>
        <button (click)="setPeriod('month')" class="px-3 py-1 text-sm rounded-md" [class.bg-blue-600]="period() === 'month'">Este Mês</button>
      </div>
      <button 
        (click)="toggleEditMode()" 
        class="flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium transition-colors"
        [class]="editMode() ? 'bg-green-600 text-white hover:bg-green-500' : 'bg-gray-700 text-gray-200 hover:bg-gray-600'"
      >
        <span class="material-symbols-outlined text-base">{{ editMode() ? 'save' : 'edit' }}</span>
        {{ editMode() ? 'Salvar Layout' : 'Personalizar' }}
      </button>
    </div>
  </div>

  <div 
    cdkDropList 
    (cdkDropListDropped)="drop($event)" 
    class="mb-8 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6"
  >
    @for (widget of dashboardWidgets(); track widget.id) {
      
      @switch (widget.type) {
        
        @case ('kpi') {
          <div 
            cdkDrag 
            [cdkDragDisabled]="!editMode()"
            class="group relative overflow-hidden rounded-lg transition-all"
            [class.cursor-move]="editMode()"
            [class.border-2]="editMode()"
            [class.border-dashed]="editMode()"
            [class.border-blue-400]="editMode()"
          >
            <a 
              [routerLink]="getRouteForStat(widget.label)"
              class="block h-full bg-gray-800 p-4 rounded-lg hover:shadow-lg hover:border-gray-600 border border-gray-700/50"
              [class.cursor-pointer]="!editMode()"
              [class.pointer-events-none]="editMode()">
              
              @if (editMode()) {
                <div class="absolute right-2 top-2 z-10">
                  <span class="material-symbols-outlined text-blue-400">drag_indicator</span>
                </div>
              }
              <div class="flex items-start justify-between">
                <div>
                  <p class="text-sm font-medium text-gray-400">{{ widget.label }}</p>
                  <p class="mt-1 text-2xl font-bold text-white">{{ widget.value }}</p>

                  @if (hasComparison(widget.label)) {
                    <div class="mt-2 flex items-center text-xs">
                      @if (isPositiveComparison(widget.label)) {
                        <span class="material-symbols-outlined text-green-400 text-base">trending_up</span>
                      } @else {
                        <span class="material-symbols-outlined text-red-400 text-base">trending_down</span>
                      }
                      <span class="ml-1" [class.text-green-400]="isPositiveComparison(widget.label)" [class.text-red-400]="!isPositiveComparison(widget.label)">
                        {{ getComparisonText(widget.label) }}
                      </span>
                    </div>
                  }
                </div>
                <div class="rounded-full bg-gray-700/50 p-2">
                   <span class="material-symbols-outlined text-blue-400">{{ widget.icon }}</span>
                </div>
              </div>
            </a>
          </div>
        }

        @case ('chart_sales') {
          <a [routerLink]="['/reports']"
            cdkDrag 
            [cdkDragDisabled]="!editMode()"
            class="block rounded-lg bg-gray-800 p-4 shadow-lg col-span-1 sm:col-span-2 lg:col-span-3 xl:col-span-3 border border-gray-700/50 hover:border-gray-600 transition-colors"
            [class.cursor-pointer]="!editMode()"
            [class.cursor-move]="editMode()">
            <h2 class="mb-4 text-lg font-semibold text-white">{{ widget.title }}</h2>
            @if (isChartLoading()) {
              <div class="flex h-64 items-center justify-center">
                <div class="h-8 w-8 animate-spin rounded-full border-4 border-white border-t-transparent"></div>
              </div>
            } @else {
              <div class="h-64">
                <app-sales-cogs-chart [data]="salesCogsData()"></app-sales-cogs-chart>
              </div>
            }
          </a>
        }

        @case ('chart_hourly') {
          <a [routerLink]="['/reports']"
            cdkDrag 
            [cdkDragDisabled]="!editMode()"
            class="block rounded-lg bg-gray-800 p-4 shadow-lg text-white col-span-1 sm:col-span-2 lg:col-span-3 xl:col-span-3 border border-gray-700/50 hover:border-gray-600 transition-colors"
            [class.cursor-pointer]="!editMode()"
            [class.cursor-move]="editMode()">
            <h2 class="mb-4 text-lg font-semibold">{{ widget.title }}</h2>
            @if (isHourlyChartLoading()) {
              <div class="flex h-64 items-center justify-center">
                <div class="h-8 w-8 animate-spin rounded-full border-4 border-white border-t-transparent"></div>
              </div>
            } @else {
              <div class="h-64">
                <app-hourly-sales-chart [data]="hourlySalesData()"></app-hourly-sales-chart>
              </div>
            }
          </a>
        }
      }
    }
  </div>

  <div class="mt-6 grid grid-cols-1 gap-6 lg:grid-cols-2">
    <div class="overflow-hidden rounded-lg bg-gray-800 shadow border border-gray-700/50">
      <div class="border-b border-gray-700 bg-gray-700/50 px-4 py-3">
        <div class="flex items-center">
          <span class="material-symbols-outlined text-yellow-400 mr-2">inventory_2</span>
          <h3 class="text-sm font-medium text-yellow-300">Estoque Baixo</h3>
        </div>
      </div>
      <div class="p-4">
        @if (lowStockItemsList().length > 0) {
          <ul class="space-y-2">
            @for (item of lowStockItemsList(); track item.id) {
              <li class="flex items-center justify-between rounded-md bg-gray-700/50 p-2">
                <span class="text-sm font-medium text-gray-200">{{ item.name }}</span>
                <span class="rounded-full bg-yellow-900/50 px-2 py-1 text-xs font-medium text-yellow-300">
                  {{ item.stock }} {{ item.unit }}
                </span>
              </li>
            }
          </ul>
        } @else {
          <p class="text-sm text-gray-500 text-center py-4">Nenhum item com estoque baixo.</p>
        }
      </div>
    </div>

    <div class="overflow-hidden rounded-lg bg-gray-800 shadow border border-gray-700/50">
      <div class="border-b border-gray-700 bg-gray-700/50 px-4 py-3">
        <div class="flex items-center">
          <span class="material-symbols-outlined text-red-400 mr-2">person_off</span>
          <h3 class="text-sm font-medium text-red-300">Funcionários Ausentes (Hoje)</h3>
        </div>
      </div>
      <div class="p-4">
        @if (employeesOnLeaveToday().length > 0) {
          <ul class="space-y-2">
            @for (req of employeesOnLeaveToday(); track req.id) {
              <li class="flex items-center justify-between rounded-md bg-gray-700/50 p-2">
                <span class="text-sm font-medium text-gray-200">{{ req.employees?.name }}</span>
                <span class="rounded-full bg-red-900/50 px-2 py-1 text-xs font-medium text-red-300">
                  {{ req.request_type }}
                </span>
              </li>
            }
          </ul>
        } @else {
          <p class="text-sm text-gray-500 text-center py-4">Nenhum funcionário de folga ou férias hoje.</p>
        }
      </div>
    </div>
  </div>
</div>
