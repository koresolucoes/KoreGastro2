<div class="p-4">
  <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between">
    <div>
      <h1 class="text-2xl font-bold text-white">Painel de Controle</h1>
      <p class="text-white">Bem-vindo de volta! Aqui está o resumo do seu negócio hoje.</p>
    </div>
    <div class="mt-4 md:mt-0">
      <button 
        (click)="toggleEditMode()" 
        class="flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium transition-colors"
        [ngClass]="{
          'bg-blue-100 text-blue-700 hover:bg-blue-200': !editMode(),
          'bg-green-100 text-green-700 hover:bg-green-200': editMode()
        }"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.793.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
        </svg>
        {{ editMode() ? 'Salvar Layout' : 'Personalizar Dashboard' }}
      </button>
    </div>
  </div>

  <div 
    cdkDropList 
    (cdkDropListDropped)="drop($event)" 
    class="mb-8 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6"
  >
    @for (widget of dashboardWidgets(); track widget.id) {
      
      @switch (widget.type) {
        
        @case ('kpi') {
          <div 
            cdkDrag 
            [cdkDragDisabled]="!editMode()"
            class="group relative overflow-hidden rounded-lg transition-all hover:shadow-lg"
            [class.cursor-grab]="!editMode()"
            [class.cursor-move]="editMode()"
            [class.border-2]="editMode()"
            [class.border-dashed]="editMode()"
            [class.border-blue-400]="editMode()"
            [routerLink]="getRouteForStat(widget.label)"
            [class.cursor-pointer]="!editMode()"
          >
            @if (editMode()) {
              <div class="absolute right-2 top-2 z-10">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </div>
            }
            <div class="relative h-full rounded-lg bg-gradient-to-br from-blue-900 to-blue-700 p-4 text-white">
              <div class="flex items-start justify-between">
                <div>
                  <p class="text-sm font-medium opacity-90">{{ widget.label }}</p>
                  <p class="mt-1 text-2xl font-bold">{{ widget.value }}</p>

                  @if (hasComparison(widget.label)) {
                    <div class="mt-2 flex items-center text-xs">
                      @if (isPositiveComparison(widget.label)) {
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-300" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M12 7a1 1 0 01.707.293l4 4a1 1 0 01-1.414 1.414L12 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4A1 1 0 0112 7z" clip-rule="evenodd" />
                        </svg>
                      } @else {
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-300" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M12 13a1 1 0 01-.707-.293l-4-4a1 1 0 011.414-1.414L12 10.586l3.293-3.293a1 1 0 011.414 1.414l-4 4A1 1 0 0112 13z" clip-rule="evenodd" />
                        </svg>
                      }
                      <span class="ml-1">{{ getComparisonText(widget.label) }}</span>
                    </div>
                  }
                </div>
                <div class="rounded-full bg-white bg-opacity-20 p-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" [attr.d]="widget.icon" />
                  </svg>
                </div>
              </div>
            </div>
          </div>
        }

        @case ('chart_sales') {
          <div 
            cdkDrag 
            [cdkDragDisabled]="!editMode()"
            class="rounded-lg bg-gradient-to-br from-blue-900 to-blue-700 p-4 shadow-lg text-white col-span-1 sm:col-span-2 lg:col-span-3 xl:col-span-3"
          >
            <h2 class="mb-4 text-lg font-semibold">{{ widget.title }}</h2>
            @if (isChartLoading()) {
              <div class="flex h-64 items-center justify-center">
                <div class="h-8 w-8 animate-spin rounded-full border-4 border-white border-t-transparent"></div>
              </div>
            } @else {
              <div class="h-64">
                <app-sales-cogs-chart [data]="salesCogsData()"></app-sales-cogs-chart>
              </div>
            }
          </div>
        }

        @case ('chart_hourly') {
          <div 
            cdkDrag 
            [cdkDragDisabled]="!editMode()"
            class="rounded-lg bg-gradient-to-br from-blue-900 to-blue-700 p-4 shadow-lg text-white col-span-1 sm:col-span-2 lg:col-span-3 xl:col-span-3"
          >
            <h2 class="mb-4 text-lg font-semibold">{{ widget.title }}</h2>
            @if (isHourlyChartLoading()) {
              <div class="flex h-64 items-center justify-center">
                <div class="h-8 w-8 animate-spin rounded-full border-4 border-white border-t-transparent"></div>
              </div>
            } @else {
              <div class="h-64">
                <app-hourly-sales-chart [data]="hourlySalesData()"></app-hourly-sales-chart>
              </div>
            }
          </div>
        }
      }
    }
  </div>

  <div class="mt-6 grid grid-cols-1 gap-6 lg:grid-cols-2">
    <div class="overflow-hidden rounded-lg bg-yellow-50 shadow">
      <div class="border-b border-yellow-200 bg-yellow-100 px-4 py-3">
        <div class="flex items-center">
          <svg class="mr-2 h-5 w-5 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <h3 class="text-sm font-medium text-yellow-800">Estoque Baixo</h3>
        </div>
      </div>
      <div class="p-4">
        @if (lowStockItemsList().length > 0) {
          <ul class="space-y-2">
            @for (item of lowStockItemsList(); track item.id) {
              <li class="flex items-center justify-between rounded-md bg-yellow-100 p-2">
                <span class="text-sm font-medium text-yellow-800">{{ item.name }}</span>
                <span class="rounded-full bg-yellow-200 px-2 py-1 text-xs font-medium text-yellow-800">
                  {{ item.stock }} {{ item.unit }}
                </span>
              </li>
            }
          </ul>
        } @else {
          <p class="text-sm text-yellow-700">Nenhum item com estoque baixo.</p>
        }
      </div>
    </div>

    <div class="overflow-hidden rounded-lg bg-red-50 shadow">
      <div class="border-b border-red-200 bg-red-100 px-4 py-3">
        <div class="flex items-center">
          <svg class="mr-2 h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <h3 class="text-sm font-medium text-red-800">Funcionários Ausentes (Hoje)</h3>
        </div>
      </div>
      <div class="p-4">
        @if (employeesOnLeaveToday().length > 0) {
          <ul class="space-y-2">
            @for (req of employeesOnLeaveToday(); track req.id) {
              <li class="flex items-center justify-between rounded-md bg-red-100 p-2">
                <span class="text-sm font-medium text-red-800">{{ req.employees?.name }}</span>
                <span class="rounded-full bg-red-200 px-2 py-1 text-xs font-medium text-red-800">
                  {{ req.request_type }}
                </span>
              </li>
            }
          </ul>
        } @else {
          <p class="text-sm text-red-700">Nenhum funcionário de folga ou férias hoje.</p>
        }
      </div>
    </div>
  </div>
</div>