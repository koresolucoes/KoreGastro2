<div class="space-y-6">
  <!-- Configuration Section -->
  <div class="bg-gray-800 rounded-lg p-6 no-print">
    <h2 class="text-xl font-semibold text-white mb-4">Construtor de Relatórios</h2>
    <div class="space-y-6">
        <!-- 1. Columns -->
        <div>
            <h3 class="font-medium text-gray-300 mb-2">1. Selecione as Colunas</h3>
            <div class="flex flex-wrap gap-2">
                @for(col of availableColumns(); track col.key) {
                    <button (click)="toggleColumn(col.key)" class="px-3 py-1.5 text-sm rounded-full transition-colors" [class.bg-blue-600]="config().columns.has(col.key)" [class.text-white]="config().columns.has(col.key)" [class.bg-gray-700]="!config().columns.has(col.key)" [class.hover:bg-gray-600]="!config().columns.has(col.key)">
                        {{ col.label }}
                    </button>
                }
            </div>
        </div>
        <!-- 2. Filters -->
        <div>
            <h3 class="font-medium text-gray-300 mb-2">2. Filtros</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Data de Início</label>
                    <input type="date" [(ngModel)]="filterStartDate" class="w-full bg-gray-700 border-gray-600 rounded-md text-sm p-2">
                </div>
                 <div>
                    <label class="block text-xs text-gray-400 mb-1">Data de Fim</label>
                    <input type="date" [(ngModel)]="filterEndDate" class="w-full bg-gray-700 border-gray-600 rounded-md text-sm p-2">
                </div>
                 <div>
                    <label class="block text-xs text-gray-400 mb-1">Funcionário</label>
                    <select (change)="setFilter('employeeId', $any($event.target).value)" [value]="config().filters.employeeId" class="w-full bg-gray-700 border-gray-600 rounded-md text-sm p-2">
                        <option value="all">Todos</option>
                        @for(emp of employees(); track emp.id) {
                            <option [value]="emp.id">{{ emp.name }}</option>
                        }
                    </select>
                </div>
            </div>
        </div>
        <!-- 3. Grouping -->
        <div>
            <h3 class="font-medium text-gray-300 mb-2">3. Agrupar Resultados Por</h3>
            <select (change)="setGroupBy($any($event.target).value)" [value]="config().groupBy" class="w-full md:w-1/3 bg-gray-700 border-gray-600 rounded-md text-sm p-2">
                @for(opt of availableGroupByOptions(); track opt.key) {
                    <option [value]="opt.key">{{ opt.label }}</option>
                }
            </select>
        </div>
        <!-- 4. Generate Button -->
        <div>
            <button (click)="generateReport()" [disabled]="isLoading()" class="w-full md:w-auto bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-500 transition-colors disabled:bg-gray-600 flex items-center justify-center gap-2">
                 @if(isLoading()) {
                    <svg class="animate-spin h-5 w-5 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span>Gerando...</span>
                } @else {
                    <span>Gerar Relatório</span>
                }
            </button>
        </div>
    </div>
  </div>

  <!-- Results Section -->
  <div class="printable-area">
    @if(isLoading()) {
        <div class="flex items-center justify-center h-64 bg-gray-800 rounded-lg">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
        </div>
    } @else if(generatedReport(); as report) {
        <div class="bg-gray-800 rounded-lg">
            <div class="p-4 flex justify-between items-center no-print">
                <h3 class="text-lg font-semibold text-white">Resultados do Relatório</h3>
                <div class="flex gap-2">
                    <button (click)="exportToCsv()" class="bg-gray-600 text-white font-medium py-1.5 px-3 rounded-md hover:bg-gray-500 text-sm">Exportar CSV</button>
                    <button (click)="printReport()" class="bg-gray-600 text-white font-medium py-1.5 px-3 rounded-md hover:bg-gray-500 text-sm">Imprimir</button>
                </div>
            </div>
             @if(report.rows.length > 0) {
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-700/50 text-sm text-gray-300 uppercase">
                            <tr>
                                @for(header of report.headers; track header.key) {
                                    <th class="px-6 py-3">{{ header.label }}</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @for(row of report.rows; track $index) {
                                <tr class="border-b border-gray-700">
                                    @for(header of report.headers; track header.key) {
                                        <td class="px-6 py-4 text-sm text-gray-200">
                                            @if(header.key === 'amount' || header.key === 'totalAmount') {
                                                {{ row[header.key] | currency:'BRL' }}
                                            } @else if(header.key === 'date') {
                                                {{ row[header.key] | date:'dd/MM/yyyy' }}
                                            } @else {
                                                {{ row[header.key] }}
                                            }
                                        </td>
                                    }
                                </tr>
                            }
                        </tbody>
                         @if (report.totals) {
                            <tfoot class="bg-gray-900/50 font-bold">
                                <tr>
                                    @for(header of report.headers; track header.key) {
                                        <td class="px-6 py-3 text-white">
                                            @if ($first) {
                                                <span>TOTAL</span>
                                            } @else if (report.totals[header.key]) {
                                                 {{ report.totals[header.key] | currency:'BRL' }}
                                            }
                                        </td>
                                    }
                                </tr>
                            </tfoot>
                        }
                    </table>
                </div>
            } @else {
                 <div class="text-center text-gray-500 py-16">
                    <p>Nenhum resultado encontrado para os filtros selecionados.</p>
                </div>
            }
        </div>
    } @else {
        <div class="text-center text-gray-500 py-16 bg-gray-800 rounded-lg">
            <p>Configure e gere um relatório para ver os resultados aqui.</p>
        </div>
    }
  </div>
</div>
