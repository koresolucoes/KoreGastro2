
<div class="p-4 text-white h-full flex flex-col bg-gray-900">
  
  <!-- Header -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
    <div>
      <h1 class="text-3xl font-bold flex items-center gap-2">
          Mise en Place
          <span class="text-xs bg-blue-600 px-2 py-0.5 rounded uppercase tracking-wider font-bold">V2</span>
      </h1>
      <p class="text-gray-400">Planejamento e Execução de Produção</p>
    </div>
    
    <div class="flex items-center gap-3">
        <!-- Mode Switcher -->
        <div class="flex bg-gray-800 p-1 rounded-lg">
            <button (click)="viewMode.set('manager')" *ngIf="isManager()" class="px-4 py-2 rounded-md text-sm font-bold transition-colors" [class.bg-gray-600]="viewMode() === 'manager'" [class.text-white]="viewMode() === 'manager'" [class.text-gray-400]="viewMode() !== 'manager'">
                Gestão
            </button>
            <button (click)="viewMode.set('cook')" class="px-4 py-2 rounded-md text-sm font-bold transition-colors" [class.bg-blue-600]="viewMode() === 'cook'" [class.text-white]="viewMode() === 'cook'" [class.text-gray-400]="viewMode() !== 'cook'">
                Produção
            </button>
        </div>

        <input type="date" [value]="selectedDate()" (change)="handleDateChange($event)" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white font-semibold focus:ring-2 focus:ring-blue-500 outline-none">
        
        @if (isManager() && viewMode() === 'manager') {
          <button (click)="openTaskModal()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 shadow-lg">
              <span class="material-symbols-outlined">add</span>
              <span class="hidden sm:inline">Nova Tarefa</span>
          </button>
        }
    </div>
  </div>

  @if (isLoading()) {
    <div class="flex-1 flex items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
    </div>
  } @else {

    <!-- MANAGER VIEW: Sortable List -->
    @if (viewMode() === 'manager') {
        <div class="flex-1 overflow-y-auto pr-2" cdkDropList (cdkDropListDropped)="drop($event)">
            @for(task of tasks(); track task.id) {
                <div cdkDrag class="bg-gray-800 border-l-4 rounded-lg p-4 mb-3 flex items-center justify-between shadow-sm cursor-move hover:bg-gray-750 transition-colors" [class]="getStatusClass(task.status)">
                    
                    <div class="flex items-center gap-4">
                        <span class="material-symbols-outlined text-gray-500 cursor-grab">drag_indicator</span>
                        <div>
                            <h3 class="font-bold text-lg text-white">
                                {{ task.quantity_to_produce }}x {{ task.recipes?.name || task.custom_task_name }}
                            </h3>
                            <div class="flex items-center gap-2 text-sm text-gray-400">
                                <span class="bg-gray-900 px-2 py-0.5 rounded text-xs">{{ task.stations?.name || 'Geral' }}</span>
                                @if(task.employee_id) { <span class="flex items-center gap-1"><span class="material-symbols-outlined text-xs">person</span> {{ task.employees?.name }}</span> }
                                @if(task.sub_recipe_id) {
                                  <button (click)="$event.stopPropagation(); openRecipeModal(task)" class="text-blue-400 hover:text-blue-300 text-xs ml-2 hover:underline">
                                    Ver Ficha
                                  </button>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <div class="text-right mr-4">
                            <span class="block text-xs font-bold uppercase tracking-wider" [class.text-green-400]="task.status === 'Concluído'" [class.text-blue-400]="task.status === 'Em Preparo'" [class.text-yellow-400]="task.status === 'A Fazer'">{{ task.status }}</span>
                            @if(task.completed_at) {
                                <span class="text-xs text-gray-500">Feito em {{ task.completed_at | date:'HH:mm' }}</span>
                            }
                        </div>
                        <button (click)="openTaskModal(task)" class="p-2 text-blue-400 hover:bg-gray-700 rounded-full"><span class="material-symbols-outlined">edit</span></button>
                        <button (click)="deleteTask(task.id)" class="p-2 text-red-400 hover:bg-gray-700 rounded-full"><span class="material-symbols-outlined">delete</span></button>
                    </div>

                    <!-- Drag Preview -->
                    <div *cdkDragPreview class="bg-gray-700 p-4 rounded-lg shadow-2xl opacity-90 border border-blue-500 text-white">
                        {{ task.recipes?.name || task.custom_task_name }}
                    </div>
                </div>
            } @empty {
                <div class="text-center py-20 text-gray-500">
                    <span class="material-symbols-outlined text-6xl mb-4">playlist_add</span>
                    <p>Nenhuma tarefa planejada para hoje.</p>
                </div>
            }
        </div>
    }

    <!-- COOK VIEW: Big Cards -->
    @if (viewMode() === 'cook') {
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-20">
            @for(task of cookTasks(); track task.id) {
                <div (click)="enterFocusMode(task)" class="bg-gray-800 rounded-2xl overflow-hidden shadow-lg border-2 border-gray-700 hover:border-blue-500 cursor-pointer transition-all hover:scale-[1.02] group flex flex-col h-64 relative">
                    <!-- Status Strip -->
                    <div class="h-2 w-full" [class]="getStatusClass(task.status)"></div>
                    
                    <div class="p-6 flex-1 flex flex-col justify-between relative z-10">
                         <div>
                             <div class="flex justify-between items-start mb-2">
                                 <span class="bg-gray-900 text-gray-400 text-xs font-bold px-2 py-1 rounded uppercase tracking-wider">{{ task.stations?.name }}</span>
                                 @if(task.status === 'Em Preparo') {
                                     <span class="flex h-3 w-3 relative">
                                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                                        <span class="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span>
                                      </span>
                                 }
                             </div>
                             <h3 class="text-2xl font-black text-white leading-tight line-clamp-3">
                                 {{ task.recipes?.name || task.custom_task_name }}
                             </h3>
                         </div>
                         
                         <div class="flex items-end justify-between">
                             <div class="text-gray-400 text-sm">
                                 Meta:
                             </div>
                             <div class="text-4xl font-bold text-white">
                                 {{ task.quantity_to_produce }} <span class="text-lg text-gray-500 font-medium">{{ task.recipes?.unit || 'un' }}</span>
                             </div>
                         </div>
                    </div>

                    <!-- Action Prompt -->
                    <div class="absolute inset-0 bg-blue-600/90 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-sm">
                        <span class="text-white font-bold text-lg flex items-center gap-2">
                            <span class="material-symbols-outlined text-3xl">play_circle</span>
                            ABRIR TAREFA
                        </span>
                    </div>
                </div>
            } @empty {
                 <div class="col-span-full text-center py-20 text-gray-500">
                    <span class="material-symbols-outlined text-6xl mb-4">check_circle</span>
                    <p class="text-xl">Tudo pronto por aqui!</p>
                </div>
            }
        </div>
    }
  }
</div>

<!-- Task Form Modal -->
@if(isModalOpen()) {
  <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" (click)="closeModal()">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg" (click)="$event.stopPropagation()">
      <div class="p-4 border-b border-gray-700 flex justify-between items-center">
        <h3 class="text-xl font-bold text-white">{{ editingTask() ? 'Editar Tarefa' : 'Nova Tarefa' }}</h3>
        <button (click)="closeModal()" class="p-1 rounded-full text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"></path></svg></button>
      </div>
      <div class="p-6 space-y-4">
        <!-- Task Type -->
        <div class="flex gap-1 bg-gray-700 p-1 rounded-lg">
            <button (click)="updateTaskFormField('task_type', 'recipe')" class="flex-1 px-3 py-1.5 text-sm rounded-md" [class.bg-blue-600]="taskForm().task_type === 'recipe'">Sub-receita</button>
            <button (click)="updateTaskFormField('task_type', 'custom')" class="flex-1 px-3 py-1.5 text-sm rounded-md" [class.bg-blue-600]="taskForm().task_type === 'custom'">Personalizada</button>
        </div>
        
        @if (taskForm().task_type === 'recipe') {
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Sub-receita</label>
                <select [value]="taskForm().sub_recipe_id" (change)="updateTaskFormField('sub_recipe_id', $any($event.target).value)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
                    <option [value]="null">Selecione...</option>
                    @for (recipe of subRecipes(); track recipe.id) { <option [value]="recipe.id">{{ recipe.name }}</option> }
                </select>
            </div>
        } @else {
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Nome da Tarefa</label>
                <input type="text" [value]="taskForm().custom_task_name" (input)="updateTaskFormField('custom_task_name', $any($event.target).value)" placeholder="Ex: Limpar câmara fria" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
            </div>
        }
        
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Quantidade</label>
                <input type="number" [value]="taskForm().quantity_to_produce" (input)="updateTaskFormField('quantity_to_produce', +$any($event.target).value)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Estação</label>
                <select [value]="taskForm().station_id" (change)="updateTaskFormField('station_id', $any($event.target).value)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
                    @for (s of stations(); track s.id) { <option [value]="s.id">{{ s.name }}</option> }
                </select>
            </div>
        </div>
         <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Atribuir a</label>
            <select [value]="taskForm().employee_id" (change)="updateTaskFormField('employee_id', $any($event.target).value || null)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
                <option [value]="null">Não atribuído</option>
                @for (e of employees(); track e.id) { <option [value]="e.id">{{ e.name }}</option> }
            </select>
        </div>
      </div>
      <div class="p-4 bg-gray-700/50 flex justify-end gap-3">
         <button (click)="closeModal()" class="px-4 py-2 font-medium rounded-lg bg-gray-600 hover:bg-gray-500 text-white">Cancelar</button>
         <button (click)="saveTask()" class="px-4 py-2 font-medium rounded-lg bg-blue-600 hover:bg-blue-500 text-white">Salvar Tarefa</button>
      </div>
    </div>
  </div>
}

<!-- Focus Mode Overlay -->
@if(focusedTask()) {
    <app-mise-en-place-focus 
        [task]="focusedTask()!" 
        (close)="exitFocusMode()" 
        (taskCompleted)="exitFocusMode()">
    </app-mise-en-place-focus>
}

<!-- Recipe Modal -->
@if(isRecipeModalOpen()) {
  <app-mise-en-place-recipe-modal 
    [recipeData]="recipeForModal()"
    (close)="closeRecipeModal()">
  </app-mise-en-place-recipe-modal>
}
