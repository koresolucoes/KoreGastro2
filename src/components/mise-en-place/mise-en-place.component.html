
<div class="p-4 text-white h-full flex flex-col bg-gray-900">
  
  <!-- Header -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
    <div>
      <h1 class="text-3xl font-bold flex items-center gap-2">
          Mise en Place
          <span class="text-xs bg-blue-600 px-2 py-0.5 rounded uppercase tracking-wider font-bold">V2</span>
      </h1>
      <p class="text-gray-400">Planejamento e Execução de Produção</p>
    </div>
    
    <div class="flex items-center gap-3">
        <!-- Mode Switcher -->
        <div class="flex bg-gray-800 p-1 rounded-lg">
            <button (click)="viewMode.set('manager')" *ngIf="isManager()" class="px-4 py-2 rounded-md text-sm font-bold transition-colors" [class.bg-gray-600]="viewMode() === 'manager'" [class.text-white]="viewMode() === 'manager'" [class.text-gray-400]="viewMode() !== 'manager'">
                Gestão
            </button>
            <button (click)="viewMode.set('cook')" class="px-4 py-2 rounded-md text-sm font-bold transition-colors" [class.bg-blue-600]="viewMode() === 'cook'" [class.text-white]="viewMode() === 'cook'" [class.text-gray-400]="viewMode() !== 'cook'">
                Produção
            </button>
        </div>

        <input type="date" [value]="selectedDate()" (change)="handleDateChange($event)" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white font-semibold focus:ring-2 focus:ring-blue-500 outline-none">
        
        @if (isManager() && viewMode() === 'manager') {
          <button (click)="openTaskModal()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 shadow-lg">
              <span class="material-symbols-outlined">add</span>
              <span class="hidden sm:inline">Nova Tarefa</span>
          </button>
        }
    </div>
  </div>

  @if (isLoading()) {
    <div class="flex-1 flex items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
    </div>
  } @else {

    <!-- MANAGER VIEW: Sortable List -->
    @if (viewMode() === 'manager') {
        <div class="flex-1 overflow-y-auto pr-2" cdkDropList (cdkDropListDropped)="drop($event)">
            @for(task of tasks(); track task.id) {
                <div cdkDrag class="bg-gray-800 border-l-4 rounded-lg p-4 mb-3 flex items-center justify-between shadow-sm cursor-move hover:bg-gray-750 transition-colors" [class]="getStatusClass(task.status)">
                    
                    <div class="flex items-center gap-4">
                        <span class="material-symbols-outlined text-gray-500 cursor-grab">drag_indicator</span>
                        <div>
                            <h3 class="font-bold text-lg text-white">
                                {{ task.quantity_to_produce }}x {{ task.recipes?.name || task.custom_task_name }}
                            </h3>
                            <div class="flex items-center gap-2 text-sm text-gray-400">
                                <span class="bg-gray-900 px-2 py-0.5 rounded text-xs">{{ task.stations?.name || 'Geral' }}</span>
                                @if(task.employee_id) { <span class="flex items-center gap-1"><span class="material-symbols-outlined text-xs">person</span> {{ task.employees?.name }}</span> }
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <div class="text-right mr-4">
                            <span class="block text-xs font-bold uppercase tracking-wider" [class.text-green-400]="task.status === 'Concluído'" [class.text-blue-400]="task.status === 'Em Preparo'" [class.text-yellow-400]="task.status === 'A Fazer'">{{ task.status }}</span>
                            @if(task.completed_at) {
                                <span class="text-xs text-gray-500">Feito em {{ task.completed_at | date:'HH:mm' }}</span>
                            }
                        </div>
                        <button (click)="openTaskModal(task)" class="p-2 text-blue-400 hover:bg-gray-700 rounded-full"><span class="material-symbols-outlined">edit</span></button>
                        <button (click)="deleteTask(task.id)" class="p-2 text-red-400 hover:bg-gray-700 rounded-full"><span class="material-symbols-outlined">delete</span></button>
                    </div>

                    <!-- Drag Preview -->
                    <div *cdkDragPreview class="bg-gray-700 p-4 rounded-lg shadow-2xl opacity-90 border border-blue-500 text-white">
                        {{ task.recipes?.name || task.custom_task_name }}
                    </div>
                </div>
            } @empty {
                <div class="text-center py-20 text-gray-500">
                    <span class="material-symbols-outlined text-6xl mb-4">playlist_add</span>
                    <p>Nenhuma tarefa planejada para hoje.</p>
                </div>
            }
        </div>
    }

    <!-- COOK VIEW: Big Cards -->
    @if (viewMode() === 'cook') {
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-20">
            @for(task of cookTasks(); track task.id) {
                <div (click)="enterFocusMode(task)" class="bg-gray-800 rounded-2xl overflow-hidden shadow-lg border-2 border-gray-700 hover:border-blue-500 cursor-pointer transition-all hover:scale-[1.02] group flex flex-col h-64 relative">
                    <!-- Status Strip -->
                    <div class="h-2 w-full" [class]="getStatusClass(task.status)"></div>
                    
                    <div class="p-6 flex-1 flex flex-col justify-between relative z-10">
                         <div>
                             <div class="flex justify-between items-start mb-2">
                                 <span class="bg-gray-900 text-gray-400 text-xs font-bold px-2 py-1 rounded uppercase tracking-wider">{{ task.stations?.name }}</span>
                                 @if(task.status === 'Em Preparo') {
                                     <span class="flex h-3 w-3 relative">
                                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                                        <span class="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span>
                                      </span>
                                 }
                             </div>
                             <h3 class="text-2xl font-black text-white leading-tight line-clamp-3">
                                 {{ task.recipes?.name || task.custom_task_name }}
                             </h3>
                         </div>
                         
                         <div class="flex items-end justify-between">
                             <div class="text-gray-400 text-sm">
                                 Meta:
                             </div>
                             <div class="text-4xl font-bold text-white">
                                 {{ task.quantity_to_produce }} <span class="text-lg text-gray-500 font-medium">{{ task.recipes?.unit || 'un' }}</span>
                             </div>
                         </div>
                    </div>

                    <!-- Action Prompt -->
                    <div class="absolute inset-0 bg-blue-600/90 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-sm">
                        <span class="text-white font-bold text-lg flex items-center gap-2">
                            <span class="material-symbols-outlined text-3xl">play_circle</span>
                            ABRIR TAREFA
                        </span>
                    </div>
                </div>
            } @empty {
                 <div class="col-span-full text-center py-20 text-gray-500">
                    <span class="material-symbols-outlined text-6xl mb-4">check_circle</span>
                    <p class="text-xl">Tudo pronto por aqui!</p>
                </div>
            }
        </div>
    }
  }
</div>

<!-- Task Form Modal -->
@if(isModalOpen()) {
    <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 p-6 rounded-lg w-full max-w-md">
            <h2 class="text-xl font-bold text-white mb-4">Tarefa</h2>
            <!-- Form fields reused from previous version, simplified here for brevity -->
            <button (click)="saveTask()" class="w-full bg-blue-600 text-white py-2 rounded">Salvar</button>
            <button (click)="closeModal()" class="w-full mt-2 text-gray-400">Cancelar</button>
        </div>
    </div>
}

<!-- Focus Mode Overlay -->
@if(focusedTask()) {
    <app-mise-en-place-focus 
        [task]="focusedTask()!" 
        (close)="exitFocusMode()" 
        (taskCompleted)="exitFocusMode()">
    </app-mise-en-place-focus>
}
