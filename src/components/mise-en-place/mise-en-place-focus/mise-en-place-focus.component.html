
<div class="fixed inset-0 bg-gray-900 z-[100] flex flex-col">
    <!-- Header -->
    <div class="h-16 flex items-center justify-between px-4 bg-gray-800 border-b border-gray-700 shadow-md z-10">
        <button (click)="cancel()" class="p-2 rounded-full text-gray-400 hover:bg-gray-700">
            <span class="material-symbols-outlined text-3xl">close</span>
        </button>
        <h1 class="text-xl font-bold text-white truncate max-w-[200px]">{{ taskName() }}</h1>
        <div class="w-10"></div> <!-- Spacer -->
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col items-center justify-center p-6 relative overflow-hidden">
        
        <!-- STEP 1: PREVIEW -->
        @if(step() === 'preview') {
            <div class="flex flex-col items-center animate-fade-in text-center max-w-md w-full">
                @if(imageUrl()) {
                    <img [src]="imageUrl()" class="w-48 h-48 rounded-full object-cover border-4 border-gray-700 shadow-2xl mb-8">
                } @else {
                    <div class="w-48 h-48 rounded-full bg-gray-800 flex items-center justify-center border-4 border-gray-700 shadow-2xl mb-8">
                        <span class="material-symbols-outlined text-6xl text-gray-600">skillet</span>
                    </div>
                }

                <h2 class="text-gray-400 text-sm uppercase tracking-widest mb-2">Meta de Produção</h2>
                <div class="text-6xl font-black text-white mb-2">{{ targetQuantity() }} <span class="text-2xl text-gray-500 font-medium">{{ unit() }}</span></div>
                
                @if(task().sub_recipe_id) {
                    <div class="bg-gray-800 px-4 py-2 rounded-lg text-blue-400 font-medium mb-8">
                        Ver Receita & Ingredientes
                    </div>
                }

                <button (click)="startProduction()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-6 rounded-2xl shadow-lg shadow-blue-900/50 text-xl flex items-center justify-center gap-3 active:scale-95 transition-all">
                    <span class="material-symbols-outlined text-3xl">play_circle</span>
                    INICIAR PREPARO
                </button>
            </div>
        }

        <!-- STEP 2: WORKING (TIMER) -->
        @if(step() === 'working') {
            <div class="flex flex-col items-center animate-fade-in w-full max-w-md">
                <div class="relative mb-12">
                    <div class="w-64 h-64 rounded-full border-8 border-gray-700 flex items-center justify-center bg-gray-800 shadow-[0_0_50px_rgba(37,99,235,0.2)]">
                        <div class="text-center">
                            <div class="text-gray-400 text-xs uppercase mb-1">Tempo Decorrido</div>
                            <div class="text-5xl font-mono font-bold text-white tracking-wider">{{ formatTime(elapsedTime()) }}</div>
                        </div>
                    </div>
                    <div class="absolute -bottom-4 left-1/2 transform -translate-x-1/2 bg-green-900/80 text-green-300 px-4 py-1 rounded-full text-xs font-bold border border-green-700 backdrop-blur-md animate-pulse">
                        EM ANDAMENTO
                    </div>
                </div>

                <div class="w-full bg-gray-800 rounded-xl p-4 mb-8 border-l-4 border-blue-500">
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="text-gray-400 text-xs uppercase">Produzindo</p>
                            <p class="text-white font-bold text-lg">{{ taskName() }}</p>
                        </div>
                        <p class="text-blue-400 font-bold text-2xl">{{ targetQuantity() }} {{ unit() }}</p>
                    </div>
                </div>

                <button (click)="finishProduction()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-6 rounded-2xl shadow-lg shadow-green-900/50 text-xl flex items-center justify-center gap-3 active:scale-95 transition-all">
                    <span class="material-symbols-outlined text-3xl">check_circle</span>
                    FINALIZAR
                </button>
            </div>
        }

        <!-- STEP 3: FINALIZE -->
        @if(step() === 'finalize') {
            <div class="w-full max-w-lg flex flex-col h-full">
                <h2 class="text-2xl font-bold text-white mb-6 text-center">Confirmar Produção</h2>
                
                <div class="flex-1 overflow-y-auto space-y-6 px-2">
                    <!-- Quantity Input -->
                    <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700">
                        <label class="block text-gray-400 text-xs uppercase font-bold mb-3 text-center">Quantidade Obtida</label>
                        <div class="flex items-center justify-center gap-4">
                            <button (click)="producedQuantity.set(producedQuantity() - 1)" class="w-12 h-12 rounded-full bg-gray-700 text-white text-2xl font-bold hover:bg-gray-600">-</button>
                            <div class="flex flex-col items-center">
                                <input type="number" [ngModel]="producedQuantity()" (ngModelChange)="producedQuantity.set(+$event)" class="bg-transparent text-5xl font-bold text-white w-32 text-center outline-none border-b-2 border-blue-500 focus:border-blue-400 transition-colors">
                                <span class="text-gray-500 font-medium mt-1">{{ unit() }}</span>
                            </div>
                            <button (click)="producedQuantity.set(producedQuantity() + 1)" class="w-12 h-12 rounded-full bg-gray-700 text-white text-2xl font-bold hover:bg-gray-600">+</button>
                        </div>
                    </div>

                    <!-- Details -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-400 text-xs mb-1 ml-1">Validade</label>
                            <input type="date" [ngModel]="expirationDate()" (ngModelChange)="expirationDate.set($event)" class="w-full bg-gray-800 border-none rounded-xl p-3 text-white focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                             <label class="block text-gray-400 text-xs mb-1 ml-1">Lote</label>
                             <input type="text" [ngModel]="lotNumber()" (ngModelChange)="lotNumber.set($event)" class="w-full bg-gray-800 border-none rounded-xl p-3 text-white focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-gray-400 text-xs mb-1 ml-1">Observações</label>
                        <textarea [ngModel]="notes()" (ngModelChange)="notes.set($event)" rows="2" class="w-full bg-gray-800 border-none rounded-xl p-3 text-white focus:ring-2 focus:ring-blue-500" placeholder="Ocorrências..."></textarea>
                    </div>

                    <div class="flex items-center justify-between bg-gray-800 p-4 rounded-xl cursor-pointer" (click)="printLabel.set(!printLabel())">
                        <span class="text-white font-medium">Imprimir Etiqueta</span>
                        <div class="w-12 h-6 rounded-full relative transition-colors" [class.bg-blue-600]="printLabel()" [class.bg-gray-600]="!printLabel()">
                            <div class="absolute top-1 w-4 h-4 bg-white rounded-full transition-all" [class.left-1]="!printLabel()" [class.left-7]="printLabel()"></div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-800">
                    <button (click)="confirmCompletion()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-5 rounded-2xl shadow-lg shadow-green-900/50 text-xl active:scale-95 transition-all">
                        CONFIRMAR
                    </button>
                </div>
            </div>
        }

    </div>
</div>
