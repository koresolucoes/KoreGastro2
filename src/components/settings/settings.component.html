<div class="flex flex-col md:flex-row gap-8 h-full">
  <!-- Left Sidebar Navigation -->
  <aside class="w-full md:w-64 flex-shrink-0 no-print">
    <h2 class="text-xl font-bold text-white mb-4 px-2">Configurações</h2>
    <nav class="space-y-1">
      <button (click)="setView('profile')" class="w-full text-left flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors" [class.bg-blue-600]="activeView() === 'profile'" [class.text-white]="activeView() === 'profile'" [class.text-gray-300]="activeView() !== 'profile'" [class.hover:bg-gray-700]="activeView() !== 'profile'">
        <span class="material-symbols-outlined">storefront</span> Perfil da Empresa
      </button>
      <button (click)="setView('stations')" class="w-full text-left flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors" [class.bg-blue-600]="activeView() === 'stations'" [class.text-white]="activeView() === 'stations'" [class.text-gray-300]="activeView() !== 'stations'" [class.hover:bg-gray-700]="activeView() !== 'stations'">
        <span class="material-symbols-outlined">deck</span> Estações de Produção
      </button>
      <button (click)="setView('recipe_categories')" class="w-full text-left flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors" [class.bg-blue-600]="activeView() === 'recipe_categories'" [class.text-white]="activeView() === 'recipe_categories'" [class.text-gray-300]="activeView() !== 'recipe_categories'" [class.hover:bg-gray-700]="activeView() !== 'recipe_categories'">
        <span class="material-symbols-outlined">restaurant_menu</span> Categorias (Cardápio)
      </button>
      <button (click)="setView('ingredient_categories')" class="w-full text-left flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors" [class.bg-blue-600]="activeView() === 'ingredient_categories'" [class.text-white]="activeView() === 'ingredient_categories'" [class.text-gray-300]="activeView() !== 'ingredient_categories'" [class.hover:bg-gray-700]="activeView() !== 'ingredient_categories'">
        <span class="material-symbols-outlined">category</span> Categorias (Estoque)
      </button>
      <button (click)="setView('suppliers')" class="w-full text-left flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors" [class.bg-blue-600]="activeView() === 'suppliers'" [class.text-white]="activeView() === 'suppliers'" [class.text-gray-300]="activeView() !== 'suppliers'" [class.hover:bg-gray-700]="activeView() !== 'suppliers'">
        <span class="material-symbols-outlined">local_shipping</span> Fornecedores
      </button>
      <button (click)="setView('roles')" class="w-full text-left flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors" [class.bg-blue-600]="activeView() === 'roles'" [class.text-white]="activeView() === 'roles'" [class.text-gray-300]="activeView() !== 'roles'" [class.hover:bg-gray-700]="activeView() !== 'roles'">
        <span class="material-symbols-outlined">manage_accounts</span> Cargos e Permissões
      </button>
       <button (click)="setView('reservations')" class="w-full text-left flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors" [class.bg-blue-600]="activeView() === 'reservations'" [class.text-white]="activeView() === 'reservations'" [class.text-gray-300]="activeView() !== 'reservations'" [class.hover:bg-gray-700]="activeView() !== 'reservations'">
        <span class="material-symbols-outlined">event_seat</span> Reservas
      </button>
      <button (click)="setView('loyalty')" class="w-full text-left flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors" [class.bg-blue-600]="activeView() === 'loyalty'" [class.text-white]="activeView() === 'loyalty'" [class.text-gray-300]="activeView() !== 'loyalty'" [class.hover:bg-gray-700]="activeView() !== 'loyalty'">
        <span class="material-symbols-outlined">loyalty</span> Fidelidade
      </button>
       <button (click)="setView('integrations')" class="w-full text-left flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors" [class.bg-blue-600]="activeView() === 'integrations'" [class.text-white]="activeView() === 'integrations'" [class.text-gray-300]="activeView() !== 'integrations'" [class.hover:bg-gray-700]="activeView() !== 'integrations'">
        <span class="material-symbols-outlined">integration_instructions</span> Integrações & API
      </button>
    </nav>
  </aside>

  <!-- Right Content Area -->
  <main class="flex-1 min-w-0 printable-area">
    @switch (activeView()) {
      @case ('profile') {
        @if(profileForm(); as form) {
          <div class="space-y-6">
            <div class="bg-gray-800 p-6 rounded-lg">
              <h2 class="text-xl font-semibold text-white mb-4">Dados da Empresa</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input [value]="form.company_name" (input)="updateProfileField('company_name', $any($event.target).value)" placeholder="Nome da Empresa" class="w-full bg-gray-700 rounded p-2 text-white">
                <input [value]="form.cnpj" (input)="updateProfileField('cnpj', $any($event.target).value)" placeholder="CNPJ" class="w-full bg-gray-700 rounded p-2 text-white">
                <input [value]="form.phone" (input)="updateProfileField('phone', $any($event.target).value)" placeholder="Telefone" class="w-full bg-gray-700 rounded p-2 text-white">
                <input [value]="form.address" (input)="updateProfileField('address', $any($event.target).value)" placeholder="Endereço" class="w-full bg-gray-700 rounded p-2 text-white">
              </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg">
              <h2 class="text-xl font-semibold text-white mb-4">Imagens e Logos</h2>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                  <!-- Logo Upload -->
                  <div>
                      <h3 class="font-medium text-gray-300 mb-2">Logo da Empresa</h3>
                      <label for="logo-upload" class="cursor-pointer group">
                          @if (logoPreview()) {
                              <img [src]="logoPreview()" alt="Pré-visualização do logo" class="w-32 h-32 rounded-full object-cover border-4 border-gray-600 group-hover:opacity-70 mx-auto">
                          } @else {
                              <div class="w-32 h-32 rounded-full bg-gray-700 flex items-center justify-center border-4 border-gray-600 group-hover:bg-gray-600 mx-auto">
                                  <span class="material-symbols-outlined text-4xl text-gray-500">add_a_photo</span>
                              </div>
                          }
                      </label>
                      <input id="logo-upload" type="file" (change)="handleFileChange($event, 'logo')" accept="image/*" class="hidden">
                  </div>
                  <!-- Cover Upload -->
                  <div>
                      <h3 class="font-medium text-gray-300 mb-2">Capa do Cardápio Online</h3>
                      <label for="cover-upload" class="cursor-pointer group">
                          @if (coverPreview()) {
                              <img [src]="coverPreview()" alt="Pré-visualização da capa" class="w-full h-32 rounded-md object-cover border-4 border-gray-600 group-hover:opacity-70">
                          } @else {
                              <div class="w-full h-32 rounded-md bg-gray-700 flex items-center justify-center border-4 border-gray-600 group-hover:bg-gray-600">
                                  <span class="material-symbols-outlined text-4xl text-gray-500">add_photo_alternate</span>
                              </div>
                          }
                      </label>
                      <input id="cover-upload" type="file" (change)="handleFileChange($event, 'cover')" accept="image/*" class="hidden">
                  </div>
                  <!-- Header Upload -->
                  <div>
                      <h3 class="font-medium text-gray-300 mb-2">Cabeçalho do Cardápio Online</h3>
                      <label for="header-upload" class="cursor-pointer group">
                          @if (headerPreview()) {
                              <img [src]="headerPreview()" alt="Pré-visualização do cabeçalho" class="w-full h-32 rounded-md object-cover border-4 border-gray-600 group-hover:opacity-70">
                          } @else {
                              <div class="w-full h-32 rounded-md bg-gray-700 flex items-center justify-center border-4 border-gray-600 group-hover:bg-gray-600">
                                  <span class="material-symbols-outlined text-4xl text-gray-500">add_photo_alternate</span>
                              </div>
                          }
                      </label>
                      <input id="header-upload" type="file" (change)="handleFileChange($event, 'header')" accept="image/*" class="hidden">
                  </div>
              </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg">
              <h2 class="text-xl font-semibold text-white mb-4">Localização (Controle de Ponto)</h2>
              <div id="map" class="h-80 w-full rounded-lg z-0"></div>
              <div class="mt-4">
                <label class="block text-sm font-medium text-gray-300">Raio Permitido (em metros)</label>
                <input type="range" [min]="50" [max]="1000" [step]="10" [value]="form.time_clock_radius || 200" (input)="updateRadius(+$any($event.target).value)" class="w-full mt-2">
                <p class="text-center text-white font-semibold">{{ form.time_clock_radius || 200 }} metros</p>
              </div>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg">
              <h2 class="text-xl font-semibold text-white mb-4">Cardápio Online & QR Code</h2>
              <div class="flex flex-col md:flex-row items-center gap-6">
                <div class="bg-white p-4 rounded-lg">
                    <img [src]="qrCodeUrl()" alt="QR Code para o cardápio online" class="w-40 h-40">
                </div>
                <div>
                    <p class="text-gray-300 mb-2">Use este QR Code nas mesas para que seus clientes acessem o cardápio digital.</p>
                    <a [href]="qrCodeUrl()" download="qrcode-cardapio.png" class="inline-block bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-500">Baixar QR Code</a>
                    <p class="text-xs text-gray-500 mt-4">Link direto: <a [href]="publicMenuUrl()" target="_blank" class="text-blue-400 hover:underline">{{ publicMenuUrl() }}</a></p>
                </div>
              </div>
            </div>
            <div class="flex justify-end mt-4">
              <button (click)="saveProfile()" [disabled]="isSaving()" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-500 disabled:bg-gray-600">
                {{ isSaving() ? 'Salvando...' : 'Salvar Alterações' }}
              </button>
            </div>
          </div>
        }
      }
      @case ('stations') {
        <app-settings-list-view
          [title]="'Estações de Produção'"
          [items]="stations()"
          (addItem)="openModal('station', null)"
          (editItem)="openModal('station', $event)"
          (deleteItem)="deleteItem('station', $event)">
        </app-settings-list-view>
      }
      @case ('recipe_categories') {
        <app-settings-list-view
          [title]="'Categorias do Cardápio'"
          [items]="recipeCategories()"
          (addItem)="openModal('recipe_category', null)"
          (editItem)="openModal('recipe_category', $event)"
          (deleteItem)="deleteItem('recipe_category', $event)">
        </app-settings-list-view>
      }
      @case ('ingredient_categories') {
        <app-settings-list-view
          [title]="'Categorias de Ingredientes'"
          [items]="ingredientCategories()"
          (addItem)="openModal('ingredient_category', null)"
          (editItem)="openModal('ingredient_category', $event)"
          (deleteItem)="deleteItem('ingredient_category', $event)">
        </app-settings-list-view>
      }
      @case ('suppliers') {
         <app-settings-list-view
          [title]="'Fornecedores'"
          [items]="suppliers()"
          (addItem)="openModal('supplier', null)"
          (editItem)="openModal('supplier', $event)"
          (deleteItem)="deleteItem('supplier', $event)">
        </app-settings-list-view>
      }
      @case ('roles') {
        <div class="bg-gray-800 p-6 rounded-lg">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-white">Cargos e Permissões</h2>
            <button (click)="openModal('role', null)" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-500 text-sm">Novo Cargo</button>
          </div>
          <ul class="space-y-2">
            @for(role of roles(); track role.id) {
              <li class="flex items-center justify-between bg-gray-700/50 p-3 rounded-lg">
                <span class="font-medium text-white">{{ role.name }}</span>
                <div class="flex gap-2">
                  <button (click)="openPermissionsModal(role)" class="flex items-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-md bg-gray-600 hover:bg-gray-500 text-white">
                    <span class="material-symbols-outlined text-base">lock</span>
                    Permissões
                  </button>
                  <button (click)="openModal('role', role)" class="p-2 text-blue-400 hover:text-blue-300"><span class="material-symbols-outlined">edit</span></button>
                  <button (click)="deleteItem('role', role)" class="p-2 text-red-400 hover:text-red-300"><span class="material-symbols-outlined">delete</span></button>
                </div>
              </li>
            }
          </ul>
        </div>
      }
      @case ('reservations') {
        <!-- Implementation for reservations -->
        <p>Reservations View Placeholder</p>
      }
      @case ('loyalty') {
        <!-- Implementation for loyalty -->
        <p>Loyalty View Placeholder</p>
      }
      @case ('integrations') {
        <div class="bg-gray-800 p-6 rounded-lg">
          <h2 class="text-xl font-semibold text-white mb-4">Integrações & API</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Sua Chave de API Externa</label>
              <input type="text" [value]="profileForm()?.external_api_key || 'Nenhuma chave gerada'" readonly class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-gray-400 font-mono cursor-not-allowed">
              <p class="text-xs text-gray-500 mt-1">Use esta chave no header `Authorization: Bearer SUA_CHAVE` para autenticar em endpoints da API.</p>
            </div>
            <button (click)="regenerateApiKey()" [disabled]="isSaving()" class="bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg hover:bg-yellow-500 disabled:bg-gray-600">
              {{ isSaving() ? 'Gerando...' : 'Gerar Nova Chave' }}
            </button>
          </div>
        </div>
      }
    }
  </main>

  <!-- Generic Add/Edit Modal -->
  @if (isModalOpen()) {
    <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" (click)="closeModal()">
      <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md" (click)="$event.stopPropagation()">
        <div class="p-4 border-b border-gray-700">
          <h3 class="text-xl font-bold text-white">{{ modalTitle() }}</h3>
        </div>
        <div class="p-6">
          <label class="block text-sm font-medium text-gray-300 mb-1">Nome</label>
          <input type="text" [value]="formName()" (input)="formName.set($any($event.target).value)" (keydown.enter)="saveItem()" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
        </div>
        <div class="p-4 bg-gray-700/50 flex justify-end gap-3">
          <button (click)="closeModal()" class="px-4 py-2 font-medium rounded-lg bg-gray-600 hover:bg-gray-500 text-white">Cancelar</button>
          <button (click)="saveItem()" [disabled]="isSaving()" class="px-4 py-2 font-medium rounded-lg bg-blue-600 hover:bg-blue-500 text-white disabled:bg-gray-500">
            {{ isSaving() ? 'Salvando...' : 'Salvar' }}
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Permissions Modal -->
  @if (isPermissionsModalOpen() && editingRolePermissions(); as role) {
    <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" (click)="closePermissionsModal()">
      <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col" (click)="$event.stopPropagation()">
        <div class="p-4 border-b border-gray-700">
          <h3 class="text-xl font-bold text-white">Permissões para: {{ role.name }}</h3>
        </div>
        <div class="p-6 overflow-y-auto">
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
            @for(permission of allPermissions; track permission) {
              <label class="flex items-center p-3 bg-gray-700/50 rounded-lg">
                <input type="checkbox" [checked]="permissionsForm().has(permission)" (change)="togglePermission(permission)" class="h-4 w-4 rounded border-gray-500 text-blue-600">
                <span class="ml-3 text-sm text-gray-200">{{ permission.replace('/', '') }}</span>
              </label>
            }
          </div>
        </div>
        <div class="p-4 bg-gray-700/50 flex justify-end gap-3">
          <button (click)="closePermissionsModal()" class="px-4 py-2 font-medium rounded-lg bg-gray-600 hover:bg-gray-500 text-white">Cancelar</button>
          <button (click)="savePermissions()" [disabled]="isSaving()" class="px-4 py-2 font-medium rounded-lg bg-blue-600 hover:bg-blue-500 text-white disabled:bg-gray-500">
            {{ isSaving() ? 'Salvando...' : 'Salvar Permissões' }}
          </button>
        </div>
      </div>
    </div>
  }
</div>
