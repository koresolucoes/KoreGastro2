<div class="container mx-auto">
  <h1 class="text-3xl font-bold text-white mb-6">Configurações</h1>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
    <!-- Vertical Navigation -->
    <div class="md:col-span-1">
      <nav class="space-y-2 sticky top-4">
        <button (click)="setActiveTab('empresa')"
                class="w-full flex items-center gap-3 p-3 rounded-lg text-left transition-colors"
                [class.bg-blue-600]="activeTab() === 'empresa'"
                [class.text-white]="activeTab() === 'empresa'"
                [class.text-gray-300]="activeTab() !== 'empresa'"
                [class.hover:bg-gray-700]="activeTab() !== 'empresa'">
          <span class="material-symbols-outlined">storefront</span>
          <span class="font-medium">Loja e Assinatura</span>
        </button>
        <button (click)="setActiveTab('operacao')"
                class="w-full flex items-center gap-3 p-3 rounded-lg text-left transition-colors"
                [class.bg-blue-600]="activeTab() === 'operacao'"
                [class.text-white]="activeTab() === 'operacao'"
                [class.text-gray-300]="activeTab() !== 'operacao'"
                [class.hover:bg-gray-700]="activeTab() !== 'operacao'">
          <span class="material-symbols-outlined">category</span>
          <span class="font-medium">Categorias e Estações</span>
        </button>
        <button (click)="setActiveTab('funcionalidades')"
                class="w-full flex items-center gap-3 p-3 rounded-lg text-left transition-colors"
                [class.bg-blue-600]="activeTab() === 'funcionalidades'"
                [class.text-white]="activeTab() === 'funcionalidades'"
                [class.text-gray-300]="activeTab() !== 'funcionalidades'"
                [class.hover:bg-gray-700]="activeTab() !== 'funcionalidades'">
          <span class="material-symbols-outlined">extension</span>
          <span class="font-medium">Módulos e Integrações</span>
        </button>
        <button (click)="setActiveTab('seguranca')"
                class="w-full flex items-center gap-3 p-3 rounded-lg text-left transition-colors"
                [class.bg-blue-600]="activeTab() === 'seguranca'"
                [class.text-white]="activeTab() === 'seguranca'"
                [class.text-gray-300]="activeTab() !== 'seguranca'"
                [class.hover:bg-gray-700]="activeTab() !== 'seguranca'">
          <span class="material-symbols-outlined">security</span>
          <span class="font-medium">Equipe e Segurança</span>
        </button>
      </nav>
    </div>

    <!-- Tab Content -->
    <div class="md:col-span-3 space-y-6">
      @switch (activeTab()) {
        @case ('empresa') {
          <!-- Panel: Company Profile -->
          <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold text-white mb-4">Dados da Empresa</h2>
            <div class="space-y-4">
              <div class="flex flex-col items-center gap-4">
                <label for="logo-upload" class="cursor-pointer">
                  @if(logoPreviewUrl()) {
                    <img [src]="logoPreviewUrl()" alt="Logo preview" class="h-24 w-24 rounded-full object-cover border-4 border-gray-600 hover:opacity-80">
                  } @else {
                  <div class="h-24 w-24 rounded-full bg-gray-700 flex items-center justify-center border-2 border-dashed border-gray-500 hover:bg-gray-600">
                      <span class="text-5xl font-extrabold text-gray-800">
                        <span>C</span><span class="text-blue-600">OS</span>
                      </span>
                  </div>
                }
                </label>
                <input id="logo-upload" type="file" class="hidden" (change)="handleLogoFileChange($event)" accept="image/png, image/jpeg, image/webp">
                <p class="text-xs text-gray-400">Clique na imagem para alterar o logo</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Nome da Empresa</label>
                <input type="text" [value]="companyProfileForm().company_name || ''" (input)="updateCompanyProfileField('company_name', $any($event.target).value)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">CNPJ</label>
                <input type="text" [value]="companyProfileForm().cnpj || ''" (input)="updateCompanyProfileField('cnpj', $any($event.target).value)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Endereço</label>
                <input type="text" [value]="companyProfileForm().address || ''" (input)="updateCompanyProfileField('address', $any($event.target).value)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Telefone de Contato</label>
                <input type="tel" [value]="companyProfileForm().phone || ''" (input)="updateCompanyProfileField('phone', $any($event.target).value)" placeholder="(XX) XXXXX-XXXX" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
              </div>
            </div>
             <div class="mt-6 pt-6 border-t border-gray-700">
                <h3 class="text-lg font-semibold text-white mb-4">Personalização do Cardápio Online</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Imagem de Capa (Hero)</label>
                        <label for="cover-upload" class="cursor-pointer group relative block w-full h-40 rounded-lg border-2 border-dashed border-gray-600 hover:border-blue-500 flex items-center justify-center">
                            @if(coverPreviewUrl()) {
                              <img [src]="coverPreviewUrl()" alt="Pré-visualização da capa" class="absolute inset-0 w-full h-full object-cover rounded-lg">
                            }
                            <div class="absolute inset-0 bg-black/50 group-hover:bg-black/70 transition-colors flex flex-col items-center justify-center rounded-lg">
                                <span class="text-white font-semibold">Alterar Imagem de Capa</span>
                                <span class="text-xs text-gray-300">Recomendado: 1280x720 pixels</span>
                            </div>
                        </label>
                        <input id="cover-upload" type="file" class="hidden" (change)="handleCoverFileChange($event)" accept="image/png, image/jpeg, image/webp">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Imagem do Cabeçalho</label>
                        <label for="header-upload" class="cursor-pointer group relative block w-full h-24 rounded-lg border-2 border-dashed border-gray-600 hover:border-blue-500 flex items-center justify-center">
                            @if(headerPreviewUrl()) {
                              <img [src]="headerPreviewUrl()" alt="Pré-visualização do cabeçalho" class="absolute inset-0 w-full h-full object-cover rounded-lg">
                            }
                            <div class="absolute inset-0 bg-black/50 group-hover:bg-black/70 transition-colors flex flex-col items-center justify-center rounded-lg">
                                <span class="text-white font-semibold">Alterar Imagem do Cabeçalho</span>
                                <span class="text-xs text-gray-300">Recomendado: 1280x400 pixels</span>
                            </div>
                        </label>
                        <input id="header-upload" type="file" class="hidden" (change)="handleHeaderFileChange($event)" accept="image/png, image/jpeg, image/webp">
                    </div>
                </div>
            </div>
            <div class="mt-6">
              <button (click)="saveCompanyProfile()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg">Salvar Dados da Empresa</button>
            </div>
          </div>

          <!-- Panel: Subscription Details -->
          @if (subscription(); as sub) {
            <div class="bg-gray-800 rounded-lg p-6">
              <h2 class="text-xl font-semibold text-white mb-4">Detalhes da Assinatura</h2>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                <div class="flex flex-col"><dt class="text-gray-400">Plano Atual</dt><dd class="text-white font-bold text-lg">{{ currentPlan()?.name || 'N/A' }}</dd></div>
                <div class="flex flex-col"><dt class="text-gray-400">Valor</dt><dd class="text-white font-bold text-lg">{{ (currentPlan()?.price | currency:'BRL') || 'N/A' }}</dd></div>
                <div class="flex flex-col"><dt class="text-gray-400">Status</dt><dd class="font-semibold capitalize" [class.text-green-400]="sub.status === 'active' || sub.status === 'trialing'" [class.text-red-400]="sub.status !== 'active' && sub.status !== 'trialing'">{{ sub.status }}</dd></div>
                <div class="flex flex-col"><dt class="text-gray-400">Recorrente</dt><dd class="text-white font-medium">{{ sub.recurrent ? 'Sim' : 'Não' }}</dd></div>
                <div class="flex flex-col sm:col-span-2"><dt class="text-gray-400">Vencimento / Próxima Cobrança</dt><dd class="text-white font-medium">{{ (sub.current_period_end | date:'dd/MM/yyyy') || 'N/A' }}</dd></div>
              </div>
              <div class="mt-4 pt-4 border-t border-gray-700">
                  <a href="https://chefos.koresolucoes.com.br/#/auth/portal" target="_blank" class="w-full text-center block bg-blue-600/80 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">
                      Gerenciar Assinatura
                  </a>
              </div>
            </div>
          }
        }
        @case ('operacao') {
          <!-- Panel: Station Management -->
          <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold text-white mb-4">Estações de Produção (KDS)</h2>
            <div class="mb-6">
              <h3 class="font-semibold text-white mb-2">Adicionar Nova</h3>
              <div class="flex flex-col sm:flex-row gap-2">
                <input type="text" [value]="newStationName()" (input)="newStationName.set($any($event.target).value)" (keydown.enter)="handleAddStation()" placeholder="Nome da Estação" class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button (click)="handleAddStation()" [disabled]="!newStationName().trim()" class="px-4 py-2 font-medium rounded-lg bg-blue-600 hover:bg-blue-500 text-white transition-colors disabled:bg-gray-600">Adicionar</button>
              </div>
            </div>
            <div>
              <h3 class="font-semibold text-white mb-2">Existentes</h3>
              @if (stations().length > 0) {
                <ul class="space-y-2 max-h-60 overflow-y-auto pr-2">
                  @for(item of stations(); track item.id) {
                    <li class="flex items-center justify-between gap-4 bg-gray-700/50 p-3 rounded-lg min-h-[58px]">
                      @if (editingStation()?.id === item.id) {
                        <input type="text" [value]="editingStation()!.name" (input)="updateEditingStationName($event)" (keydown.enter)="saveStation()" (keydown.escape)="cancelEditingStation()" class="flex-1 bg-gray-600 border border-gray-500 rounded-lg px-2 py-1 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="flex items-center gap-2 flex-shrink-0">
                          <button (click)="saveStation()" class="p-2 text-green-400 hover:text-green-300"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></button>
                          <button (click)="cancelEditingStation()" class="p-2 text-gray-400 hover:text-gray-300"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                        </div>
                      } @else if (stationPendingDeletion()?.id === item.id) {
                        <span class="text-sm text-red-300">Certeza?</span>
                        <div class="flex items-center gap-2 flex-shrink-0">
                          <button (click)="confirmDeleteStation()" class="px-3 py-1 font-semibold rounded-md bg-red-600 hover:bg-red-500 text-white text-xs">Sim</button>
                          <button (click)="cancelDeleteStation()" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-500 text-white text-xs">Não</button>
                        </div>
                      } @else {
                        <span class="flex-1 text-white truncate min-w-0" [title]="item.name">{{ item.name }}</span>
                        <div class="flex items-center gap-2 flex-shrink-0">
                          <button (click)="startEditingStation(item)" class="p-2 text-blue-400 hover:text-blue-300"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg></button>
                          <button (click)="requestDeleteStation(item)" class="p-2 text-red-400 hover:text-red-300"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div>
                      }
                    </li>
                  }
                </ul>
              } @else { <p class="text-center text-gray-500 py-4">Nenhuma estação cadastrada.</p> }
            </div>
          </div>
          <!-- Panel: Ingredient Category Management -->
          <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold text-white mb-4">Categorias de Ingredientes</h2>
            <div class="mb-6">
              <h3 class="font-semibold text-white mb-2">Adicionar Nova</h3>
              <div class="flex flex-col sm:flex-row gap-2">
                <input type="text" [value]="newCategoryName()" (input)="newCategoryName.set($any($event.target).value)" (keydown.enter)="handleAddCategory()" placeholder="Nome da Categoria" class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button (click)="handleAddCategory()" [disabled]="!newCategoryName().trim()" class="px-4 py-2 font-medium rounded-lg bg-blue-600 hover:bg-blue-500 text-white transition-colors disabled:bg-gray-600">Adicionar</button>
              </div>
            </div>
            <div>
              <h3 class="font-semibold text-white mb-2">Existentes</h3>
              @if (categories().length > 0) {
                <ul class="space-y-2 max-h-60 overflow-y-auto pr-2">
                  @for(item of categories(); track item.id) {
                    <li class="flex items-center justify-between gap-4 bg-gray-700/50 p-3 rounded-lg min-h-[58px]">
                      @if (editingCategory()?.id === item.id) {
                        <input type="text" [value]="editingCategory()!.name" (input)="updateEditingCategoryName($event)" (keydown.enter)="saveCategory()" (keydown.escape)="cancelEditingCategory()" class="flex-1 bg-gray-600 border border-gray-500 rounded-lg px-2 py-1 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="flex items-center gap-2 flex-shrink-0">
                          <button (click)="saveCategory()" class="p-2 text-green-400 hover:text-green-300"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></button>
                          <button (click)="cancelEditingCategory()" class="p-2 text-gray-400 hover:text-gray-300"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                        </div>
                      } @else if (categoryPendingDeletion()?.id === item.id) {
                        <span class="text-sm text-red-300">Certeza?</span>
                        <div class="flex items-center gap-2 flex-shrink-0">
                          <button (click)="confirmDeleteCategory()" class="px-3 py-1 font-semibold rounded-md bg-red-600 hover:bg-red-500 text-white text-xs">Sim</button>
                          <button (click)="cancelDeleteCategory()" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-500 text-white text-xs">Não</button>
                        </div>
                      } @else {
                        <span class="flex-1 text-white truncate min-w-0" [title]="item.name">{{ item.name }}</span>
                        <div class="flex items-center gap-2 flex-shrink-0">
                          <button (click)="startEditingCategory(item)" class="p-2 text-blue-400 hover:text-blue-300"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg></button>
                          <button (click)="requestDeleteCategory(item)" class="p-2 text-red-400 hover:text-red-300"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div>
                      }
                    </li>
                  }
                </ul>
              } @else { <p class="text-center text-gray-500 py-4">Nenhuma categoria cadastrada.</p> }
            </div>
          </div>
          <!-- Panel: Recipe Category Management -->
          <div class="bg-gray-800 rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-xl font-semibold text-white">Categorias de Pratos (Cardápio)</h2>
              <button (click)="openAddRecipeCategoryModal()" class="bg-blue-600 text-white font-bold py-1 px-3 rounded-lg hover:bg-blue-500 text-sm">Adicionar</button>
            </div>
            <div>
              <h3 class="font-semibold text-white mb-2">Existentes</h3>
              @if (recipeCategories().length > 0) {
                <ul class="space-y-2 max-h-60 overflow-y-auto pr-2">
                  @for(item of recipeCategories(); track item.id) {
                    <li class="flex items-center justify-between gap-4 bg-gray-700/50 p-3 rounded-lg min-h-[58px]">
                      <div class="flex items-center gap-3 flex-1 min-w-0">
                        @if(item.image_url) {
                          <img [src]="item.image_url" [alt]="item.name" class="w-10 h-10 rounded-md object-cover flex-shrink-0">
                        } @else {
                          <div class="w-10 h-10 rounded-md bg-gray-600 flex items-center justify-center flex-shrink-0">
                            <span class="material-symbols-outlined text-gray-500">menu_book</span>
                          </div>
                        }
                        <span class="text-white truncate" [title]="item.name">{{ item.name }}</span>
                      </div>
                      @if (recipeCategoryPendingDeletion()?.id === item.id) {
                        <div class="flex items-center gap-2 flex-shrink-0">
                          <span class="text-sm text-red-300">Certeza?</span>
                          <button (click)="confirmDeleteRecipeCategory()" class="px-3 py-1 font-semibold rounded-md bg-red-600 hover:bg-red-500 text-white text-xs">Sim</button>
                          <button (click)="cancelDeleteRecipeCategory()" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-500 text-white text-xs">Não</button>
                        </div>
                      } @else {
                        <div class="flex items-center gap-2 flex-shrink-0">
                          <button (click)="openEditRecipeCategoryModal(item)" class="p-2 text-blue-400 hover:text-blue-300"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg></button>
                          <button (click)="requestDeleteRecipeCategory(item)" class="p-2 text-red-400 hover:text-red-300"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div>
                      }
                    </li>
                  }
                </ul>
              } @else { <p class="text-center text-gray-500 py-4">Nenhuma categoria encontrada.</p> }
            </div>
          </div>
        }
        @case ('funcionalidades') {
          <!-- iFood Integration -->
          <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold text-white mb-4">Integração iFood</h2>
            <div class="space-y-4">
                <div>
                  <label for="ifood-merchant-id" class="block text-sm font-medium text-gray-300 mb-1">iFood Merchant ID</label>
                  <input type="text" id="ifood-merchant-id" [value]="companyProfileForm().ifood_merchant_id || ''" (input)="updateCompanyProfileField('ifood_merchant_id', $any($event.target).value)" placeholder="Cole seu ID do iFood aqui" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-500">
                  <p class="text-xs text-gray-400 mt-1">Este ID é necessário para que o webhook identifique seu restaurante.</p>
                </div>
                <div>
                  <label for="ifood-webhook-url" class="block text-sm font-medium text-gray-300 mb-1">URL do Webhook</label>
                  <div class="flex gap-2">
                    <input id="ifood-webhook-url" type="text" readonly [value]="webhookUrl" class="w-full bg-gray-900/50 border border-gray-600 rounded-lg px-3 py-2 text-gray-400 text-sm">
                    <button (click)="copyToClipboard(webhookUrl)" class="p-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-white shrink-0" title="Copiar URL">
                      <span class="material-symbols-outlined text-base">content_copy</span>
                    </button>
                  </div>
                  <p class="text-xs text-gray-400 mt-1">Copie esta URL e cole no portal de parceiros iFood.</p>
                </div>
                <div>
                  <button (click)="saveCompanyProfile()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg">Salvar Configurações iFood</button>
                </div>
            </div>
          </div>
          <!-- External Order API -->
          <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold text-white mb-4">API Externa e QR Codes</h2>
            <p class="text-sm text-gray-400 mb-4">Use os dados abaixo para integrar sistemas de terceiros ou gerar QR Codes para seus clientes.</p>
            
            <div class="space-y-6">
              <!-- API Access -->
              <div class="p-4 bg-gray-900/50 rounded-lg space-y-4">
                  <h3 class="text-lg font-semibold text-white">Acesso via API</h3>
                  <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Seu Restaurant ID</label>
                    <div class="flex gap-2">
                      <input type="text" readonly [value]="authService.currentUser()?.id || 'N/A'" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-gray-400 text-sm font-mono">
                      <button (click)="copyToClipboard(authService.currentUser()?.id)" [disabled]="!authService.currentUser()?.id" class="p-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-white shrink-0 disabled:opacity-50" title="Copiar ID">
                        <span class="material-symbols-outlined text-base">content_copy</span>
                      </button>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Sua Chave de API Externa</label>
                    <div class="flex gap-2">
                      <input type="text" readonly [value]="companyProfileForm().external_api_key || 'Nenhuma chave gerada'" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-gray-400 text-sm font-mono">
                      <button (click)="copyToClipboard(companyProfileForm().external_api_key)" [disabled]="!companyProfileForm().external_api_key" class="p-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-white disabled:opacity-50 shrink-0" title="Copiar chave">
                         <span class="material-symbols-outlined text-base">content_copy</span>
                      </button>
                    </div>
                  </div>
                   <div>
                    <button (click)="regenerateApiKey()" class="w-full text-sm font-semibold text-yellow-300 bg-yellow-900/40 hover:bg-yellow-900/60 px-3 py-2 rounded-md transition-colors">
                      Gerar Nova Chave (Invalida a anterior)
                    </button>
                  </div>
              </div>
              <!-- QR Codes -->
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div class="bg-gray-900/50 p-4 rounded-lg flex flex-col items-center">
                    <h3 class="font-semibold text-white mb-2">QR Code do Cardápio</h3>
                    @if(qrCodeUrl()) {
                        <img [src]="qrCodeUrl()" alt="QR Code do Cardápio" width="150" height="150" class="rounded-lg border-2 border-white">
                        <a [href]="qrCodeUrl()" download="qrcode-cardapio.png" class="mt-3 w-full text-center bg-blue-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-blue-500 text-sm">Baixar</a>
                    }
                  </div>
                  <div class="bg-gray-900/50 p-4 rounded-lg flex flex-col items-center">
                    <h3 class="font-semibold text-white mb-2">QR Code de Acesso à API</h3>
                    @if(apiAccessQrCodeUrl()) {
                        <img [src]="apiAccessQrCodeUrl()" alt="QR Code de Acesso à API" width="150" height="150" class="rounded-lg border-2 border-white">
                        <a [href]="apiAccessQrCodeUrl()" download="qrcode-api-acesso.png" class="mt-3 w-full text-center bg-blue-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-blue-500 text-sm">Baixar</a>
                    } @else {
                        <p class="text-center text-xs text-yellow-400 flex-1 flex items-center">Gere uma Chave de API para visualizar o QR Code.</p>
                    }
                  </div>
              </div>
            </div>
          </div>
           <!-- Panel: Loyalty Program -->
          <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold text-white mb-4">Programa de Fidelidade</h2>
            <div class="space-y-4 bg-gray-900/50 p-4 rounded-lg">
                <div class="flex items-center justify-between">
                    <label for="loyalty-enabled" class="font-medium text-white">Ativar Programa de Fidelidade</label>
                    <button type="button" role="switch" id="loyalty-enabled" [attr.aria-checked]="loyaltySettingsForm().is_enabled" (click)="updateLoyaltySettingsField('is_enabled', !loyaltySettingsForm().is_enabled); saveLoyaltySettings()" [class.bg-green-600]="loyaltySettingsForm().is_enabled" [class.bg-gray-600]="!loyaltySettingsForm().is_enabled" class="relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none">
                        <span [class.translate-x-5]="loyaltySettingsForm().is_enabled" [class.translate-x-0]="!loyaltySettingsForm().is_enabled" class="pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200"></span>
                    </button>
                </div>
                <div [class.opacity-50]="!loyaltySettingsForm().is_enabled" [class.pointer-events-none]="!loyaltySettingsForm().is_enabled">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Pontos por R$ 1,00 gasto</label>
                    <div class="flex items-center gap-2">
                        <input type="number" step="0.1" [value]="loyaltySettingsForm().points_per_real" (input)="updateLoyaltySettingsField('points_per_real', +$any($event.target).value)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
                        <button (click)="saveLoyaltySettings()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
                    </div>
                </div>
            </div>
            
            <div class="mt-6" [class.opacity-50]="!loyaltySettingsForm().is_enabled" [class.pointer-events-none]="!loyaltySettingsForm().is_enabled">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">Prêmios e Recompensas</h3>
                    <button (click)="openAddRewardModal()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-3 rounded-lg text-sm">Adicionar Prêmio</button>
                </div>
                 @if (loyaltyRewards().length > 0) {
                  <ul class="space-y-2 max-h-80 overflow-y-auto pr-2">
                    @for(reward of loyaltyRewards(); track reward.id) {
                      <li class="flex items-center justify-between gap-4 bg-gray-700/50 p-3 rounded-lg min-h-[58px]">
                        @if (rewardPendingDeletion()?.id === reward.id) {
                          <span class="text-sm text-red-300">Certeza?</span>
                          <div class="flex items-center gap-2 flex-shrink-0">
                            <button (click)="confirmDeleteReward()" class="px-3 py-1 font-semibold rounded-md bg-red-600 hover:bg-red-500 text-white text-xs">Sim</button>
                            <button (click)="cancelDeleteReward()" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-500 text-white text-xs">Não</button>
                          </div>
                        } @else {
                          <div class="flex-1 min-w-0">
                            <p class="font-semibold text-white">{{reward.name}} - <span class="text-blue-300">{{reward.points_cost}} pts</span></p>
                            <p class="text-xs text-gray-400">{{ getRewardValueLabel(reward) }}</p>
                          </div>
                          <div class="flex items-center gap-2 flex-shrink-0">
                            <button (click)="openEditRewardModal(reward)" class="p-2 text-blue-400 hover:text-blue-300"><span class="material-symbols-outlined text-base">edit</span></button>
                            <button (click)="requestDeleteReward(reward)" class="p-2 text-red-400 hover:text-red-300"><span class="material-symbols-outlined text-base">delete</span></button>
                          </div>
                        }
                      </li>
                    }
                  </ul>
                } @else {
                  <p class="text-center text-gray-500 py-4">Nenhum prêmio cadastrado.</p>
                }
            </div>
          </div>
          <!-- Panel: Reservation Settings -->
          <div class="bg-gray-800 rounded-lg p-6">
              <div class="flex items-center justify-between mb-4">
                  <h2 class="text-xl font-semibold text-white">Config. de Reserva</h2>
                  <button type="button" role="switch" [attr.aria-checked]="reservationForm().is_enabled" (click)="updateReservationFormField('is_enabled', !reservationForm().is_enabled)" [class.bg-green-600]="reservationForm().is_enabled" [class.bg-gray-600]="!reservationForm().is_enabled" class="relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none">
                      <span [class.translate-x-5]="reservationForm().is_enabled" [class.translate-x-0]="!reservationForm().is_enabled" class="pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200"></span>
                  </button>
              </div>
              <div class="space-y-4" [class.opacity-50]="!reservationForm().is_enabled" [class.pointer-events-none]="!reservationForm().is_enabled">
                  <div class="pt-4 border-t border-gray-700 space-y-3">
                    <h3 class="text-md font-semibold text-white">Horário de Funcionamento</h3>
                    @if(reservationForm().weekly_hours; as hours) {
                      @for(day of hours; track day.day_of_week; let i = $index) {
                        <div class="grid grid-cols-3 items-center gap-3 bg-gray-900/50 p-2 rounded-lg">
                          <label [for]="'closed-' + i" class="col-span-3 sm:col-span-1 flex items-center gap-2 text-sm font-medium text-white">
                            <input type="checkbox" [id]="'closed-' + i" [checked]="day.is_closed" (change)="updateWeeklyHours(i, 'is_closed', $any($event.target).checked)" class="h-4 w-4 rounded border-gray-500 text-blue-600">
                            <span>{{ daysOfWeek[day.day_of_week] }}</span>
                            @if(day.is_closed) {
                              <span class="ml-auto text-xs text-red-400 font-bold">FECHADO</span>
                            }
                          </label>
                          <div class="col-span-3 sm:col-span-2 grid grid-cols-2 gap-2">
                            <div>
                              <label class="block text-xs text-gray-400 mb-1">Abre às</label>
                              <input type="time" [value]="day.opening_time" (input)="updateWeeklyHours(i, 'opening_time', $any($event.target).value)" [disabled]="day.is_closed" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-2 py-1 text-white text-sm disabled:opacity-50">
                            </div>
                            <div>
                              <label class="block text-xs text-gray-400 mb-1">Fecha às</label>
                              <input type="time" [value]="day.closing_time" (input)="updateWeeklyHours(i, 'closing_time', $any($event.target).value)" [disabled]="day.is_closed" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-2 py-1 text-white text-sm disabled:opacity-50">
                            </div>
                          </div>
                        </div>
                      }
                    }
                  </div>

                  <div class="grid grid-cols-2 gap-4">
                      <div><label class="block text-sm font-medium text-gray-300 mb-1">Duração (min)</label><input type="number" [value]="reservationForm().booking_duration_minutes" (input)="updateReservationFormField('booking_duration_minutes', +$any($event.target).value)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white"></div>
                      <div><label class="block text-sm font-medium text-gray-300 mb-1">Antecedência (dias)</label><input type="number" [value]="reservationForm().booking_notice_days" (input)="updateReservationFormField('booking_notice_days', +$any($event.target).value)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white"></div>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                      <div><label class="block text-sm font-medium text-gray-300 mb-1">Mín. Pessoas</label><input type="number" [value]="reservationForm().min_party_size" (input)="updateReservationFormField('min_party_size', +$any($event.target).value)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white"></div>
                      <div><label class="block text-sm font-medium text-gray-300 mb-1">Máx. Pessoas</label><input type="number" [value]="reservationForm().max_party_size" (input)="updateReservationFormField('max_party_size', +$any($event.target).value)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white"></div>
                  </div>
              </div>
              <div class="mt-6">
                  <button (click)="saveReservationSettings()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg">Salvar Configurações de Reserva</button>
              </div>
          </div>
        }
        @case ('seguranca') {
          <!-- Panel: Roles and Permissions -->
          <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold text-white mb-4">Cargos e Permissões</h2>
            <div class="mb-6">
              <h3 class="font-semibold text-white mb-2">Adicionar Novo Cargo</h3>
              <div class="flex flex-col sm:flex-row gap-2">
                <input type="text" [value]="newRoleName()" (input)="newRoleName.set($any($event.target).value)" (keydown.enter)="handleAddRole()" placeholder="Nome do Cargo" class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
                <button (click)="handleAddRole()" [disabled]="!newRoleName().trim()" class="px-4 py-2 font-medium rounded-lg bg-blue-600 hover:bg-blue-500 text-white disabled:bg-gray-600">Adicionar</button>
              </div>
            </div>
            <div>
              <h3 class="font-semibold text-white mb-2">Cargos Existentes</h3>
              @if (roles().length > 0) {
                <ul class="space-y-2 max-h-80 overflow-y-auto pr-2">
                  @for(role of roles(); track role.id) {
                    <li class="flex items-center justify-between gap-4 bg-gray-700/50 p-3 rounded-lg min-h-[58px]">
                      @if (rolePendingDeletion()?.id === role.id) {
                        <span class="text-sm text-red-300">Certeza?</span>
                        <div class="flex items-center gap-2 flex-shrink-0">
                          <button (click)="confirmDeleteRole()" class="px-3 py-1 font-semibold rounded-md bg-red-600 hover:bg-red-500 text-white text-xs">Sim</button>
                          <button (click)="cancelDeleteRole()" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-500 text-white text-xs">Não</button>
                        </div>
                      } @else {
                        <span class="flex-1 text-white truncate min-w-0" [title]="role.name">{{ role.name }}</span>
                        <div class="flex items-center gap-2 flex-shrink-0">
                          <button (click)="openPermissionsModal(role)" class="p-2 text-blue-400 hover:text-blue-300" title="Editar Permissões">
                            <span class="material-symbols-outlined text-base">lock_open</span>
                          </button>
                          <button (click)="requestDeleteRole(role)" class="p-2 text-red-400 hover:text-red-300" title="Excluir Cargo" [disabled]="role.name === 'Gerente'">
                            <span class="material-symbols-outlined text-base" [class.opacity-50]="role.name === 'Gerente'">delete</span>
                          </button>
                        </div>
                      }
                    </li>
                  }
                </ul>
              } @else {
                <p class="text-center text-gray-500 py-4">Nenhum cargo personalizado criado.</p>
              }
            </div>
          </div>
        }
      }
    </div>
  </div>
</div>

<!-- Loyalty Reward Modal -->
@if(isRewardModalOpen()) {
  <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" (click)="closeRewardModal()">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg" (click)="$event.stopPropagation()">
      <div class="p-4 border-b border-gray-700"><h3 class="text-xl font-bold text-white">{{ editingReward() ? 'Editar Prêmio' : 'Novo Prêmio' }}</h3></div>
      <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
        <input type="text" [value]="rewardForm().name || ''" (input)="updateRewardFormField('name', $any($event.target).value)" placeholder="Nome do Prêmio" class="w-full bg-gray-700 border-gray-600 rounded-lg p-2 text-white">
        <textarea [value]="rewardForm().description || ''" (input)="updateRewardFormField('description', $any($event.target).value)" placeholder="Descrição (opcional)" rows="2" class="w-full bg-gray-700 border-gray-600 rounded-lg p-2 text-white"></textarea>
        <div class="grid grid-cols-2 gap-4">
          <div><label class="block text-sm text-gray-300 mb-1">Custo em Pontos</label><input type="number" [value]="rewardForm().points_cost" (input)="updateRewardFormField('points_cost', +$any($event.target).value)" class="w-full bg-gray-700 rounded p-2 text-white"></div>
          <div><label class="block text-sm text-gray-300 mb-1">Tipo de Prêmio</label><select [value]="rewardForm().reward_type" (change)="updateRewardFormField('reward_type', $any($event.target).value)" class="w-full bg-gray-700 rounded p-2 text-white">@for(type of availableRewardTypes; track type){<option [value]="type">{{getRewardTypeLabel(type)}}</option>}</select></div>
        </div>
        <div>
          <label class="block text-sm text-gray-300 mb-1">Valor do Prêmio</label>
          @if(rewardForm().reward_type === 'free_item') {
            <select [value]="rewardForm().reward_value" (change)="updateRewardFormField('reward_value', $any($event.target).value)" class="w-full bg-gray-700 rounded p-2 text-white">
              <option value="">Selecione um item...</option>
              @for(recipe of sellableRecipes(); track recipe.id){ <option [value]="recipe.id">{{recipe.name}}</option> }
            </select>
          } @else {
            <input type="number" step="0.01" [value]="rewardForm().reward_value" (input)="updateRewardFormField('reward_value', $any($event.target).value)" class="w-full bg-gray-700 rounded p-2 text-white">
          }
        </div>
        <div class="flex items-center"><input type="checkbox" id="reward_is_active" [checked]="rewardForm().is_active" (change)="updateRewardFormField('is_active', $any($event.target).checked)" class="h-4 w-4 rounded border-gray-500 text-blue-600"><label for="reward_is_active" class="ml-2 text-sm text-gray-200">Ativo</label></div>
      </div>
      <div class="p-4 bg-gray-700/50 flex justify-end gap-3"><button (click)="closeRewardModal()" class="px-4 py-2 font-medium rounded-lg bg-gray-600 hover:bg-gray-500 text-white">Cancelar</button><button (click)="saveReward()" class="px-4 py-2 font-medium rounded-lg bg-blue-600 hover:bg-blue-500 text-white">Salvar Prêmio</button></div>
    </div>
  </div>
}

<!-- Permissions Modal -->
@if (isPermissionsModalOpen() && editingRole(); as role) {
  <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" (click)="closePermissionsModal()">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col border border-gray-700" (click)="$event.stopPropagation()">
      <div class="p-4 border-b border-gray-700">
        <h3 class="text-xl font-bold text-white">Editar Permissões para "{{ role.name }}"</h3>
      </div>
      <div class="p-6 flex-1 overflow-y-auto space-y-6">
        @for (group of permissionGroups(); track group.name) {
          <div>
            <h4 class="text-md font-semibold text-white mb-3 border-b border-gray-700 pb-2">{{ group.name }}</h4>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
              @for (permission of group.permissions; track permission.key) {
                <label class="flex items-center p-3 bg-gray-700/50 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer">
                  <input 
                    type="checkbox"
                    class="h-5 w-5 rounded border-gray-500 text-blue-600 focus:ring-blue-500"
                    [checked]="rolePermissionsForm()[permission.key]"
                    (change)="updatePermission(permission.key, $any($event.target).checked)">
                  <span class="ml-3 text-sm font-medium text-gray-200">{{ permission.label }}</span>
                </label>
              }
            </div>
          </div>
        }
      </div>
      <div class="p-4 bg-gray-700/50 flex justify-end gap-3">
        <button (click)="closePermissionsModal()" class="px-4 py-2 font-medium rounded-lg bg-gray-600 hover:bg-gray-500 text-white">Cancelar</button>
        <button (click)="savePermissions()" class="px-4 py-2 font-medium rounded-lg bg-blue-600 hover:bg-blue-500 text-white">Salvar Permissões</button>
      </div>
    </div>
  </div>
}

<!-- Recipe Category Modal -->
@if(isRecipeCategoryModalOpen()) {
  <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" (click)="closeRecipeCategoryModal()">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md" (click)="$event.stopPropagation()">
      <div class="p-4 border-b border-gray-700">
        <h3 class="text-xl font-bold text-white">{{ editingRecipeCategory() ? 'Editar Categoria' : 'Nova Categoria' }}</h3>
      </div>
      <div class="p-6 space-y-4">
        <div class="flex flex-col items-center gap-2">
            <label for="category-image-upload" class="cursor-pointer">
              @if(recipeCategoryImagePreviewUrl()) {
                <img [src]="recipeCategoryImagePreviewUrl()" alt="Pré-visualização da categoria" class="h-24 w-24 rounded-md object-cover border-2 border-gray-600 hover:opacity-80">
              } @else {
                <div class="h-24 w-24 rounded-md bg-gray-700 flex flex-col items-center justify-center border-2 border-dashed border-gray-500 hover:bg-gray-600 text-gray-500 text-center p-2">
                  <span class="material-symbols-outlined">add_photo_alternate</span>
                   <span class="text-xs mt-1">Imagem</span>
                </div>
              }
            </label>
            <input id="category-image-upload" type="file" class="hidden" (change)="handleRecipeCategoryImageChange($event)" accept="image/png, image/jpeg, image/webp">
        </div>
        <div>
            <label class="block text-sm text-gray-300 mb-1">Nome da Categoria</label>
            <input type="text" [value]="newRecipeCategoryName()" (input)="newRecipeCategoryName.set($any($event.target).value)" class="w-full bg-gray-700 rounded p-2 text-white">
        </div>
      </div>
      <div class="p-4 bg-gray-700/50 flex justify-end gap-3">
        <button (click)="closeRecipeCategoryModal()" class="px-4 py-2 font-medium rounded-lg bg-gray-600 hover:bg-gray-500 text-white">Cancelar</button>
        <button (click)="saveRecipeCategory()" class="px-4 py-2 font-medium rounded-lg bg-blue-600 hover:bg-blue-500 text-white">Salvar</button>
      </div>
    </div>
  </div>
}
<!-- Supplier Modal -->
@if(isSupplierModalOpen()) {
  <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" (click)="closeSupplierModal()">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg" (click)="$event.stopPropagation()">
      <div class="flex justify-between items-center p-4 border-b border-gray-700">
        <h3 class="text-xl font-bold text-white">{{ editingSupplier() ? 'Editar Fornecedor' : 'Novo Fornecedor' }}</h3>
        <button (click)="closeSupplierModal()" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
      </div>
      <div class="p-6 space-y-4">
        <input type="text" [value]="supplierForm().name || ''" (input)="updateSupplierFormField('name', $any($event.target).value)" placeholder="Nome do Fornecedor" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
        <input type="text" [value]="supplierForm().contact_person || ''" (input)="updateSupplierFormField('contact_person', $any($event.target).value)" placeholder="Pessoa de Contato" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
        <input type="text" [value]="supplierForm().phone || ''" (input)="updateSupplierFormField('phone', $any($event.target).value)" placeholder="Telefone" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
        <input type="email" [value]="supplierForm().email || ''" (input)="updateSupplierFormField('email', $any($event.target).value)" placeholder="Email" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
        <input type="text" [value]="supplierForm().address || ''" (input)="updateSupplierFormField('address', $any($event.target).value)" placeholder="Endereço" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
      </div>
      <div class="p-4 bg-gray-700/50 flex justify-end gap-3">
         <button (click)="closeSupplierModal()" class="px-4 py-2 font-medium rounded-lg bg-gray-600 hover:bg-gray-500 text-white">Cancelar</button>
         <button (click)="saveSupplier()" class="px-4 py-2 font-medium rounded-lg bg-blue-600 hover:bg-blue-500 text-white">Salvar</button>
      </div>
    </div>
  </div>
}
