<div class="container mx-auto">
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
    <div>
      <h1 class="text-3xl font-bold text-white">Fichas Técnicas</h1>
      <p class="text-gray-400 mt-1">Gerencie o custo, preparo e ingredientes de seus pratos.</p>
    </div>
    <button (click)="openAddModal()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-500 transition-colors flex items-center gap-2">
      <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
      <span>Nova Ficha Técnica</span>
    </button>
  </div>

  <div class="mb-4 relative">
    <input 
      type="text" 
      [value]="searchTerm()" 
      (input)="searchTerm.set($any($event.target).value)"
      placeholder="Buscar receita pelo nome..." 
      class="w-full bg-gray-800 border border-gray-700 rounded-lg pl-10 pr-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
      <svg class="w-5 h-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
    </div>
  </div>

  @if (filteredRecipes().length === 0) {
    <div class="text-center bg-gray-800 rounded-lg py-16">
      <svg class="mx-auto h-12 w-12 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
      <h3 class="mt-2 text-lg font-medium text-white">Nenhuma ficha técnica encontrada</h3>
      <p class="mt-1 text-sm text-gray-500">Comece criando uma para seus pratos.</p>
    </div>
  } @else {
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      @for(recipe of filteredRecipes(); track recipe.id) {
        <div class="bg-gray-800 rounded-lg p-4 flex flex-col border border-gray-700 hover:border-blue-600 transition-all">
          <div class="flex-1 space-y-2">
            <div>
              <h2 class="font-bold text-white text-lg truncate" [title]="recipe.name">{{ recipe.name }}</h2>
              <p class="text-xs text-gray-400">{{ recipe.is_sub_recipe ? 'Sub-receita' : 'Prato Principal' }}</p>
            </div>
            
            <div class="flex items-center justify-between bg-gray-700/50 rounded-md p-2 text-sm">
                <span class="font-medium text-gray-300">Disponível</span>
                <button
                    type="button"
                    role="switch"
                    [attr.aria-checked]="recipe.is_available"
                    (click)="$event.stopPropagation(); toggleAvailability(recipe)"
                    [class.bg-green-600]="recipe.is_available"
                    [class.bg-gray-600]="!recipe.is_available"
                    class="relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-blue-500">
                    <span
                        aria-hidden="true"
                        [class.translate-x-5]="recipe.is_available"
                        [class.translate-x-0]="!recipe.is_available"
                        class="pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200">
                    </span>
                </button>
            </div>

            <div class="flex justify-between items-center bg-gray-700/50 rounded-md p-2 text-sm">
              <span class="text-gray-300">Custo (CMV)</span>
              <span class="font-semibold text-white">{{ recipe.cost.totalCost | currency:'BRL' }}</span>
            </div>
            @if (!recipe.is_sub_recipe) {
              <div class="flex justify-between items-center bg-gray-700/50 rounded-md p-2 text-sm">
                <span class="text-gray-300">Preço de Venda</span>
                <span class="font-semibold text-green-400">{{ recipe.price | currency:'BRL' }}</span>
              </div>
            }
          </div>
          <div class="mt-4 pt-4 border-t border-gray-700">
            @if (recipePendingDeletion()?.id === recipe.id) {
              <div class="flex justify-between items-center">
                <span class="text-sm text-red-300">Certeza?</span>
                <div class="flex gap-2">
                  <button (click)="$event.stopPropagation(); confirmDelete()" class="px-3 py-1 font-semibold rounded-md bg-red-600 hover:bg-red-500 text-white text-xs">Sim</button>
                  <button (click)="$event.stopPropagation(); cancelDelete()" class="px-3 py-1 rounded-md bg-gray-600 hover:bg-gray-500 text-white text-xs">Não</button>
                </div>
              </div>
            } @else {
              <div class="flex justify-end gap-2">
                <button (click)="$event.stopPropagation(); requestDelete(recipe)" class="text-red-400 hover:text-red-300 font-medium text-sm p-2 rounded-md hover:bg-red-500/10">Deletar</button>
                <button (click)="openEditModal(recipe)" class="text-blue-400 hover:text-blue-300 font-medium text-sm p-2 rounded-md hover:bg-blue-500/10">Editar</button>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }
</div>

<!-- Add/Edit Modal -->
@if (isModalOpen()) {
  <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" (click)="closeModal()">
    <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col border border-gray-700" (click)="$event.stopPropagation()">
      <div class="p-4 border-b border-gray-700 flex justify-between items-center">
        <h3 class="text-xl font-bold text-white">{{ editingRecipe() ? 'Editar Ficha Técnica' : 'Nova Ficha Técnica' }}</h3>
        <button (click)="closeModal()" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"></path></svg></button>
      </div>

      <div class="flex-1 p-6 overflow-y-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Main Form -->
        <div class="lg:col-span-2 space-y-4">
          <!-- Basic Info -->
          <div class="bg-gray-900/50 p-4 rounded-lg space-y-4">
            <div class="flex flex-col sm:flex-row gap-4 items-start">
              <div class="flex-1 space-y-4">
                  <input type="text" [value]="recipeForm().recipe.name || ''" (input)="updateRecipeField('name', $any($event.target).value)" placeholder="Nome do Prato" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white text-lg font-bold">
                  <textarea [value]="recipeForm().recipe.description || ''" (input)="updateRecipeField('description', $any($event.target).value)" placeholder="Descrição do prato para o cardápio..." rows="2" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white text-sm"></textarea>
              </div>
              <div class="flex flex-col items-center gap-2">
                  <label for="recipe-image-upload" class="cursor-pointer">
                      @if(recipeImagePreviewUrl()) {
                        <img [src]="recipeImagePreviewUrl()" alt="Pré-visualização do prato" class="h-28 w-28 rounded-md object-cover border-2 border-gray-600 hover:opacity-80">
                      } @else {
                        <div class="h-28 w-28 rounded-md bg-gray-700 flex flex-col items-center justify-center border-2 border-dashed border-gray-500 hover:bg-gray-600 text-gray-500 text-center p-2">
                          <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                          <span class="text-xs mt-1">Imagem do Prato</span>
                        </div>
                      }
                  </label>
                  <input id="recipe-image-upload" type="file" class="hidden" (change)="handleRecipeImageChange($event)" accept="image/png, image/jpeg, image/webp">
              </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Preço Venda</label>
                <input type="number" [value]="recipeForm().recipe.price ?? 0" (input)="updateRecipeField('price', +$any($event.target).value)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Categoria PDV</label>
                <div class="flex gap-2">
                    <select [value]="recipeForm().recipe.category_id || ''" (change)="updateRecipeField('category_id', $any($event.target).value)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
                    @for(cat of categories(); track cat.id) { <option [value]="cat.id">{{cat.name}}</option> }
                    </select>
                    <button (click)="openAddCategoryModal()" class="p-2 bg-gray-600 hover:bg-gray-500 rounded-lg shrink-0" title="Adicionar nova categoria">+</button>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Tempo Preparo</label>
                <input type="number" [value]="recipeForm().recipe.prep_time_in_minutes ?? 0" (input)="updateRecipeField('prep_time_in_minutes', +$any($event.target).value)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white">
              </div>
              <div class="flex flex-col gap-2 justify-start sm:justify-center items-start pt-2 sm:pt-5">
                  <div class="flex items-center"><input type="checkbox" id="is_sub_recipe" [checked]="recipeForm().recipe.is_sub_recipe" (change)="updateRecipeField('is_sub_recipe', $any($event.target).checked)" class="h-4 w-4 rounded border-gray-500 text-blue-600"><label for="is_sub_recipe" class="ml-2 text-sm text-gray-200">É sub-receita?</label></div>
                  <div class="flex items-center"><input type="checkbox" id="is_available" [checked]="recipeForm().recipe.is_available" (change)="updateRecipeField('is_available', $any($event.target).checked)" class="h-4 w-4 rounded border-gray-500 text-blue-600"><label for="is_available" class="ml-2 text-sm text-gray-200">Disponível?</label></div>
              </div>
            </div>
          </div>

          <!-- Sub-recipe Stock Control -->
          @if (recipeForm().recipe.is_sub_recipe) {
            <div class="bg-gray-900/50 p-4 rounded-lg">
              <h3 class="font-semibold text-white text-md mb-2">Controle de Estoque da Sub-receita</h3>
              <p class="text-sm text-gray-400 mb-3">Vincule esta sub-receita a um item de estoque para controlar a produção e o consumo.</p>
              @if (linkedIngredient(); as ingredient) {
                <div class="bg-gray-700 p-3 rounded-lg flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg>
                    <span class="text-white font-medium">Vinculado ao item: <span class="text-green-300 font-bold">"{{ ingredient.name }}"</span></span>
                  </div>
                  <button (click)="unlinkStockItem()" class="text-xs text-red-400 hover:underline">Desvincular</button>
                </div>
              } @else {
                <button (click)="linkOrCreateStockItem()" class="w-full bg-blue-600/80 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg text-sm flex items-center justify-center gap-2">
                  <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg>
                  <span>Vincular / Criar Item de Estoque</span>
                </button>
              }
            </div>
          }

          <!-- Preparations -->
          <div class="space-y-4">
            @for(prep of recipeForm().preparations; track prep.id) {
              <div class="bg-gray-900/50 p-4 rounded-lg">
                  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-3">
                    <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 flex-1 w-full">
                      <input type="text" [value]="prep.name || ''" (input)="updatePreparationField(prep.id, 'name', $any($event.target).value)" placeholder="Nome da etapa" class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-1 text-white font-semibold">
                      <div class="flex items-center gap-2">
                        <select [value]="prep.station_id || ''" (change)="updatePreparationField(prep.id, 'station_id', $any($event.target).value)" class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-1 text-white text-sm"><option value="">Estação...</option>@for(s of stations(); track s.id){<option [value]="s.id">{{s.name}}</option>}</select>
                        <button (click)="openAddStationModal(prep.id)" class="p-2 h-8 w-8 text-xs bg-gray-600 hover:bg-gray-500 rounded-lg shrink-0" title="Adicionar nova estação">+</button>
                      </div>
                    </div>
                    <button (click)="removePreparation(prep.id)" class="p-1 text-red-400 hover:text-red-300 self-end sm:self-center sm:ml-4"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                  </div>
                  <ul class="space-y-2">
                    @for(ing of getIngredientsForPreparation(prep.id); track ing.ingredient_id) {
                      <li class="flex items-center gap-2 text-sm">
                        <span class="flex-1 text-gray-300">{{getIngredientName(ing.ingredient_id)}}</span>
                        <input type="number" [value]="ing.quantity" (change)="updateFormIngredient(prep.id, ing.ingredient_id, +$any($event.target).value)" class="w-20 bg-gray-700 rounded-md p-1 text-center">
                        <select [value]="ing.unit" (change)="updateFormIngredientUnit(prep.id, ing.ingredient_id, $any($event.target).value)" class="w-16 bg-gray-700 rounded-md p-1 text-center text-gray-400">
                            @for(unit of getCompatibleUnits(getIngredientUnit(ing.ingredient_id)); track unit) {
                                <option [value]="unit">{{unit}}</option>
                            }
                        </select>
                        <button (click)="removeFormIngredient(prep.id, ing.ingredient_id)" class="text-red-500 hover:text-red-400 p-1"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M6 18L18 6M6 6l12 12" /></svg></button>
                      </li>
                    }
                  </ul>
                  <div class="relative mt-2">
                      <button (click)="startAddingItem(prep.id)" class="w-full text-left text-sm p-2 bg-gray-700/50 hover:bg-gray-700 rounded-lg text-blue-400">+ Adicionar Ingrediente nesta Etapa</button>
                  </div>
              </div>
            }
             <div class="bg-gray-900/50 p-4 rounded-lg">
                <h3 class="font-semibold text-white mb-2">Sub-receitas</h3>
                <ul class="space-y-2">
                  @for(sr of recipeForm().subRecipes; track sr.child_recipe_id) {
                     <li class="flex items-center gap-2 text-sm">
                        <span class="flex-1 text-gray-300">{{getSubRecipeName(sr.child_recipe_id)}}</span>
                        <input type="number" [value]="sr.quantity" (change)="updateFormSubRecipe(sr.child_recipe_id, +$any($event.target).value)" class="w-20 bg-gray-700 rounded-md p-1 text-center">
                        <span class="w-12 text-gray-400">un</span>
                        <button (click)="removeFormSubRecipe(sr.child_recipe_id)" class="text-red-500 hover:text-red-400 p-1"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M6 18L18 6M6 6l12 12" /></svg></button>
                      </li>
                  }
                </ul>
                 <div class="relative mt-2">
                    <button (click)="startAddingItem('sub-recipe')" class="w-full text-left text-sm p-2 bg-gray-700/50 hover:bg-gray-700 rounded-lg text-blue-400">+ Adicionar Sub-receita</button>
                 </div>
             </div>
            <button (click)="addPreparation()" class="w-full p-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg">+ Adicionar Etapa de Preparação</button>
          </div>
        </div>
        <!-- Right Column: Cost & AI -->
        <div class="lg:col-span-1 space-y-4">
            <div class="bg-gray-900/50 p-4 rounded-lg lg:sticky top-0">
                <h3 class="font-semibold text-white text-lg mb-2">Análise de Custos</h3>
                <div class="flex justify-between items-center text-3xl font-bold border-t border-b border-gray-700 py-3 my-3">
                  <span class="text-gray-300">CMV</span>
                  <span class="text-white">{{ formTotalCost() | currency:'BRL' }}</span>
                </div>
            </div>
             <div class="bg-gray-900/50 p-4 rounded-lg">
                <h3 class="font-semibold text-white text-lg mb-2">Otimização com IA</h3>
                <button (click)="getMiseEnPlaceSuggestions()" [disabled]="isAiLoading()" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-500 flex items-center justify-center gap-2 disabled:opacity-50">
                  @if(isAiLoading()) { <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Gerando... }
                  @else { <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.562L16.25 22.5l-.648-1.938a3.375 3.375 0 00-2.672-2.672L11.25 18l1.938-.648a3.375 3.375 0 002.672-2.672L16.25 13.5l.648 1.938a3.375 3.375 0 002.672 2.672L21.75 18l-1.938.648a3.375 3.375 0 00-2.672 2.672z" /></svg> Sugestões de Mise en Place }
                </button>
                 @if(aiSuggestions(); as suggestions) {
                    <div class="mt-4 text-sm text-gray-300 border-t border-gray-700 pt-4 prose prose-invert" [innerHTML]="suggestions"></div>
                 }
            </div>
        </div>
      </div>

      <div class="p-4 bg-gray-900/50 flex flex-col-reverse sm:flex-row sm:justify-end gap-3 border-t border-gray-700">
         <button (click)="closeModal()" class="w-full sm:w-auto px-6 py-2 font-medium rounded-lg bg-gray-600 hover:bg-gray-500 text-white">Cancelar</button>
         <button (click)="saveTechnicalSheet()" class="w-full sm:w-auto px-6 py-2 font-bold rounded-lg bg-blue-600 hover:bg-blue-500 text-white">Salvar Ficha Técnica</button>
      </div>
    </div>
  </div>
}

<!-- Add Item Search Popover -->
@if(addingToPreparationId(); as prepId) {
    <div class="fixed inset-0 bg-black/70 z-[60] flex items-center justify-center p-4" (click)="stopAddingItem()">
      <div class="bg-gray-800 border border-gray-600 rounded-lg shadow-lg w-full max-w-sm" (click)="$event.stopPropagation()">
        <div class="p-4">
          <h4 class="font-semibold text-white mb-2">Adicionar a {{ getAddingToPreparationName(addingToPreparationId()) }}</h4>
          <input type="text" [value]="itemSearchTerm()" (input)="itemSearchTerm.set($any($event.target).value)" placeholder="Buscar..." class="w-full bg-gray-700 rounded-lg p-2 mb-2 text-white">
          <div class="max-h-60 overflow-y-auto">
            @if(filteredItemsForAdding().ingredients.length > 0) {
              <h5 class="text-xs text-gray-400 font-bold uppercase mt-2 mb-1">Ingredientes</h5>
              <ul>@for(ing of filteredItemsForAdding().ingredients; track ing.id){<li (click)="addIngredientToPrep(ing)" class="p-2 text-sm rounded-md hover:bg-gray-700 cursor-pointer">{{ing.name}}</li>}</ul>
            }
            @if(filteredItemsForAdding().subRecipes.length > 0) {
                <h5 class="text-xs text-gray-400 font-bold uppercase mt-2 mb-1">Sub-Receitas</h5>
                <ul>@for(sub of filteredItemsForAdding().subRecipes; track sub.id){<li (click)="addSubRecipeToPrep(sub)" class="p-2 text-sm rounded-md hover:bg-gray-700 cursor-pointer">{{sub.name}}</li>}</ul>
            }
          </div>
        </div>
        @if(addingToPreparationId() !== 'sub-recipe') {
          <div class="border-t border-gray-700 p-2 text-center">
              <button (click)="openAddIngredientModal()" class="text-sm text-blue-400 hover:underline">Não encontrou? Cadastre um novo ingrediente.</button>
          </div>
        }
      </div>
    </div>
}

<!-- "Add on the fly" Modals -->
@if (isAddingCategory()) {
  <div class="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4" (click)="closeAddCategoryModal()">
    <div class="bg-gray-700 rounded-lg p-6 w-full max-w-sm" (click)="$event.stopPropagation()">
      <h4 class="text-lg font-semibold text-white mb-4">Nova Categoria de Prato</h4>
      <input type="text" [value]="newCategoryName()" (input)="newCategoryName.set($any($event.target).value)" (keydown.enter)="saveNewCategory()" placeholder="Ex: Bebidas" class="w-full bg-gray-600 rounded-lg p-2 text-white">
      <div class="flex justify-end gap-2 mt-4">
        <button (click)="closeAddCategoryModal()" class="px-4 py-2 text-sm rounded-lg bg-gray-500 hover:bg-gray-400">Cancelar</button>
        <button (click)="saveNewCategory()" class="px-4 py-2 text-sm rounded-lg bg-blue-600 hover:bg-blue-500">Salvar</button>
      </div>
    </div>
  </div>
}
@if (isAddingStation()) {
  <div class="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4" (click)="closeAddStationModal()">
    <div class="bg-gray-700 rounded-lg p-6 w-full max-w-sm" (click)="$event.stopPropagation()">
      <h4 class="text-lg font-semibold text-white mb-4">Nova Estação de Produção</h4>
      <input type="text" [value]="newStationName()" (input)="newStationName.set($any($event.target).value)" (keydown.enter)="saveNewStation()" placeholder="Ex: Cozinha Principal" class="w-full bg-gray-600 rounded-lg p-2 text-white">
      <div class="flex justify-end gap-2 mt-4">
        <button (click)="closeAddStationModal()" class="px-4 py-2 text-sm rounded-lg bg-gray-500 hover:bg-gray-400">Cancelar</button>
        <button (click)="saveNewStation()" class="px-4 py-2 text-sm rounded-lg bg-blue-600 hover:bg-blue-500">Salvar</button>
      </div>
    </div>
  </div>
}
@if (isAddingIngredient()) {
  <div class="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4" (click)="closeAddIngredientModal()">
    <div class="bg-gray-700 rounded-lg w-full max-w-md" (click)="$event.stopPropagation()">
      <div class="p-4 border-b border-gray-600"><h4 class="text-lg font-semibold text-white">Novo Ingrediente</h4></div>
      <div class="p-6 space-y-4">
          <input type="text" [value]="newIngredientForm().name || ''" (input)="updateNewIngredientField('name', $any($event.target).value)" placeholder="Nome do Ingrediente" class="w-full bg-gray-600 rounded-lg p-2 text-white">
          <div class="grid grid-cols-2 gap-4">
            <input type="number" [value]="newIngredientForm().cost ?? 0" (input)="updateNewIngredientField('cost', +$any($event.target).value)" placeholder="Custo Unitário" class="w-full bg-gray-600 rounded-lg p-2 text-white">
            <select [value]="newIngredientForm().unit || 'un'" (change)="updateNewIngredientField('unit', $any($event.target).value)" class="w-full bg-gray-600 rounded-lg p-2 text-white">
                @for(unit of availableUnits; track unit) { <option [value]="unit">{{unit}}</option> }
            </select>
          </div>
      </div>
      <div class="p-4 bg-gray-600/50 flex justify-end gap-2">
        <button (click)="closeAddIngredientModal()" class="px-4 py-2 text-sm rounded-lg bg-gray-500 hover:bg-gray-400">Cancelar</button>
        <button (click)="saveNewIngredient()" class="px-4 py-2 text-sm rounded-lg bg-blue-600 hover:bg-blue-500">Salvar Ingrediente</button>
      </div>
    </div>
  </div>
}
