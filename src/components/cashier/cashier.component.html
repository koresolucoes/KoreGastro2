


<div class="h-full flex flex-col relative bg-gray-900">
  
  <!-- Top Header / Navigation (Desktop) -->
  <div class="hidden md:flex justify-between items-center p-6 pb-2 no-print">
    <div>
      <h1 class="text-3xl font-bold text-white tracking-tight">Caixa</h1>
      <p class="text-gray-400 text-sm">Gerenciamento financeiro e pagamentos</p>
    </div>
    
    <div class="flex bg-gray-800/50 p-1 rounded-xl border border-white/5 backdrop-blur-sm">
      <button (click)="view.set('payingTables')" 
              class="px-5 py-2.5 rounded-lg text-sm font-semibold transition-all duration-300 flex items-center gap-2"
              [class.bg-blue-600]="view() === 'payingTables'" 
              [class.text-white]="view() === 'payingTables'" 
              [class.text-gray-400]="view() !== 'payingTables'"
              [class.hover:text-white]="view() !== 'payingTables'">
        <span class="material-symbols-outlined text-lg">payments</span>
        A Receber
        @if(tablesForPayment().length > 0) {
          <span class="ml-1 bg-white text-blue-600 text-xs font-bold px-1.5 rounded-full">{{ tablesForPayment().length }}</span>
        }
      </button>
      <button (click)="view.set('quickSale')" 
              class="px-5 py-2.5 rounded-lg text-sm font-semibold transition-all duration-300 flex items-center gap-2"
              [class.bg-blue-600]="view() === 'quickSale'" 
              [class.text-white]="view() === 'quickSale'" 
              [class.text-gray-400]="view() !== 'quickSale'"
              [class.hover:text-white]="view() !== 'quickSale'">
        <span class="material-symbols-outlined text-lg">point_of_sale</span>
        Venda Rápida
      </button>
      <button (click)="view.set('cashDrawer')" 
              class="px-5 py-2.5 rounded-lg text-sm font-semibold transition-all duration-300 flex items-center gap-2"
              [class.bg-blue-600]="view() === 'cashDrawer'" 
              [class.text-white]="view() === 'cashDrawer'" 
              [class.text-gray-400]="view() !== 'cashDrawer'"
              [class.hover:text-white]="view() !== 'cashDrawer'">
        <span class="material-symbols-outlined text-lg">account_balance_wallet</span>
        Gaveta & Fechamento
      </button>
      <button (click)="view.set('reprint')" 
              class="px-5 py-2.5 rounded-lg text-sm font-semibold transition-all duration-300 flex items-center gap-2"
              [class.bg-blue-600]="view() === 'reprint'" 
              [class.text-white]="view() === 'reprint'" 
              [class.text-gray-400]="view() !== 'reprint'"
              [class.hover:text-white]="view() !== 'reprint'">
        <span class="material-symbols-outlined text-lg">history</span>
        Histórico
      </button>
    </div>
  </div>

  <!-- Mobile Header -->
  <div class="md:hidden p-4 pb-2 flex justify-between items-center bg-gray-900 border-b border-gray-800 sticky top-0 z-20">
    <h1 class="text-xl font-bold text-white">Caixa</h1>
    <div class="bg-blue-600/20 text-blue-400 px-3 py-1 rounded-full text-xs font-bold border border-blue-500/30">
      {{ view() === 'payingTables' ? 'A Receber' : (view() === 'quickSale' ? 'Venda Rápida' : (view() === 'cashDrawer' ? 'Fechamento' : 'Histórico')) }}
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="flex-1 overflow-y-auto p-4 md:p-6 pb-24 md:pb-6 scroll-smooth">
    @if (isLoading()) {
      <div class="flex items-center justify-center h-full">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
      </div>
    } @else {
      @switch (view()) {
        <!-- VIEW: A RECEBER (Mesas) -->
        @case ('payingTables') {
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-full">
            <!-- Section: Tables -->
            <div class="flex flex-col h-full">
              <h2 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-yellow-400">table_restaurant</span>
                Mesas Aguardando
              </h2>
              
              @if(tablesForPayment().length > 0) {
                <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4">
                  @for(table of tablesForPayment(); track table.id) {
                    <div class="group relative bg-gray-800 rounded-xl overflow-hidden border border-white/5 hover:border-blue-500/50 transition-all duration-300 shadow-lg hover:shadow-blue-900/10 cursor-pointer"
                         (click)="openTableOptionsModal(table)">
                      
                      <!-- Ticket Perforation Effect Top -->
                      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent to-transparent bg-[length:10px_100%] bg-[position:5px_0] before:content-[''] before:absolute before:top-[-5px] before:left-0 before:right-0 before:h-[10px] before:bg-gray-900 before:[mask-image:radial-gradient(circle,transparent_4px,black_5px)] before:[mask-size:10px_10px] before:[mask-repeat:repeat-x]"></div>

                      <div class="p-5 flex flex-col items-center justify-center min-h-[160px]">
                        <div class="text-4xl font-black text-white mb-1">{{ table.number }}</div>
                        <div class="text-xs font-semibold uppercase tracking-wider text-blue-400 mb-4 animate-pulse">Pagamento Solicitado</div>
                        
                        <!-- Actions Grid (Visible on Desktop Hover / Always on Mobile Modal) -->
                        <div class="w-full grid grid-cols-2 gap-2 mt-auto opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity duration-200">
                          <button (click)="$event.stopPropagation(); openPaymentForTable(table)" class="col-span-2 bg-green-600 hover:bg-green-500 text-white py-2 rounded-lg text-sm font-bold shadow-lg shadow-green-900/20">
                            Cobrar
                          </button>
                          <button (click)="$event.stopPropagation(); openPreBillForTable(table)" class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg text-xs font-medium">
                            Pré-conta
                          </button>
                          <button (click)="$event.stopPropagation(); reopenTable(table)" class="bg-gray-700 hover:bg-gray-600 text-yellow-400 py-2 rounded-lg text-xs font-medium">
                            Reabrir
                          </button>
                        </div>
                        
                        <!-- Wait Time Pill (Always Visible) -->
                        <div class="absolute top-3 right-3 bg-gray-900/80 text-gray-400 text-[10px] px-2 py-0.5 rounded-full border border-gray-700 font-mono">
                           {{ getElapsedTime(table) }}
                        </div>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="flex-1 flex flex-col items-center justify-center text-center p-8 border-2 border-dashed border-gray-800 rounded-2xl">
                  <div class="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center mb-4 text-gray-600">
                    <span class="material-symbols-outlined text-4xl">check</span>
                  </div>
                  <h3 class="text-lg font-medium text-gray-300">Tudo limpo!</h3>
                  <p class="text-sm text-gray-500 mt-1">Nenhuma mesa solicitou pagamento.</p>
                </div>
              }
            </div>

            <!-- Section: Quick Sales -->
            <div class="flex flex-col h-full mt-8 lg:mt-0">
               <h2 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-purple-400">fastfood</span>
                Vendas Rápidas (Balcão)
              </h2>
               @if(quickSalesForPayment().length > 0) {
                <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4">
                   @for(order of quickSalesForPayment(); track order.id) {
                    @let progress = getOrderProgress(order);
                    <div (click)="openPaymentForQuickSale(order)" 
                         class="relative bg-gray-800 rounded-xl p-5 border border-gray-700 hover:border-purple-500/50 cursor-pointer transition-all hover:scale-[1.02]">
                       
                       <div class="flex justify-between items-start mb-2">
                          <div>
                             <span class="text-xs font-mono text-gray-500">#{{ order.id.slice(0, 4) }}</span>
                             <h4 class="font-bold text-white text-lg">Caixa</h4>
                          </div>
                          @if(progress.isAllReady) {
                             <span class="material-symbols-outlined text-green-400 animate-bounce">check_circle</span>
                          } @else {
                             <span class="material-symbols-outlined text-purple-400">skillet</span>
                          }
                       </div>

                       @if(order.customers) {
                         <p class="text-sm text-gray-300 mb-3 truncate">{{ order.customers.name }}</p>
                       }

                       <!-- Progress Bar -->
                       <div class="w-full bg-gray-700 rounded-full h-1.5 mb-2 overflow-hidden">
                          <div class="bg-gradient-to-r from-purple-500 to-blue-500 h-full rounded-full transition-all duration-500" [style.width.%]="progress.percentage"></div>
                       </div>
                       
                       <div class="flex justify-between text-[10px] text-gray-400 font-medium uppercase tracking-wide">
                          <span>{{ progress.isAllReady ? 'Pronto p/ Retirar' : 'Em Preparo' }}</span>
                          <span>{{ getOrderTotal(order) | currency:'BRL' }}</span>
                       </div>
                    </div>
                  }
                </div>
               } @else {
                  <div class="flex-1 flex flex-col items-center justify-center text-center p-8 border-2 border-dashed border-gray-800 rounded-2xl">
                     <p class="text-sm text-gray-500">Nenhuma venda rápida em aberto.</p>
                  </div>
               }
            </div>
          </div>
        }

        <!-- VIEW: VENDA RÁPIDA -->
        @case ('quickSale') {
          <div class="h-full flex flex-col lg:flex-row gap-6">
            <!-- Left: Product Grid -->
            <div class="flex-1 flex flex-col bg-gray-800/50 border border-gray-700/50 rounded-2xl overflow-hidden backdrop-blur-sm">
              <!-- Search & Filter -->
              <div class="p-4 border-b border-gray-700/50 bg-gray-800/80 sticky top-0 z-10">
                <div class="relative mb-4">
                   <span class="absolute left-3 top-1/2 -translate-y-1/2 material-symbols-outlined text-gray-400">search</span>
                   <input type="text" [value]="recipeSearchTerm()" (input)="recipeSearchTerm.set($any($event.target).value)" 
                          placeholder="Buscar item pelo nome ou código..." 
                          class="w-full bg-gray-900 border border-gray-700 rounded-xl pl-10 pr-4 py-3 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-500">
                </div>
                <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-1">
                  <button (click)="selectCategory(null)" class="px-4 py-1.5 rounded-full text-xs font-bold transition-colors whitespace-nowrap" 
                          [class.bg-white]="selectedCategory() === null" [class.text-gray-900]="selectedCategory() === null"
                          [class.bg-gray-700]="selectedCategory() !== null" [class.text-gray-300]="selectedCategory() !== null">
                    Todos
                  </button>
                  @for (category of categories(); track category.id) {
                    <button (click)="selectCategory(category)" class="px-4 py-1.5 rounded-full text-xs font-bold transition-colors whitespace-nowrap"
                            [class.bg-white]="selectedCategory()?.id === category.id" [class.text-gray-900]="selectedCategory()?.id === category.id"
                            [class.bg-gray-700]="selectedCategory()?.id !== category.id" [class.text-gray-300]="selectedCategory()?.id !== category.id">
                      {{ category.name }}
                    </button>
                  }
                </div>
              </div>

              <!-- Grid -->
              <div class="flex-1 overflow-y-auto p-4">
                 <div class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 gap-3">
                    @for (recipe of filteredRecipes(); track recipe.id) {
                       <div (click)="addToCart(recipe)" 
                            class="bg-gray-800 border border-gray-700 hover:border-blue-500 rounded-xl p-3 cursor-pointer transition-all active:scale-95 group flex flex-col justify-between h-28 relative overflow-hidden"
                            [class.opacity-50]="!recipe.hasStock" [class.pointer-events-none]="!recipe.hasStock">
                          
                          @if(!recipe.hasStock) {
                             <div class="absolute inset-0 flex items-center justify-center bg-gray-900/80 z-10 font-bold text-red-500 text-xs uppercase transform -rotate-12 border-2 border-red-500 rounded-lg m-2">Sem Estoque</div>
                          }

                          <h3 class="text-sm font-semibold text-white leading-tight line-clamp-2 group-hover:text-blue-300">{{ recipe.name }}</h3>
                          <div class="flex justify-between items-end mt-2">
                             <span class="text-xs text-gray-500 font-mono">{{ recipe.external_code }}</span>
                             <span class="font-bold text-green-400">{{ (recipePrices().get(recipe.id) || recipe.price) | currency:'BRL' }}</span>
                          </div>
                       </div>
                    }
                 </div>
              </div>
            </div>

            <!-- Right: Cart (Always Visible on Desktop, toggleable on Mobile via logic or bottom sheet in future) -->
            <div class="w-full lg:w-96 bg-gray-800 rounded-2xl flex flex-col border border-gray-700 shadow-2xl">
               <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800 rounded-t-2xl">
                  <h2 class="font-bold text-white flex items-center gap-2"><span class="material-symbols-outlined text-blue-400">shopping_cart</span> Carrinho</h2>
                  @if(quickSaleCustomer(); as customer) {
                     <div class="flex items-center gap-2 bg-blue-900/30 px-2 py-1 rounded text-xs text-blue-200 border border-blue-800">
                        <span class="truncate max-w-[80px]">{{ customer.name }}</span>
                        <button (click)="removeQuickSaleCustomer()" class="hover:text-white font-bold">&times;</button>
                     </div>
                  } @else {
                     <button (click)="isCustomerSelectModalOpen.set(true)" class="text-xs font-semibold text-blue-400 hover:text-blue-300">+ Cliente</button>
                  }
               </div>

               <div class="flex-1 overflow-y-auto p-2 space-y-2">
                  @if(quickSaleCart().length === 0) {
                     <div class="h-full flex flex-col items-center justify-center text-gray-600">
                        <span class="material-symbols-outlined text-4xl mb-2 opacity-50">remove_shopping_cart</span>
                        <p class="text-sm">Carrinho vazio</p>
                     </div>
                  } @else {
                     @for(item of quickSaleCart(); track item.id) {
                        <div class="flex items-center justify-between p-3 bg-gray-700/30 rounded-lg group hover:bg-gray-700/60 transition-colors">
                           <div class="flex flex-col flex-1 min-w-0 mr-2">
                              <span class="text-white font-medium text-sm truncate">{{ item.recipe.name }}</span>
                              <span class="text-xs text-gray-500">{{ (item.recipe.price) | currency:'BRL' }} un.</span>
                           </div>
                           <div class="flex items-center gap-3">
                              <div class="flex items-center bg-gray-800 rounded-lg p-0.5 border border-gray-600">
                                 <button (click)="removeFromCart(item.recipe.id)" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-600 rounded text-xs">-</button>
                                 <span class="w-6 text-center text-xs font-bold text-white">{{ item.quantity }}</span>
                                 <button (click)="addToCart(item.recipe)" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-white hover:bg-gray-600 rounded text-xs">+</button>
                              </div>
                              <span class="font-bold text-white text-sm w-16 text-right">{{ (item.recipe.price * item.quantity) | currency:'BRL' }}</span>
                           </div>
                        </div>
                     }
                  }
               </div>

               <div class="p-4 bg-gray-900 border-t border-gray-700 rounded-b-2xl">
                  <div class="flex justify-between items-end mb-4">
                     <span class="text-gray-400 text-sm">Total</span>
                     <span class="text-2xl font-black text-white">{{ cartTotal() | currency:'BRL' }}</span>
                  </div>
                  <div class="grid grid-cols-2 gap-3">
                     <button (click)="sendQuickSaleToKitchen()" [disabled]="quickSaleCart().length === 0" class="py-3 rounded-xl font-bold text-sm bg-gray-700 hover:bg-gray-600 text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed border border-gray-600">
                        Cozinha
                     </button>
                     <button (click)="openQuickSalePaymentModal()" [disabled]="quickSaleCart().length === 0" class="py-3 rounded-xl font-bold text-sm bg-green-600 hover:bg-green-500 text-white shadow-lg shadow-green-900/30 transition-all hover:translate-y-[-1px] active:translate-y-[1px] disabled:opacity-50 disabled:cursor-not-allowed">
                        Receber
                     </button>
                  </div>
               </div>
            </div>
          </div>
        }

        <!-- VIEW: FECHAMENTO DE CAIXA -->
        @case ('cashDrawer') {
           <div class="h-full grid grid-cols-1 lg:grid-cols-3 gap-6">
              <!-- Timeline (Left) -->
              <div class="lg:col-span-1 bg-gray-800 rounded-2xl p-6 border border-gray-700/50 flex flex-col overflow-hidden">
                 <h2 class="text-lg font-bold text-white mb-6 border-b border-gray-700 pb-2">Linha do Tempo</h2>
                 <div class="flex-1 overflow-y-auto pr-2 relative">
                    <!-- Vertical Line -->
                    <div class="absolute left-3.5 top-2 bottom-2 w-0.5 bg-gray-700"></div>

                    @if(revenueTransactions().length === 0 && expenseTransactions().length === 0) {
                         <p class="text-center text-gray-500 mt-10">Nenhuma movimentação hoje.</p>
                    }
                    
                    <div class="space-y-6">
                        <!-- Initial Balance Node -->
                        <div class="relative pl-10">
                            <div class="absolute left-1 top-1 w-5 h-5 rounded-full bg-blue-900 border-2 border-blue-500 z-10 flex items-center justify-center">
                                <span class="block w-1.5 h-1.5 bg-blue-400 rounded-full"></span>
                            </div>
                            <p class="text-xs text-gray-400 font-mono">Início do Dia</p>
                            <p class="text-sm text-white font-medium">Abertura: {{ openingBalance() | currency:'BRL' }}</p>
                        </div>

                        <!-- Combined Transactions Sorted by Date (Assuming transactions are sorted in signal) -->
                        @for(t of cashierState.transactions(); track t.id) {
                            @if(t.type !== 'Abertura de Caixa') {
                                <div class="relative pl-10 group">
                                    <div class="absolute left-1 top-1 w-5 h-5 rounded-full border-2 z-10 flex items-center justify-center bg-gray-900" 
                                         [class.border-green-500]="t.type === 'Receita'" 
                                         [class.border-red-500]="t.type === 'Despesa'"
                                         [class.border-yellow-500]="t.type === 'Gorjeta'">
                                        <span class="material-symbols-outlined text-[10px]" [class.text-green-500]="t.type === 'Receita'" [class.text-red-500]="t.type === 'Despesa'" [class.text-yellow-500]="t.type === 'Gorjeta'">
                                            {{ t.type === 'Receita' ? 'arrow_upward' : (t.type === 'Despesa' ? 'arrow_downward' : 'star') }}
                                        </span>
                                    </div>
                                    <p class="text-[10px] text-gray-500 font-mono">{{ t.date | date:'HH:mm' }}</p>
                                    <p class="text-sm text-gray-200 font-medium group-hover:text-white transition-colors">{{ t.description }}</p>
                                    <p class="text-sm font-bold" [class.text-green-400]="t.type === 'Receita' || t.type === 'Gorjeta'" [class.text-red-400]="t.type === 'Despesa'">
                                        {{ t.type === 'Despesa' ? '-' : '+' }} {{ t.amount | currency:'BRL' }}
                                    </p>
                                </div>
                            }
                        }
                    </div>
                 </div>
              </div>

              <!-- Summary & Actions (Center/Right) -->
              <div class="lg:col-span-2 flex flex-col gap-6">
                 <!-- Summary Cards -->
                 <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-blue-500">
                        <p class="text-xs text-gray-400 uppercase font-bold">Saldo Inicial</p>
                        <p class="text-2xl font-bold text-white mt-1">{{ openingBalance() | currency:'BRL' }}</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-green-500">
                        <p class="text-xs text-gray-400 uppercase font-bold">Entradas</p>
                        <p class="text-2xl font-bold text-green-400 mt-1">{{ totalRevenue() | currency:'BRL' }}</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-xl border-l-4 border-red-500">
                        <p class="text-xs text-gray-400 uppercase font-bold">Saídas</p>
                        <p class="text-2xl font-bold text-red-400 mt-1">{{ totalExpenses() | currency:'BRL' }}</p>
                    </div>
                     <!-- Removing "Expected" card to focus on closing modal detail -->
                 </div>

                 <!-- Expense/Sangria Form -->
                 <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                    <h3 class="text-lg font-bold text-white mb-4">Lançamentos de Caixa (Sangria/Suprimento)</h3>
                    <div class="flex gap-3 items-end">
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-gray-400 mb-1">Descrição</label>
                            <input type="text" [value]="newExpenseDescription()" (input)="newExpenseDescription.set($any($event.target).value)" placeholder="Ex: Compra de Gelo" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-red-500 outline-none">
                        </div>
                         <div class="w-32">
                            <label class="block text-xs font-medium text-gray-400 mb-1">Valor</label>
                            <input type="number" [value]="newExpenseAmount()" (input)="newExpenseAmount.set(+$any($event.target).value)" placeholder="0.00" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-red-500 outline-none">
                        </div>
                        <button (click)="handleLogExpense()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors h-[42px]">
                            Despesa
                        </button>
                        <button (click)="handleLogExpense(true)" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg transition-colors h-[42px] flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">money_off</span> Sangria
                        </button>
                    </div>
                 </div>

                 <!-- Closing Action -->
                 <div class="bg-gradient-to-r from-gray-800 to-gray-800/50 rounded-xl p-6 border border-gray-700 flex flex-col md:flex-row justify-between items-center gap-4 mt-auto">
                    <div>
                        <h3 class="text-lg font-bold text-white">Fechar o Caixa</h3>
                        <p class="text-sm text-gray-400">Inicie o assistente de conferência para encerrar o dia e zerar o painel.</p>
                    </div>
                    <button (click)="openClosingModal()" class="px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg shadow-blue-900/20 transition-transform active:scale-95">
                        Iniciar Fechamento
                    </button>
                 </div>
              </div>
           </div>
        }

        <!-- VIEW: HISTÓRICO -->
        @case ('reprint') {
          <div class="bg-gray-800 rounded-2xl h-full flex flex-col border border-gray-700">
            <div class="p-6 border-b border-gray-700 flex flex-col sm:flex-row justify-between items-center gap-4">
                <h2 class="text-xl font-bold text-white">Vendas Finalizadas</h2>
                <div class="flex gap-2">
                    <input type="date" [value]="completedOrdersStartDate()" (change)="completedOrdersStartDate.set($any($event.target).value)" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm">
                    <input type="date" [value]="completedOrdersEndDate()" (change)="completedOrdersEndDate.set($any($event.target).value)" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm">
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4">
                @if(isFetchingCompletedOrders()) {
                     <div class="flex items-center justify-center h-full"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div></div>
                } @else if (completedOrders().length === 0) {
                     <div class="flex flex-col items-center justify-center h-full text-gray-500">
                        <span class="material-symbols-outlined text-4xl mb-2 opacity-50">receipt_long</span>
                        <p>Nenhuma venda encontrada no período.</p>
                     </div>
                } @else {
                    <div class="space-y-3">
                        @for (order of completedOrders(); track order.id) {
                            <div class="bg-gray-700/30 border border-gray-700 p-4 rounded-xl flex flex-col sm:flex-row justify-between items-center gap-4 hover:bg-gray-700/50 transition-colors">
                                <div class="flex items-center gap-4 w-full sm:w-auto">
                                    <div class="w-12 h-12 rounded-full bg-gray-800 flex items-center justify-center text-gray-500 font-mono text-xs">
                                        {{ order.timestamp | date:'HH:mm' }}
                                    </div>
                                    <div>
                                        <p class="font-bold text-white">{{ getOrderOrigin(order) }}</p>
                                        <p class="text-xs text-gray-400 font-mono">#{{ order.id.slice(0, 8) }}</p>
                                        @if(order.customers) { <p class="text-xs text-blue-300">{{ order.customers.name }}</p> }
                                    </div>
                                </div>

                                <div class="flex items-center gap-4 w-full sm:w-auto justify-between sm:justify-end">
                                    <div class="text-right mr-4">
                                        <p class="font-bold text-green-400 text-lg">{{ getOrderTotal(order) | currency:'BRL' }}</p>
                                        @if(order.nfce_status === 'autorizado') {
                                            <span class="text-[10px] bg-green-900/50 text-green-300 px-2 py-0.5 rounded border border-green-800">NFC-e Emitida</span>
                                        }
                                    </div>
                                    <div class="flex gap-2">
                                         <button (click)="reprintReceipt(order)" class="p-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-white" title="Reimprimir">
                                            <span class="material-symbols-outlined text-base">print</span>
                                        </button>
                                        <button (click)="openDetailsModal(order)" class="p-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-white" title="Detalhes">
                                            <span class="material-symbols-outlined text-base">visibility</span>
                                        </button>
                                        @if(!order.nfce_status) {
                                            <button (click)="emitNfce(order)" [disabled]="processingNfceOrders().has(order.id)" class="p-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-white" title="Emitir NFC-e">
                                                @if(processingNfceOrders().has(order.id)) { <div class="animate-spin h-4 w-4 border-2 border-white rounded-full"></div> }
                                                @else { <span class="material-symbols-outlined text-base">receipt_long</span> }
                                            </button>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
          </div>
        }
      }
    }
  </div>

  <!-- Mobile Bottom Floating Navigation (Only on Mobile) -->
  <div class="md:hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 z-30 bg-gray-800/90 backdrop-blur-md border border-gray-700 p-1.5 rounded-full flex shadow-2xl">
      <button (click)="view.set('payingTables')" class="p-3 rounded-full transition-colors relative" [class.bg-blue-600]="view() === 'payingTables'" [class.text-white]="view() === 'payingTables'" [class.text-gray-400]="view() !== 'payingTables'">
         <span class="material-symbols-outlined text-xl">payments</span>
         @if(tablesForPayment().length > 0) { <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span> }
      </button>
      <button (click)="view.set('quickSale')" class="p-3 rounded-full transition-colors" [class.bg-blue-600]="view() === 'quickSale'" [class.text-white]="view() === 'quickSale'" [class.text-gray-400]="view() !== 'quickSale'">
         <span class="material-symbols-outlined text-xl">point_of_sale</span>
      </button>
      <button (click)="view.set('cashDrawer')" class="p-3 rounded-full transition-colors" [class.bg-blue-600]="view() === 'cashDrawer'" [class.text-white]="view() === 'cashDrawer'" [class.text-gray-400]="view() !== 'cashDrawer'">
         <span class="material-symbols-outlined text-xl">account_balance_wallet</span>
      </button>
       <button (click)="view.set('reprint')" class="p-3 rounded-full transition-colors" [class.bg-blue-600]="view() === 'reprint'" [class.text-white]="view() === 'reprint'" [class.text-gray-400]="view() !== 'reprint'">
         <span class="material-symbols-outlined text-xl">history</span>
      </button>
  </div>
</div>

<!-- Quick Sale Payment Modal (Custom for Cashier) -->
@if(isQuickSalePaymentModalOpen()) {
  <app-payment-modal
    [order]="processingQuickSaleOrder()"
    [table]="null"
    (closeModal)="closeQuickSalePaymentModal()"
    (paymentFinalized)="onQuickSalePaymentFinalized()">
  </app-payment-modal>
}

<!-- Standard Modals Reuse -->
@if(isTableOptionsModalOpen() && selectedTableForOptions(); as table) {
   <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" (click)="isTableOptionsModalOpen.set(false)">
     <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm shadow-2xl transform transition-all" (click)="$event.stopPropagation()">
        <h3 class="text-xl font-bold text-white mb-4 text-center">Mesa {{ table.number }}</h3>
        <div class="space-y-3">
            <button (click)="openPaymentForTable(table); isTableOptionsModalOpen.set(false)" class="w-full py-4 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold text-lg shadow-lg shadow-green-900/20 flex items-center justify-center gap-3">
                <span class="material-symbols-outlined">payments</span> Cobrar Conta
            </button>
            <button (click)="openPreBillForTable(table); isTableOptionsModalOpen.set(false)" class="w-full py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-xl font-semibold flex items-center justify-center gap-3">
                <span class="material-symbols-outlined">receipt</span> Pré-conta
            </button>
             <button (click)="reopenTable(table); isTableOptionsModalOpen.set(false)" class="w-full py-3 bg-yellow-600/20 hover:bg-yellow-600/30 text-yellow-400 border border-yellow-600/50 rounded-xl font-semibold flex items-center justify-center gap-3">
                <span class="material-symbols-outlined">lock_open</span> Reabrir Mesa
            </button>
        </div>
     </div>
   </div>
}

@if (isTablePaymentModalOpen()) {
  <app-payment-modal
    [order]="selectedOrderForPayment()"
    [table]="selectedTableForPayment()"
    (closeModal)="handlePaymentModalClosed($event)"
    (paymentFinalized)="handlePaymentFinalized()">
  </app-payment-modal>
}

@if (isPreBillModalOpen()) {
  <app-pre-bill-modal
    [order]="selectedOrderForPreBill()"
    [table]="selectedTableForPreBill()"
    (closeModal)="isPreBillModalOpen.set(false)">
  </app-pre-bill-modal>
}

<!-- Detailed Closing Modal -->
@if(isClosingModalOpen()) {
  <div class="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4" (click)="closeClosingModal()">
      <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden border border-gray-700" (click)="$event.stopPropagation()">
          <div class="bg-gray-900 p-4 border-b border-gray-800 flex justify-between items-center">
              <h3 class="text-lg font-bold text-white">Conferência de Caixa</h3>
              <button (click)="closeClosingModal()" class="text-gray-400 hover:text-white"><span class="material-symbols-outlined">close</span></button>
          </div>
          <div class="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
              <p class="text-sm text-gray-400 mb-4">Confira os valores de cada método de pagamento. A diferença será calculada automaticamente.</p>
              
              <div class="space-y-4">
                  @for(item of closingBreakdown(); track item.method; let i = $index) {
                      <div class="bg-gray-700/30 p-3 rounded-lg flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                          <div class="flex-1">
                              <p class="font-bold text-white">{{ item.method }}</p>
                              <p class="text-xs text-gray-400">Esperado: <span class="font-mono text-blue-300">{{ item.expected | currency:'BRL' }}</span></p>
                          </div>
                          
                          <div class="flex items-center gap-3">
                              <div class="relative">
                                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-bold text-xs">R$</span>
                                  <input type="number" 
                                         [value]="item.counted" 
                                         (input)="updateCountedValue(i, +$any($event.target).value)" 
                                         class="w-32 bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 pl-8 text-white font-mono text-right focus:outline-none focus:border-blue-500"
                                         placeholder="0.00">
                              </div>
                              <div class="w-24 text-right">
                                  <p class="text-xs text-gray-500">Diferença</p>
                                  <p class="font-bold font-mono" [class.text-green-400]="item.difference >= 0" [class.text-red-400]="item.difference < 0">
                                      {{ item.difference | currency:'BRL' }}
                                  </p>
                              </div>
                          </div>
                      </div>
                  }
              </div>

              <!-- Total Difference Summary -->
              <div class="mt-4 p-4 bg-gray-900 rounded-xl border border-gray-800 flex justify-between items-center">
                  <span class="text-gray-300 font-bold">Diferença Total (Quebra)</span>
                  <span class="text-xl font-bold" [class.text-green-400]="totalDifference() >= 0" [class.text-red-400]="totalDifference() < 0">
                      {{ totalDifference() | currency:'BRL' }}
                  </span>
              </div>

              <div>
                  <label class="block text-sm font-medium text-gray-400 mb-1">Observações do Fechamento</label>
                  <textarea [value]="closingNotes()" (input)="closingNotes.set($any($event.target).value)" rows="2" class="w-full bg-gray-700/50 border border-gray-600 rounded-xl p-3 text-white focus:outline-none focus:border-blue-500"></textarea>
              </div>
          </div>
          <div class="p-4 bg-gray-900 border-t border-gray-800 flex justify-end gap-3">
              <button (click)="closeClosingModal()" class="px-6 py-3 rounded-xl font-bold text-gray-400 hover:text-white hover:bg-gray-800 transition-colors">Cancelar</button>
              <button (click)="confirmAndCloseCashier()" class="px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold shadow-lg shadow-blue-900/30 transition-transform active:scale-95">
                  Confirmar e Fechar
              </button>
          </div>
      </div>
  </div>
}

@if (isDetailsModalOpen() && selectedOrderForDetails(); as order) {
  <!-- Detail modal reused structure with updated styling -->
  <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" (click)="closeDetailsModal()">
     <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col border border-gray-700" (click)="$event.stopPropagation()">
        <div class="p-4 border-b border-gray-700 flex justify-between items-center">
            <h3 class="text-lg font-bold text-white">Detalhes da Venda</h3>
            <button (click)="closeDetailsModal()" class="text-gray-400 hover:text-white"><span class="material-symbols-outlined">close</span></button>
        </div>
        <div class="p-6 overflow-y-auto space-y-4">
             <!-- ... existing detail content structure but with p-4 bg-gray-700/30 rounded-lg classes ... -->
             <div class="bg-gray-900/50 p-4 rounded-lg flex justify-between items-center">
                 <span class="text-gray-400">Total Pago</span>
                 <span class="text-xl font-bold text-green-400">{{ getOrderTotal(order) | currency:'BRL' }}</span>
             </div>
             <!-- ... items list ... -->
             <ul class="space-y-2">
                @for(item of order.order_items; track item.id) {
                    <li class="flex justify-between text-sm text-gray-300 border-b border-gray-700/50 pb-2">
                        <span>{{ item.quantity }}x {{ item.name }}</span>
                        <span>{{ (item.price * item.quantity) | currency:'BRL' }}</span>
                    </li>
                }
             </ul>
        </div>
     </div>
  </div>
}

@if (isCustomerSelectModalOpen()) {
  <app-customer-select-modal
    (closeModal)="isCustomerSelectModalOpen.set(false)"
    (customerSelected)="handleCustomerSelected($event)">
  </app-customer-select-modal>
}
