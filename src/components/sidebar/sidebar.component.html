
<aside class="w-64 bg-gray-900 border-r border-gray-800 text-gray-300 flex flex-col h-screen no-print transition-all duration-300" [class.w-20]="!isSidebarOpen()" [class.w-64]="isSidebarOpen()">
  <!-- Header / Toggle -->
  <div class="h-16 flex items-center justify-between px-4 border-b border-gray-800 flex-shrink-0">
    @if(isSidebarOpen()) {
        <span class="text-2xl font-extrabold text-white">Chef<span class="text-blue-500">OS</span></span>
    }
    <button (click)="toggleSidebar()" class="p-1 rounded-md hover:bg-gray-800 text-gray-400">
      <span class="material-symbols-outlined">{{ isSidebarOpen() ? 'menu_open' : 'menu' }}</span>
    </button>
  </div>

  <!-- Store Switcher (Custom Dropdown) -->
  @if(isSidebarOpen()) {
    <div class="px-4 py-3 border-b border-gray-800 relative">
        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Loja Ativa</label>
        
        <button (click)="toggleStoreDropdown()" class="w-full bg-gray-800 hover:bg-gray-700 text-white text-sm rounded-md border border-gray-700 py-2 px-3 flex justify-between items-center transition-colors">
            <span class="truncate">{{ unitContextService.activeUnitName() }}</span>
            <span class="material-symbols-outlined text-sm text-gray-400 transition-transform duration-200" [class.rotate-180]="isStoreDropdownOpen()">expand_more</span>
        </button>

        <!-- Dropdown Menu -->
        @if(isStoreDropdownOpen()) {
            <div class="absolute left-4 right-4 top-full mt-1 bg-gray-800 border border-gray-700 rounded-md shadow-xl z-50 overflow-hidden">
                <ul class="max-h-48 overflow-y-auto">
                    @for(unit of unitContextService.availableUnits(); track unit.id) {
                        <li>
                            <button (click)="switchStore(unit.id)" class="w-full text-left px-3 py-2 text-sm hover:bg-gray-700 flex items-center justify-between group">
                                <span [class.text-blue-400]="unitContextService.activeUnitId() === unit.id" [class.font-bold]="unitContextService.activeUnitId() === unit.id">{{ unit.name }}</span>
                                @if(unitContextService.activeUnitId() === unit.id) {
                                    <span class="material-symbols-outlined text-blue-400 text-xs">check</span>
                                }
                            </button>
                        </li>
                    }
                </ul>
                <div class="border-t border-gray-700 p-2 bg-gray-900/50">
                    <button (click)="openAddStoreModal()" class="w-full flex items-center justify-center gap-2 text-xs font-semibold text-blue-400 hover:text-blue-300 py-1 rounded hover:bg-gray-800 transition-colors">
                        <span class="material-symbols-outlined text-sm">add_business</span>
                        Adicionar / Vincular Loja
                    </button>
                </div>
            </div>
            <!-- Overlay to close dropdown -->
            <div class="fixed inset-0 z-40" (click)="isStoreDropdownOpen.set(false)"></div>
        }
    </div>
  }

  <!-- Navigation -->
  <nav class="flex-1 overflow-y-auto py-4 space-y-1">
    @for (item of navItems(); track item.name) {
      @if (isNavGroup(item)) {
        <div class="relative">
            <!-- Group Header -->
            <button 
                (click)="toggleGroup(item.name)" 
                class="w-full flex items-center justify-between px-4 py-2 text-sm font-medium transition-colors duration-200"
                [class.text-white]="expandedGroups()[item.name]"
                [class.text-gray-400]="!expandedGroups()[item.name]"
                [class.justify-center]="!isSidebarOpen()"
                [title]="!isSidebarOpen() ? item.name : ''">
                
                <div class="flex items-center gap-3">
                    @if (item.imageUrl) {
                        <img [src]="item.imageUrl" [alt]="item.name" class="h-5 w-5 object-contain opacity-70">
                    } @else if (item.icon) {
                         <!-- Render path based icon or simple icon -->
                         @if(item.icon.startsWith('M')) {
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" [attr.d]="item.icon"></path></svg>
                         } @else {
                             <span class="material-symbols-outlined text-xl">{{ item.icon }}</span>
                         }
                    }
                    @if(isSidebarOpen()) {
                        <span>{{ item.name }}</span>
                    }
                </div>
                
                @if(isSidebarOpen()) {
                    <span class="material-symbols-outlined text-sm transition-transform duration-200" [class.rotate-90]="expandedGroups()[item.name]">chevron_right</span>
                }
            </button>
            
            <!-- Group Children -->
            @if(expandedGroups()[item.name] && isSidebarOpen()) {
                <div class="mt-1 space-y-1 bg-gray-800/30">
                    @for (child of item.children; track child.path) {
                        <a [routerLink]="child.path" routerLinkActive="bg-blue-600 text-white" class="group flex items-center pl-11 pr-2 py-2 text-sm font-medium text-gray-400 rounded-md hover:text-white hover:bg-gray-800 transition-colors">
                            @if(child.icon && child.icon.startsWith('M')) {
                                <svg class="w-4 h-4 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" [attr.d]="child.icon"></path></svg>
                            } @else if (child.icon) {
                                <span class="material-symbols-outlined text-lg mr-3">{{ child.icon }}</span>
                            }
                            {{ child.name }}
                        </a>
                    }
                </div>
            }
        </div>
      } @else {
        <!-- Single Link -->
        <a [routerLink]="item.path" routerLinkActive="bg-blue-600 text-white" class="group flex items-center px-4 py-2 text-sm font-medium text-gray-300 rounded-md hover:bg-gray-800 hover:text-white transition-colors" [class.justify-center]="!isSidebarOpen()" [title]="!isSidebarOpen() ? item.name : ''">
             @if (item.imageUrl) {
                <img [src]="item.imageUrl" [alt]="item.name" class="h-5 w-5 object-contain mr-3">
             } @else if (item.icon && item.icon.startsWith('M')) {
                <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" [attr.d]="item.icon"></path></svg>
             } @else if (item.icon) {
                 <span class="material-symbols-outlined text-xl mr-3">{{ item.icon }}</span>
             }
             
             @if(isSidebarOpen()) {
                <span>{{ item.name }}</span>
             }
        </a>
      }
    }
  </nav>

  <!-- User Footer -->
  <div class="border-t border-gray-800 p-4 bg-gray-900">
    <div class="flex items-center gap-3">
       @if (activeEmployee()?.photo_url; as photoUrl) {
          <img [src]="photoUrl" alt="Avatar" class="w-9 h-9 rounded-full object-cover border border-gray-600">
       } @else {
          <div class="w-9 h-9 rounded-full bg-gray-700 flex items-center justify-center text-gray-400">
            <span class="material-symbols-outlined">person</span>
          </div>
       }
       
       @if(isSidebarOpen()) {
           <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-white truncate">{{ activeEmployee()?.name }}</p>
              <p class="text-xs text-gray-500 truncate">{{ activeEmployee()?.role }}</p>
           </div>
       }
    </div>
    
    @if(isSidebarOpen()) {
        <div class="mt-4 space-y-2">
            <button (click)="handleShiftAction()" class="w-full py-1.5 px-2 rounded text-xs font-semibold border transition-colors" [class]="shiftButtonState().className" [disabled]="shiftButtonState().disabled">
                {{ shiftButtonState().text }}
            </button>
            <div class="grid grid-cols-2 gap-2">
                <button (click)="switchEmployee()" class="py-1.5 px-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded text-xs transition-colors">Trocar</button>
                <button (click)="signOut()" class="py-1.5 px-2 bg-red-900/30 hover:bg-red-900/50 text-red-400 rounded text-xs transition-colors">Sair</button>
            </div>
        </div>
    }
  </div>
</aside>

@if (isAddStoreModalOpen()) {
    <app-add-store-modal (closeModal)="isAddStoreModalOpen.set(false)"></app-add-store-modal>
}
